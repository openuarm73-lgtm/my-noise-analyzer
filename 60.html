<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì†Œë¦¬ ë¶„ì„ê¸° â€” 7Ã—/14Ã— ìë™íŒì • í¬í•¨</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:linear-gradient(135deg,#2b6cb0,#805ad5);color:#222;min-height:100vh;padding:18px}
  /* 1. ì „ì²´ ì»¨í…Œì´ë„ˆ í­ í™•ì¥ (1100px -> 1400px) */
  .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.18)}
  h1{font-size:1.2rem;text-align:center;margin-bottom:12px}
  /* 2. ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë¹„ìœ¨ ì¡°ì • (1fr 440px -> 1fr 700px) */
  .grid{display:grid;grid-template-columns:1fr 700px;gap:14px;align-items:start}
  .panel{background:#fbfbff;padding:12px;border-radius:10px}
  label{display:block;margin-top:8px;font-weight:600;margin-bottom:6px}
  input[type=number], select, input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:0.95rem}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button{padding:9px 12px;border-radius:8px;border:none;font-weight:700;color:#fff;cursor:pointer}
  #connectBtn{background:#38a169} #startButton{background:#3182ce} #stopButton{background:#e53e3e}
  .status{margin-top:10px;padding:10px;border-radius:8px;font-size:0.9rem}
  .status.success{background:#e6fffa;color:#22543d}
  .status.error{background:#fff5f5;color:#822727}
  .status.info{background:#fffff0;color:#735c0f}
  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .kpi-item{background:#fff;padding:8px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.06);min-width:120px}
  .small{font-size:0.85rem;color:#444}
  canvas{width:100%;height:240px;background:#041023;border-radius:6px;display:block}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid #eee;text-align:left;font-size:0.9rem}
  /* 4. dB ì—´ ë„ˆë¹„ ê³ ì •: ê¸´ í…ìŠ¤íŠ¸ë¡œ ì¸í•œ ë°€ë¦¼ ë°©ì§€ */
  #harmonicsTable th:last-child, 
  #harmonicsTable td:last-child {
    width: 80px; 
    min-width: 80px;
    text-align: right;
  }
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;color:#fff;font-size:0.85rem}
  .ok{background:#38a169} .warn{background:#dd6b20} .bad{background:#e53e3e}
  .tooltip{position:absolute;padding:6px 8px;background:rgba(0,0,0,0.85);color:#fff;border-radius:6px;font-size:0.85rem;pointer-events:none;transform:translate(-50%,-120%);white-space:nowrap;z-index:10}
  .muted{color:#666;font-size:0.9rem}
  /* 3. AI Note ì˜ì—­ ìµœì†Œ ë†’ì´ ì§€ì •: í…ìŠ¤íŠ¸ ìœ ë¬´ì— ë”°ë¥¸ í”„ë ˆì„ í”ë“¤ë¦¼ ë°©ì§€ */
  #aiNote { min-height: 20px; }
  @media(max-width:1000px){.grid{grid-template-columns:1fr;}.panel{margin-bottom:12px}}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ”Š ì†Œë¦¬ ë¶„ì„ê¸° â€” ìë™ 14Ã— íŒì • í¬í•¨</h1>

  <div class="grid">
    <div class="panel">
      <label>í˜„ì¬ RPM</label>
      <input type="number" id="rpmInput" value="1500" min="1">

      <label>ê¸°ë³¸ ì£¼íŒŒìˆ˜ ë°°ìˆ˜ (ë¸”ë ˆì´ë“œ ìˆ˜)</label>
      <input type="number" id="bladeCountInput" value="20" min="1">

      <label>ë¶„ì„ ë°°ìˆ˜ ë²”ìœ„</label>
      <select id="multipleSelect">
        <option value="7" selected>1Ã— ~ 7Ã— (ê¸°ë³¸)</option>
        <option value="14">1Ã— ~ 14Ã— (í™•ì¥ â€” 14Ã— íŒì • í¬í•¨)</option>
      </select>

      <div class="small" style="margin-top:6px">ê²°í•¨ì£¼íŒŒìˆ˜ëŠ” ê¸°ë³¸ì£¼íŒŒìˆ˜ì˜ <b>7Ã—</b>ë¡œ ê³ ì •ë©ë‹ˆë‹¤. (í‘œ/íŒì •ì€ ì„ íƒí•œ ë°°ìˆ˜ ë²”ìœ„ê¹Œì§€ ê³„ì‚°)</div>

      <label>FFT í¬ê¸°</label>
      <select id="fftSizeSelect">
        <option value="2048">2048</option>
        <option value="4096" selected>4096</option>
        <option value="8192">8192</option>
      </select>

      <div class="btns">
        <button id="connectBtn">ğŸ¤ ë§ˆì´í¬ ì—°ê²°</button>
        <button id="startButton" disabled>ğŸ“Š ë¶„ì„ ì‹œì‘</button>
        <button id="stopButton" disabled>â¹ ë¶„ì„ ì¤‘ì§€</button>
      </div>

      <div id="status" class="status info">ë§ˆì´í¬ ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>ì´ë™í‰ê·  ê¸¸ì´ (í”„ë ˆì„)</label>
          <input type="number" id="maLen" value="10" min="1">
        </div>
        <div style="width:140px">
          <label>ê²½ë³´ìŒ</label>
          <select id="alarmMode"><option value="off" selected>ë„ê¸°</option><option value="beep">ë¹„í”„ìŒ</option></select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>AI íŒì • ì„ê³„ê°’ (dB)</label>
          <div style="display:flex;gap:6px">
            <input type="number" id="warnThreshold" value="3" min="0" step="0.1">
            <input type="number" id="badThreshold" value="8" min="0" step="0.1">
          </div>
          <div class="small">diff(dB) &gt; ì£¼ì˜ &gt; ê²°í•¨ (ê°’ ë³€ê²½ ê°€ëŠ¥)</div>
        </div>
        <div style="width:160px">
          <label>RPM íŠ¸ë Œë“œ ê°ì§€ (ë¯¼ê°ë„)</label>
          <select id="rpmTrendSens">
            <option value="0.01">ë¯¼ê°(1%)</option>
            <option value="0.03" selected>ë³´í†µ(3%)</option>
            <option value="0.1">ì™„ë§Œ(10%)</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>ë¡œê·¸ ìˆ˜ì§‘</label>
          <div style="display:flex;gap:6px">
            <button id="toggleLogBtn" style="background:#718096">ìˆ˜ì§‘ ì‹œì‘</button>
            <button id="downloadCsvBtn" style="background:#2b6cb0">CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
        <div style="width:160px">
          <label>ê¸°íƒ€</label>
          <button id="resetPrevBtn" style="background:#6b7280">ì´ì „ê°’ ë¦¬ì…‹</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="kpi-item"><div class="small">ë¶„ì„ì‹œê°„</div><div id="timeCounter" style="font-weight:700">0 s</div></div>
        <div class="kpi-item"><div class="small">ì´ë™í‰ê·  (dB)</div><div id="movingAvg" style="font-weight:700">-</div></div>
        <div class="kpi-item"><div class="small">ì „ì²´ RMS (dB)</div><div id="rmsVal" style="font-weight:700">-</div></div>
        <div class="kpi-item"><div class="small">Peak (dB)</div><div id="peakVal" style="font-weight:700">-</div></div>
      </div>

      <div style="margin-top:12px" class="panel">
        <div class="small">ê¸°ë³¸ / ê²°í•¨(7Ã—)</div>
        <div id="freqResult" style="margin-top:6px;font-weight:700">-</div>

        <div class="small" style="margin-top:10px">ê³ ì¡°íŒŒ (ì„ íƒí•œ ë°°ìˆ˜ ë²”ìœ„)</div>
        <table id="harmonicsTable"><thead><tr><th>ë°°ìˆ˜</th><th>ì£¼íŒŒìˆ˜(Hz)</th><th>ì§„í­</th><th>dB</th></tr></thead><tbody></tbody></table>

        <div style="margin-top:8px">
          <div class="small">AI ìƒíƒœíŒì •</div>
          <div id="aiState" style="margin-top:6px"><span class="badge ok">-</span></div>
          <div id="aiNote" style="margin-top:6px;color:#444"></div>
        </div>

      </div>

    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">ì‹¤ì‹œê°„ ìŠ¤í™íŠ¸ëŸ¼ (ë§ˆìš°ìŠ¤ ì˜¤ë²„: ì£¼íŒŒìˆ˜/ì§„í­)</div>
        <div class="small muted">ìƒ˜í”Œë ˆì´íŠ¸: <span id="sr">-</span> / FFT: <span id="fftInfo">-</span></div>
      </div>
      <div style="position:relative;margin-top:8px">
        <canvas id="spectrumCanvas" width="780" height="260"></canvas>
        <div id="tooltip" class="tooltip" style="display:none"></div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="kpi-item"><div class="small">ì²¨ë„ (Kurtosis)</div><div id="kurtVal" style="font-weight:700">-</div></div>
        <div class="kpi-item"><div class="small">íŒŒê³ ìœ¨ (Crest)</div><div id="crestVal" style="font-weight:700">-</div></div>
        <div class="kpi-item"><div class="small">ë¹ˆë‹¹ ì£¼íŒŒìˆ˜</div><div id="freqPerBin" style="font-weight:700">-</div></div>
      </div>

      <div class="small muted" style="margin-top:10px">íŒ: ë¸Œë¼ìš°ì €ê°€ ë§ˆì´í¬ ê¶Œí•œì„ ìš”êµ¬í•˜ë©´ 'í—ˆìš©'í•˜ì„¸ìš”. ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì‹œ `http://localhost:8000/20.html`ë¡œ ì—´ë©´ ì•ˆì •ì ì…ë‹ˆë‹¤.</div>
    </div>

  </div>
</div>

<script>
/* ---------------- ë³€ìˆ˜ ì„ ì–¸ ---------------- */
let audioContext=null, analyser=null, micSource=null, freqData=null, timeData=null;
let isAnalyzing=false, rafId=null, startTime=null;
let dbHistory=[], logRecords=[], logging=false;

/* ì´ì „ í”„ë ˆì„ ê°’ ì¶”ì  (íŒì •ìš©) */
let prevDefectAmp = null, prevH14dB = null, prevRmsDb = null, prevRpm = null;

/* UI ìš”ì†Œ */
const connectBtn = document.getElementById('connectBtn');
const startBtn = document.getElementById('startButton');
const stopBtn = document.getElementById('stopButton');
const statusDiv = document.getElementById('status');
const rpmInput = document.getElementById('rpmInput');
const bladeInput = document.getElementById('bladeCountInput');
const multipleSelect = document.getElementById('multipleSelect');
const fftSizeSelect = document.getElementById('fftSizeSelect');
const maLenInput = document.getElementById('maLen');
const warnThresholdInput = document.getElementById('warnThreshold');
const badThresholdInput = document.getElementById('badThreshold');
const rpmTrendSens = document.getElementById('rpmTrendSens');
const toggleLogBtn = document.getElementById('toggleLogBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const resetPrevBtn = document.getElementById('resetPrevBtn');
const alarmMode = document.getElementById('alarmMode');

const timeCounter = document.getElementById('timeCounter');
const movingAvg = document.getElementById('movingAvg');
const rmsVal = document.getElementById('rmsVal');
const peakVal = document.getElementById('peakVal');
const kurtVal = document.getElementById('kurtVal');
const crestVal = document.getElementById('crestVal');
const freqResult = document.getElementById('freqResult');
const harmonicsTableBody = document.querySelector('#harmonicsTable tbody');
const aiState = document.getElementById('aiState');
const aiNote = document.getElementById('aiNote');
const srText = document.getElementById('sr');
const fftInfo = document.getElementById('fftInfo');
const freqPerBinText = document.getElementById('freqPerBin');

const canvas = document.getElementById('spectrumCanvas');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

let alarmOsc = null;

/* ---------------- ìœ í‹¸ í•¨ìˆ˜ ---------------- */
function ampToDb(amp){
  const ref = 255;
  // ì§„í­ì´ 0ì¼ ë•Œ -128.13 dBë¥¼ ì¶œë ¥í•˜ëŠ” ë¡œì§ ìœ ì§€
  const a = Math.max(amp, 0.0001); 
  return 20 * Math.log10(a / ref);
}
function toNormalizedTimeArray(u8){
  const out = new Float32Array(u8.length);
  for(let i=0;i<u8.length;i++) out[i] = (u8[i] - 128) / 128;
  return out;
}
function calcRMS(arr){ let s=0; for(let i=0;i<arr.length;i++) s+=arr[i]*arr[i]; return Math.sqrt(s/arr.length); }
function calcKurtosisFromFloat(arr){
  const n=arr.length; if(n===0) return 0;
  let mean=0; for(let i=0;i<n;i++) mean+=arr[i]; mean/=n;
  let m2=0,m4=0; for(let i=0;i<n;i++){ const d=arr[i]-mean; m2+=d*d; m4+=d*d*d*d; }
  m2/=n; m4/=n; if(m2===0) return 0; return m4/(m2*m2);
}
function calcCrest(arr){ let peak=0; for(let i=0;i<arr.length;i++) peak=Math.max(peak,Math.abs(arr[i])); const rms=calcRMS(arr); return rms===0?0:(peak/rms); }
function nowISO(){ return (new Date()).toISOString(); }

/* ---------------- ë§ˆì´í¬ ì—°ê²° ---------------- */
connectBtn.addEventListener('click', async () => {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = Number(fftSizeSelect.value) || 4096;
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);

    micSource = audioContext.createMediaStreamSource(stream);
    micSource.connect(analyser);

    connectBtn.disabled = true; connectBtn.style.background='#999'; connectBtn.textContent='ğŸ¤ ì—°ê²°ë¨';
    startBtn.disabled = false;
    statusDiv.textContent = 'ë§ˆì´í¬ ì—°ê²° ì„±ê³µ'; statusDiv.className='status success';

    srText.textContent = audioContext.sampleRate.toFixed(0) + ' Hz';
    fftInfo.textContent = analyser.fftSize;
    freqPerBinText.textContent = (audioContext.sampleRate / analyser.fftSize).toFixed(3) + ' Hz';
  }catch(err){
    statusDiv.textContent = 'ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨: ' + (err.message || err); statusDiv.className='status error';
  }
});

/* ---------------- ì‹œì‘/ì¤‘ì§€ ---------------- */
startBtn.addEventListener('click', () => {
  if(!analyser || !audioContext){ statusDiv.textContent='ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'; statusDiv.className='status error'; return; }
  const newFft = Number(fftSizeSelect.value) || 4096;
  if(newFft !== analyser.fftSize){
    analyser.fftSize = newFft;
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);
    fftInfo.textContent = analyser.fftSize;
    freqPerBinText.textContent = (audioContext.sampleRate / analyser.fftSize).toFixed(3) + ' Hz';
  }
  isAnalyzing = true; startBtn.disabled = true; stopBtn.disabled = false;
  statusDiv.textContent = 'ë¶„ì„ ì¤‘...'; statusDiv.className='status info';
  startTime = performance.now(); dbHistory=[]; if(logging) logRecords=[];
  analyzeLoop();
});

stopBtn.addEventListener('click', () => {
  isAnalyzing = false; startBtn.disabled = false; stopBtn.disabled = true;
  statusDiv.textContent = 'ì¤‘ì§€ë¨'; statusDiv.className='status';
  if(rafId) cancelAnimationFrame(rafId); stopAlarm();
});

/* --------------- ë¡œê·¸ ì²˜ë¦¬ ---------------- */
toggleLogBtn.addEventListener('click', () => {
  logging = !logging; toggleLogBtn.textContent = logging ? 'ìˆ˜ì§‘ ì¤‘' : 'ìˆ˜ì§‘ ì‹œì‘';
  toggleLogBtn.style.background = logging ? '#c53030' : '#718096';
  if(logging) logRecords = [];
});
downloadCsvBtn.addEventListener('click', () => {
  if(logRecords.length === 0){ alert('ì €ì¥í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const header = ['timestamp_s','iso','rpm','baseFreq_Hz','defectFreq_Hz','baseAmp','baseDb','defectAmp','defectDb','diffDb','aiLabel','aiNote','rmsDb','peakDb','kurtosis','crest'];
  const rows = logRecords.map(r => header.map(h => r[h]));
  const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = 'sound_log_'+(new Date()).toISOString().replace(/[:.]/g,'-')+'.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
resetPrevBtn.addEventListener('click', () => { prevDefectAmp = prevH14dB = prevRmsDb = prevRpm = null; aiNote.textContent = 'ì´ì „ê°’ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.'; });

/* ---------------- ì•ŒëŒ ---------------- */
function playAlarm(){
  if(alarmMode.value === 'off' || !audioContext) return;
  if(alarmOsc) return;
  alarmOsc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  gain.gain.value = 0.001;
  alarmOsc.type = 'sine'; alarmOsc.frequency.value = 880;
  alarmOsc.connect(gain); gain.connect(audioContext.destination);
  alarmOsc.start();
  gain.gain.exponentialRampToValueAtTime(0.12, audioContext.currentTime + 0.02);
  setTimeout(()=>{ if(alarmOsc){ gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15); setTimeout(()=>{ try{ alarmOsc.stop(); alarmOsc.disconnect(); }catch(e){} alarmOsc=null; }, 200); } }, 200);
}
function stopAlarm(){ if(alarmOsc){ try{ alarmOsc.stop(); alarmOsc.disconnect(); }catch(e){} alarmOsc=null; } }

/* ---------------- ë©”ì¸ ë¶„ì„ ë£¨í”„ (íŒì • ë¡œì§ í¬í•¨) ---------------- */
function analyzeLoop(){
  if(!isAnalyzing) return;
  analyser.getByteFrequencyData(freqData);
  analyser.getByteTimeDomainData(timeData);

  const sr = audioContext.sampleRate;
  const fftN = analyser.fftSize;
  const freqPerBin = sr / fftN;

  const rpm = Number(rpmInput.value) || 0;
  const blade = Number(bladeInput.value) || 1;
  const maxMultiple = Number(multipleSelect.value) || 7;

  const baseFreq = (rpm / 60) * blade;
  const defectFreq = baseFreq * 7;

  const baseIdx = Math.round(baseFreq / freqPerBin);
  const defectIdx = Math.round(defectFreq / freqPerBin);
  const safeIdx = i => Math.max(0, Math.min(freqData.length-1, i));

  const baseAmp = freqData[safeIdx(baseIdx)] || 0;
  const defectAmp = freqData[safeIdx(defectIdx)] || 0;
  const baseDb = ampToDb(baseAmp);
  const defectDb = ampToDb(defectAmp);
  const diffDb = Math.abs(defectDb - baseDb);

  // ì´ë™í‰ê· 
  const maLen = Number(maLenInput.value) || 10;
  dbHistory.push(diffDb); if(dbHistory.length > maLen) dbHistory.shift();
  const avgDB = dbHistory.reduce((a,b)=>a+b,0) / (dbHistory.length || 1);

  // ì‹œê°„ì˜ì—­ í†µê³„
  const tFloat = toNormalizedTimeArray(timeData);
  const rms = calcRMS(tFloat);
  const peak = Math.max(...tFloat.map(v => Math.abs(v)));
  const rmsDb = 20 * Math.log10(rms || 0.000001);
  const peakDb = 20 * Math.log10(peak || 0.000001);
  const kurt = calcKurtosisFromFloat(tFloat);
  const crest = calcCrest(tFloat);

  // ê³ ì¡°íŒŒ up to maxMultiple
  const harmonics = [];
  for(let k=1;k<=maxMultiple;k++){
    const hkFreq = baseFreq * k;
    const hkIdx = Math.round(hkFreq / freqPerBin);
    const amp = freqData[safeIdx(hkIdx)] || 0;
    harmonics.push({k,freq:hkFreq,amp,db:ampToDb(amp)});
  }

  // 14ë°° ê´€ë ¨ ê°’ (if available)
  const h14 = harmonics.find(h=>h.k===14) || null;
  const h14db = h14 ? h14.db : null;

  // íŒì •: ì‚¬ìš©ì ì„ê³„ê°’
  const warnTh = Number(warnThresholdInput.value) || 3;
  const badTh = Number(badThresholdInput.value) || 8;

  // RPM íŠ¸ë Œë“œ ê°ì§€
  let rpmNote = '';
  if(prevRpm !== null){
    const sens = Number(rpmTrendSens.value) || 0.03;
    const rpmChange = (rpm - prevRpm) / (prevRpm || 1);
    if(Math.abs(rpmChange) > sens){
      // rpm increased or decreased significantly
      if(rpmChange > 0){
        // rpm ì¦ê°€
        if(rmsDbIncreased(rmsDb, prevRmsDb)) rpmNote = 'RPM ì¦ê°€ â†’ RMS ì¦ê°€ (ì˜ˆìƒë˜ëŠ” ë™ì‘)';
        else rpmNote = 'RPM ì¦ê°€í•˜ì§€ë§Œ RMS ê°ì†Œ (ë¹„ì •ìƒ ë°˜ì‘ â€” ì ê²€ ê¶Œê³ )';
      } else {
        // rpm ê°ì†Œ
        if(rmsDbIncreased(prevRmsDb, rmsDb)) rpmNote = 'RPM ê°ì†Œ â†’ RMS ê°ì†Œ (ì˜ˆìƒë˜ëŠ” ë™ì‘)';
        else rpmNote = 'RPM ê°ì†Œí•˜ì§€ë§Œ RMS ì¦ê°€ (ë¹„ì •ìƒ ë°˜ì‘ â€” ì ê²€ ê¶Œê³ )';
      }
    }
  }

  // 14ë°° ìë™ íŒì • ê·œì¹™
  let aiLabel = 'ì •ìƒ', aiClass = 'ok', aiNoteText = '';
  // ê¸°ë³¸ diff ê¸°ë°˜
  if(diffDb > badTh){ aiLabel='ê²°í•¨ ì˜ì‹¬'; aiClass='bad'; aiNoteText = `dB ì°¨ì´(${diffDb.toFixed(2)}) > ${badTh}`; }
  else if(diffDb > warnTh){ aiLabel='ì£¼ì˜'; aiClass='warn'; aiNoteText = `dB ì°¨ì´(${diffDb.toFixed(2)}) > ${warnTh}`; }

  // 14ë°° íŠ¹ì´ ê²€ì‚¬ (ì„ íƒ ë²”ìœ„ê°€ 14 ì´ìƒì¼ ë•Œë§Œ)
  if(maxMultiple >= 14 && h14){
    const ratio14_7 = defectAmp > 0 ? (h14.amp / (defectAmp || 0.0001)) : 0;
    // ì¡°ê±´ A: defect(7x)ê°€ ì´ì „ë³´ë‹¤ ìœ ì˜í•˜ê²Œ ê°ì†Œí–ˆê³  ratio < 2 â†’ ì••ë ¥ê°ì†Œ íŒ¨í„´ (ì •ìƒ)
    if(prevDefectAmp !== null && defectAmp < prevDefectAmp - 4 && ratio14_7 < 2.0){
      aiLabel = 'ì •ìƒ (ì••ë ¥ê°ì†Œ íŒ¨í„´)';
      aiClass = 'ok';
      aiNoteText = '7Ã— ê°ì†Œ & 14/7 ë¹„ìœ¨ ë‚®ìŒ â†’ ì••ë ¥/ì¡°ê±´ ë³€í™”ë¡œ ì¸í•œ ì •ìƒ íŒ¨í„´';
    }
    // ì¡°ê±´ B: 14Ã— ì ˆëŒ€ì  ê¸‰ì¦ (dB)
    if(prevH14dB !== null && (h14.db - prevHH14dB) > 6){
      aiLabel = 'ê²°í•¨ ì˜ì‹¬ (14Ã— ê¸‰ì¦)';
      aiClass = 'bad';
      aiNoteText = `14Ã— dB ì¦ê°€: ${ (h14.db - prevH14dB).toFixed(2) } dB`;
    }
    // ì¡°ê±´ C: ratio(14/7) ë§¤ìš° í¼ -> ë¹„ì •ìƒ
    if(ratio14_7 > 3.0){
      aiLabel = 'ë¹„ì •ìƒ (14Ã— ê³¼ë‹¤)';
      aiClass = 'bad';
      aiNoteText = `14/7 ë¹„ìœ¨: ${ratio14_7.toFixed(2)}`;
    }
  }

  // RPM íŠ¸ë Œë“œ ê´€ë ¨ ë¹„ì •ìƒ ë°˜ì‘ ìš°ì„  í‘œê¸°
  if(rpmNote && rpmNote.includes('ë¹„ì •ìƒ')){
    aiLabel = 'ì ê²€ ê¶Œê³  (RPM-ì§„í­ ë¶ˆì¼ì¹˜)';
    aiClass = 'warn';
    aiNoteText = rpmNote;
  }
  
  // AI NoteTextê°€ ë¹„ì–´ìˆë‹¤ë©´ ë ˆì´ì•„ì›ƒ í”ë“¤ë¦¼ ë°©ì§€ìš© ê³µë°± ì‚½ì…
  if(aiNoteText === '') {
      aiNoteText = '\u00a0'; // non-breaking space
  }


  // ì•ŒëŒ
  if(aiLabel.includes('ê²°í•¨') && alarmMode.value !== 'off') playAlarm();

  // UI ì—…ë°ì´íŠ¸
  const elapsed = Math.floor((performance.now() - (startTime||performance.now()))/1000);
  timeCounter.textContent = `${elapsed} s`;
  movingAvg.textContent = `${avgDB.toFixed(2)} dB`;
  freqResult.innerHTML =
    `ê¸°ë³¸ì£¼íŒŒìˆ˜: ${Math.round(baseFreq)} Hz â€” ì§„í­: <b>${baseAmp}</b> (${baseDb.toFixed(2)} dB)<br>` +
    `ê²°í•¨ì£¼íŒŒìˆ˜(7Ã—): ${Math.round(defectFreq)} Hz â€” ì§„í­: <b>${defectAmp}</b> (${defectDb.toFixed(2)} dB)<br>` +
    `<span class="small">ì ˆëŒ€ dB ì°¨ì´: <b>${diffDb.toFixed(2)} dB</b></span>`;

  // ê³ ì¡°íŒŒ í‘œ
  harmonicsTableBody.innerHTML = '';
  harmonics.forEach(h => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${h.k}Ã—</td><td>${Math.round(h.freq)} Hz</td><td>${h.amp}</td><td>${h.db.toFixed(2)} dB</td>`;
    harmonicsTableBody.appendChild(tr);
  });

  // AI ìƒíƒœ í‘œì‹œ
  aiState.innerHTML = `<span class="badge ${aiClass}">${aiLabel}</span>`;
  // 3. AI Note ì˜ì—­ ê³ ì • (CSSì—ì„œ min-heightë¡œ ì²˜ë¦¬í•˜ê³ , JSì—ì„œëŠ” ê³µë°±ì„ ì‚½ì…í•˜ì—¬ ì²˜ë¦¬)
  aiNote.textContent = aiNoteText; 

  // í†µê³„ UI
  rmsVal.textContent = `${rmsDb.toFixed(2)} dB`;
  peakVal.textContent = `${peakDb.toFixed(2)} dB`;
  kurtVal.textContent = kurt.toFixed(2);
  crestVal.textContent = crest.toFixed(2);
  srText.textContent = sr.toFixed(0) + ' Hz';
  fftInfo.textContent = fftN;
  freqPerBinText.textContent = freqPerBin.toFixed(3) + ' Hz';

  // ë¡œê·¸ ì¶”ê°€
  if(logging){
    logRecords.push({
      timestamp_s: elapsed,
      iso: nowISO(),
      rpm: rpm,
      baseFreq_Hz: Math.round(baseFreq),
      defectFreq_Hz: Math.round(defectFreq),
      baseAmp: baseAmp,
      baseDb: baseDb.toFixed(3),
      defectAmp: defectAmp,
      defectDb: defectDb.toFixed(3),
      diffDb: diffDb.toFixed(3),
      aiLabel: aiLabel,
      aiNote: aiNoteText.trim(), // ë¡œê·¸ì— ê³µë°± ë¬¸ìì—´ì€ ì œì™¸
      rmsDb: rmsDb.toFixed(3),
      peakDb: peakDb.toFixed(3),
      kurtosis: kurt.toFixed(3),
      crest: crest.toFixed(3)
    });
  }

  // ìŠ¤í™íŠ¸ëŸ¼ ê·¸ë¦¬ê¸°
  drawSpectrum(freqData, baseFreq, defectFreq, harmonics);

  // prev ì—…ë°ì´íŠ¸
  prevDefectAmp = defectAmp;
  prevH14dB = h14db;
  prevRmsDb = rmsDb;
  prevRpm = rpm;

  rafId = requestAnimationFrame(analyzeLoop);
}

/* helper: rmsDb ì¦ê°€ ë¹„êµ (í—ˆìš© ì†Œìˆ˜ì ) */
function rmsDbIncreased(a,b){
  if(a === undefined || b === undefined || a === null || b === null) return null;
  return (a - b) > 0.5; // 0.5 dB ë³€í™”ë©´ ìœ ì˜ë¯¸
}

/* ---------------- ìŠ¤í™íŠ¸ëŸ¼ & ë§ˆìš°ìŠ¤ì˜¤ë²„ ---------------- */
function drawSpectrum(freqArray, baseFreq, defectFreq, harmonics){
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#041023'); grad.addColorStop(1,'#00111a');
  ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);

  ctx.beginPath();
  const len = freqArray.length;
  for(let i=0;i<len;i++){
    const v = freqArray[i] / 255;
    const x = (i / len) * w;
    const y = h - v * h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.lineWidth = 1.2; ctx.strokeStyle = '#00e0ff'; ctx.stroke();

  // base/defect vertical lines
  const sr = audioContext.sampleRate;
  const freqPerBin = sr / analyser.fftSize;
  const baseIdx = Math.round(baseFreq / freqPerBin);
  const defectIdx = Math.round(defectFreq / freqPerBin);
  const bx = Math.min(w-1, Math.max(0, (baseIdx / len) * w));
  const dx = Math.min(w-1, Math.max(0, (defectIdx / len) * w));

  ctx.strokeStyle = 'rgba(255,180,40,0.95)'; ctx.beginPath(); ctx.moveTo(bx,0); ctx.lineTo(bx,h); ctx.stroke();
  ctx.strokeStyle = 'rgba(255,80,80,0.95)'; ctx.beginPath(); ctx.moveTo(dx,0); ctx.lineTo(dx,h); ctx.stroke();

  // harmonics markers
  ctx.fillStyle = '#ffd27f';
  for(let hItem of harmonics){
    const idx = Math.round(hItem.freq / freqPerBin);
    const x = Math.min(w-1, Math.max(0, (idx / len) * w));
    const ampRatio = (freqArray[Math.max(0, Math.min(len-1, idx))] || 0) / 255;
    const y = h - ampRatio * h;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  }
}

/* tooltip */
canvas.addEventListener('mousemove', (ev) => {
  if(!analyser || !audioContext) return;
  const rect = canvas.getBoundingClientRect();
  const x = ev.clientX - rect.left;
  const len = freqData.length;
  const idx = Math.floor((x / rect.width) * len);
  const sr = audioContext.sampleRate;
  const fftN = analyser.fftSize;
  const freqPerBin = sr / fftN;
  const freq = (idx * freqPerBin);
  const amp = freqData[Math.max(0, Math.min(len-1, idx))] || 0;
  tooltip.style.left = (ev.clientX - rect.left) + 'px';
  tooltip.style.top = (ev.clientY - rect.top) + 'px';
  tooltip.innerHTML = `${Math.round(freq)} Hz â€” Amp: ${amp} (${ampToDb(amp).toFixed(2)} dB)`;
  tooltip.style.display = 'block';
});
canvas.addEventListener('mouseleave', ()=>{ tooltip.style.display = 'none'; });

/* ---------------- UI ì´ë²¤íŠ¸ ---------------- */
fftSizeSelect.addEventListener('change', () => {
  if(analyser){ analyser.fftSize = Number(fftSizeSelect.value); freqData = new Uint8Array(analyser.frequencyBinCount); timeData = new Uint8Array(analyser.fftSize); fftInfo.textContent = analyser.fftSize; freqPerBinText.textContent = (audioContext.sampleRate / analyser.fftSize).toFixed(3) + ' Hz'; }
});
window.addEventListener('beforeunload', ()=>{ if(audioContext && audioContext.state !== 'closed') audioContext.close(); });

</script>
</body>
</html>
