<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>í ë¦¿íƒ€ì´ì € ì§„ë‹¨ ë„êµ¬ (ì¬ë¶„ì„ ë° ë™ì  3% ê²€ìƒ‰)</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background-color: #f7fafc;
            padding: 10px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4A5568;
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: #764ba2;
            margin-top: 25px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1.4rem;
        }
        h3 {
            color: #4299e1;
            margin-top: 15px;
            font-size: 1.2rem;
        }
        .input-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #ffffff;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        .input-group input[type="number"], .input-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .button-group {
            text-align: center;
            margin-top: 20px;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin: 5px;
        }
        #connectButton { background-color: #48bb78; color: white; }
        #connectButton:hover { background-color: #38a169; }
        #startButton { background-color: #4299e1; color: white; }
        #startButton:hover { background-color: #3182ce; }
        #stopButton { background-color: #f56565; color: white; display: none; }
        #stopButton:hover { background-color: #e53e3e; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; color: #2b6cb0; }
        #realtimeResult, #finalResult {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background-color: #fcfcfc;
        }
        .db-diff-high { color: #e53e3e; font-size: 1.5em; }
        .db-diff-low { color: #38a169; font-size: 1.5em; }
        .explanation-section {
            background-color: #f0f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 5px solid #667eea;
        }
        .explanation-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .explanation-section th, .explanation-section td {
            border: 1px solid #cbd5e0;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        .explanation-section th {
            background-color: #e2e8f0;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš™ï¸ í ë¦¿íƒ€ì´ì € ì§„ë‹¨ ë„êµ¬</h1>

        <h2>1. ì§„ë‹¨ ë§¤ê°œë³€ìˆ˜ ì„¤ì • (1~7)</h2>
        <div id="inputForm">
            <div class="input-group">
                <label for="currentRpmInput">1. í˜„ì¬ ì¸¡ì • RPM ê°’ (ë³´ì • ê¸°ì¤€)</label>
                <input type="number" id="currentRpmInput" value="2500" min="100" required>
            </div>
            <div class="input-group">
                <label for="bladeCountInput">2. ê¸°ë³¸ ì£¼íŒŒìˆ˜ ë°°ìˆ˜ (ë¸”ë ˆì´ë“œ ìˆ˜)</label>
                <input type="number" id="bladeCountInput" value="20" min="1" required>
            </div>
            <div class="input-group">
                <label for="defectFactorInput">3. ê²°í•¨ ì£¼íŒŒìˆ˜ ë°°ìˆ˜ (ì˜ˆ: 7)</label>
                <input type="number" id="defectFactorInput" value="7" min="1" required>
            </div>
            <div class="input-group">
                <label for="baseRpmInput">4. ê¸°ì¤€ RPM (ì„ê³„ì¹˜ ì„¤ì • ì‹œì )</label>
                <input type="number" id="baseRpmInput" value="2500" min="100" required>
            </div>
            <div class="input-group">
                <label for="harmonicCountInput">5. ê²°í•¨ í•˜ëª¨ë‹‰ ìˆ˜ (1~10)</label>
                <input type="number" id="harmonicCountInput" value="3" min="1" max="10" required>
            </div>
            <div class="input-group">
                <label for="resonanceFreqInput">6. ê³µì§„(ìš¸ë¦¼) ì£¼íŒŒìˆ˜ ëŒ€ì—­ (Hz, ì‰¼í‘œ êµ¬ë¶„)</label>
                <input type="text" id="resonanceFreqInput" value="8000, 12000" required>
            </div>
            <div class="input-group">
                <label for="lpfCutoffInput">7. í¬ë½ì„  ì €ì£¼íŒŒ í•„í„° ì»·ì˜¤í”„ (Hz)</label>
                <input type="number" id="lpfCutoffInput" value="12000" min="100" required>
            </div>
        </div>

        <div class="button-group">
            <button id="connectButton">ğŸ¤ ë§ˆì´í¬ ì—°ê²°</button>
            <button id="startButton" disabled>ğŸ™ï¸ ë…¹ìŒ ì‹œì‘</button>
            <button id="stopButton">â¹ï¸ ë…¹ìŒ ì¤‘ì§€ & ë¶„ì„</button>
        </div>

        <p id="status">ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘</p>

        <div id="realtimeResult">
            <h2>ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼</h2>
            <p>ë…¹ìŒ ì‹œì‘ í›„ ì—¬ê¸°ì— ì‹¤ì‹œê°„ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        
        <div id="finalResult">
            <h2>ìµœì¢… ì§„ë‹¨ ê²°ê³¼</h2>
            <p>ë¶„ì„ ì™„ë£Œ í›„ ì—¬ê¸°ì— ìµœì¢… ì§„ë‹¨ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>

        <section class="explanation-section">
            <h2>ğŸ“Š RPMë³„ ì„¤ì • ê°€ì´ë“œ ë° ê³µì§„ í˜„ìƒ ì„¤ëª…</h2>

            <h3>1. RPMë³„ ì„¤ì • ë³€ê²½ ê°€ì´ë“œ (1500, 2000, 2500 RPM)</h3>
            <p><strong>1. í˜„ì¬ ì¸¡ì • RPM ê°’</strong>ë§Œ í•´ë‹¹ ì‹œì ì˜ ì‹¤ì œ RPMìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•˜ë©°, ë‹¤ë¥¸ í•„í„° ê°’(2~7ë²ˆ)ì€ ê¸°ê³„ì˜ ë¬¼ë¦¬ì  íŠ¹ì„±ì´ë¯€ë¡œ **ê³ ì •**í•©ë‹ˆë‹¤. ë¶„ì„ ì½”ë“œëŠ” 1ë²ˆê³¼ 4ë²ˆ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  $\text{dB}$ ê°’ì„ 2500 $\text{RPM}$ ê¸°ì¤€ìœ¼ë¡œ ë³´ì •í•©ë‹ˆë‹¤.</p>
            <table>
                <thead>
                    <tr>
                        <th>ë¶„ì„ RPM</th>
                        <th>1. í˜„ì¬ ì¸¡ì • RPM ê°’</th>
                        <th>4. ê¸°ì¤€ RPM ê°’</th>
                        <th>ì„¤ì • ì´ìœ </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1500 RPM</td>
                        <td>**1500**</td>
                        <td>**2500** (ê³ ì •)</td>
                        <td>$\text{RPM}$ ë³´ì •ì„ í†µí•´ 2500 $\text{RPM}$ ê¸°ì¤€ìœ¼ë¡œ ê²°í•¨ ì—ë„ˆì§€ë¥¼ í™˜ì‚°í•˜ì—¬ ì§„ë‹¨í•©ë‹ˆë‹¤.</td>
                    </tr>
                    <tr>
                        <td>2000 RPM</td>
                        <td>**2000**</td>
                        <td>**2500** (ê³ ì •)</td>
                        <td>$\text{RPM}$ í—ŒíŒ…ì— ê´€ê³„ì—†ì´ í˜„ì¬ $\text{RPM}$ ê°’ì„ ì…ë ¥í•˜ë©´ ê²°í•¨ ì£¼íŒŒìˆ˜ ìœ„ì¹˜ë¥¼ **ë™ì  3% ê²€ìƒ‰**ìœ¼ë¡œ ì •í™•íˆ ì¶”ì í•©ë‹ˆë‹¤.</td>
                    </tr>
                    <tr>
                        <td>2500 RPM</td>
                        <td>**2500**</td>
                        <td>**2500** (ê³ ì •)</td>
                        <td>ê¸°ì¤€ $\text{RPM}$ê³¼ ë™ì¼í•˜ë¯€ë¡œ, $\text{RPM}$ ë³´ì • ê³„ìˆ˜ëŠ” 1ì´ ë©ë‹ˆë‹¤.</td>
                    </tr>
                </tbody>
            </table>

            <h3>2. $8000 \text{Hz} \sim 12000 \text{Hz}$ ì§„í­ ìƒìŠ¹ ë° í”¼í¬ í˜„ìƒ ì„¤ëª… (ê³µì§„ ëŒ€ì—­)</h3>
            <p>ì¸¡ì •ëœ $\text{FFT}$ ìŠ¤í™íŠ¸ëŸ¼ì—ì„œ $8000 \text{Hz}$ë¶€í„° $12000 \text{Hz}$ ì‚¬ì´ì˜ ì§„í­ì´ ìƒìŠ¹í•˜ê±°ë‚˜ í”¼í¬ê°€ ë³´ì´ëŠ” í˜„ìƒì€ ê¸°ê³„ êµ¬ì¡°ì˜ **ê³µì§„(Resonance)**ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ ëŒ€ì—­ì´ ë°”ë¡œ **6. ê³µì§„ ì£¼íŒŒìˆ˜ ëŒ€ì—­ ($\text{BPF}$)** ì„¤ì •ì˜ ê·¼ê±°ì…ë‹ˆë‹¤.</p>
            <ul>
                <li>**ìš´ë°˜íŒŒ(Carrier Wave):** ì´ ëŒ€ì—­ì€ **ì¶©ê²©(ê²°í•¨)**ì´ ë°œìƒí–ˆì„ ë•Œ ê¸°ê³„ êµ¬ì¡°ê°€ ê°€ì¥ í¬ê²Œ ìš¸ë¦¬ëŠ” ì£¼íŒŒìˆ˜ì…ë‹ˆë‹¤. ê²°í•¨ì˜ ë°˜ë³µ ë¦¬ë“¬($\mathbf{F_{\text{defect}}}$)ì€ ì´ ê³ ì£¼íŒŒ ìš´ë°˜íŒŒì— ì‹¤ë ¤ì„œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
                <li>**BPFì˜ ì—­í• :** $\text{BPF}$ í•„í„°ëŠ” $8000 \text{Hz} \sim 12000 \text{Hz}$ì˜ ì—ë„ˆì§€**ë§Œ** ì¶”ì¶œí•˜ì—¬, ë‹¤ë¥¸ ì†ŒìŒì„ ì œê±°í•˜ê³  ê²°í•¨ ì—ë„ˆì§€ë¥¼ **ê°€ì¥ ìˆœë„ ë†’ê²Œ** ì¶”ì¶œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ $\mathbf{F_{\text{defect}}}$ì˜ ê°’ê³¼ ë¬´ê´€í•˜ê²Œ ê¸°ê³„ì˜ ë¬¼ë¦¬ì  íŠ¹ì„±($\text{ìš¸ë¦¼}$)ì— ê¸°ë°˜í•©ë‹ˆë‹¤.</li>
            </ul>
        </section>
    </div>

    <script>
        // AudioContextì™€ ê´€ë ¨ëœ ëª¨ë“  ë¶„ì„ ë¡œì§ì„ ìº¡ìŠí™”í•˜ëŠ” í´ë˜ìŠ¤
        class AudioAnalyzer {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.audioSource = null;
                this.stream = null;
                
                this.isRecording = false;
                this.isAnalyzing = false;
                this.isDataReady = false; 
                
                this.historyData = [];
                this.startTime = 0;
                this.lastUpdateTime = 0;
                this.totalDataPoints = 0;

                this.statusElement = document.getElementById('status');
                this.resultElement = document.getElementById('realtimeResult');
                this.finalResultElement = document.getElementById('finalResult');
                
                this.currentRpmInput = 0;
                this.bladeCountInput = 0;
                this.defectFactorInput = 0;
                this.baseRpmInput = 0;
                this.harmonicCountInput = 0;
                this.resonanceMin = 0;
                this.resonanceMax = 0;
                this.lpfCutoffInput = 0;

                this.diffBuffer = [];
                this.kurtosisBuffer = [];
                this.crestFactorBuffer = [];
                this.bufferSize = 20; 
            }

            // ëª¨ë“  ì…ë ¥ê°’ì„ DOMì—ì„œ ì½ì–´ì™€ í´ë˜ìŠ¤ ë³€ìˆ˜ì— ì €ì¥
            readInputValues() {
                this.currentRpmInput = parseFloat(document.getElementById('currentRpmInput').value) || 0;
                this.bladeCountInput = parseFloat(document.getElementById('bladeCountInput').value) || 0;
                this.defectFactorInput = parseFloat(document.getElementById('defectFactorInput').value) || 0;
                this.baseRpmInput = parseFloat(document.getElementById('baseRpmInput').value) || 0;
                this.harmonicCountInput = parseInt(document.getElementById('harmonicCountInput').value) || 1;
                this.lpfCutoffInput = parseFloat(document.getElementById('lpfCutoffInput').value) || 1000;
                
                const resFreqs = document.getElementById('resonanceFreqInput').value.split(',').map(s => parseFloat(s.trim()));
                this.resonanceMin = resFreqs[0] || 0;
                this.resonanceMax = resFreqs[1] || 0;
                
                if (this.currentRpmInput === 0 || this.baseRpmInput === 0 || this.bladeCountInput === 0 || this.defectFactorInput === 0) {
                    this.statusElement.textContent = 'ì˜¤ë¥˜: í•„ìˆ˜ RPM/ë°°ìˆ˜ ê°’ì´ 0ì…ë‹ˆë‹¤.';
                    return false;
                }
                return true;
            }

            // ë§ˆì´í¬ ì—°ê²° (ì´ˆê¸° ì„¤ì •)
            async connectMicrophone() {
                try {
                    this.statusElement.textContent = 'ìƒíƒœ: ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì¤‘...';
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 32768; 
                    const bufferLength = this.analyser.frequencyBinCount;
                    this.dataArray = new Uint8Array(bufferLength);
                    this.maxFrequency = this.audioContext.sampleRate / 2; 

                    this.audioSource = this.audioContext.createMediaStreamSource(this.stream);
                    this.audioSource.connect(this.analyser); 

                    this.statusElement.textContent = 'âœ… ìƒíƒœ: ë§ˆì´í¬ ì—°ê²° ì™„ë£Œ. ë…¹ìŒ ì‹œì‘ ê°€ëŠ¥.';
                    document.getElementById('startButton').disabled = false;
                    document.getElementById('connectButton').style.display = 'none';

                } catch (err) {
                    this.statusElement.textContent = `âŒ ì˜¤ë¥˜: ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨ (${err.name})`;
                }
            }

            // ë…¹ìŒ ì‹œì‘
            startRecording() {
                if (!this.readInputValues()) return;

                this.isRecording = true;
                this.isAnalyzing = true;
                this.historyData = [];
                this.totalDataPoints = 0;
                this.startTime = this.audioContext.currentTime * 1000;
                this.lastUpdateTime = this.startTime;
                this.statusElement.textContent = 'ğŸ”´ ìƒíƒœ: ë…¹ìŒ ì¤‘... (ìµœì†Œ 5ì´ˆ ê¶Œì¥)';
                this.finalResultElement.innerHTML = '<h2>ìµœì¢… ì§„ë‹¨ ê²°ê³¼</h2><p>ë¶„ì„ ëŒ€ê¸° ì¤‘...</p>';
                
                if(!this.analyser || !this.audioSource) {
                    this.connectMicrophone();
                }

                this.processAudio();
            }

            // ì˜¤ë””ì˜¤ ë°ì´í„° ì²˜ë¦¬ ë° ê¸°ë¡
            processAudio() {
                if (!this.isRecording && !this.isAnalyzing) return;

                if (!this.analyser) { 
                    this.statusElement.textContent = 'âŒ ì˜¤ë¥˜: ë¶„ì„ê¸° ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.';
                    return;
                }
                
                this.analyser.getByteFrequencyData(this.dataArray);
                const rawFft = Array.from(this.dataArray);

                const filteredFft = this.applyBandPassFilter(rawFft);
                
                if (this.isRecording) {
                    this.historyData.push({
                        rawFft: rawFft,
                        filteredFft: filteredFft,
                        time: this.audioContext.currentTime * 1000,
                    });
                    this.totalDataPoints++;
                }

                this.analyzeAudioStep(rawFft, filteredFft, this.audioContext.currentTime * 1000);

                if (this.isAnalyzing) {
                    requestAnimationFrame(() => this.processAudio());
                }
            }

            // BPF í•„í„° (ê³ ì£¼íŒŒ ìš´ë°˜íŒŒ ì¶”ì¶œ) ì ìš©
            applyBandPassFilter(rawFft) {
                const filtered = [...rawFft];
                const binSize = this.maxFrequency / this.analyser.frequencyBinCount;

                for (let i = 0; i < filtered.length; i++) {
                    const freq = i * binSize;
                    
                    if (freq < this.resonanceMin || freq > this.resonanceMax) {
                        filtered[i] = 0;
                    }
                }
                return filtered;
            }

            // ìˆœê°„ì ì¸ ì§€í‘œ ê³„ì‚° (RPM ë³´ì • í¬í•¨)
            calculateInstantaneousMetrics(rawFft, filteredFft, time) {
                const binSize = this.maxFrequency / this.analyser.frequencyBinCount;
                
                // 1. ì£¼íŒŒìˆ˜ ê³„ì‚° (RPMì— ë¹„ë¡€í•˜ì—¬ ë™ì ìœ¼ë¡œ ë³€í•¨)
                const fundamentalHz = (this.currentRpmInput / 60) * this.bladeCountInput;
                const peakHz = fundamentalHz * this.defectFactorInput;
                
                // 2. RAW FFTì—ì„œ ê¸°ë³¸ ì£¼íŒŒìˆ˜ ì§„í­ ì¶”ì¶œ (ë™ì  3% ê²€ìƒ‰ ì ìš©)
                const fundamentalBin = Math.round(fundamentalHz / binSize);
                // **ìˆ˜ì •ëœ ë¶€ë¶„: centerFreq ì¸ìˆ˜ë¡œ fundamentalHz ì „ë‹¬**
                const fundamentalAmplitudeRaw = this.getPeakAmplitude(rawFft, fundamentalBin, binSize, fundamentalHz);
                
                // 3. í•„í„°ë§ëœ FFTì—ì„œ ê²°í•¨ ì£¼íŒŒìˆ˜ ì§„í­ ì¶”ì¶œ ë° í•©ì‚°
                let peakAmplitudeFilteredSum = 0;
                
                for (let h = 1; h <= this.harmonicCountInput; h++) {
                    const harmonicHz = peakHz * h;
                    if (harmonicHz > this.lpfCutoffInput) break; 
                    
                    const harmonicBin = Math.round(harmonicHz / binSize);
                    // **ìˆ˜ì •ëœ ë¶€ë¶„: centerFreq ì¸ìˆ˜ë¡œ harmonicHz ì „ë‹¬**
                    peakAmplitudeFilteredSum += this.getPeakAmplitude(filteredFft, harmonicBin, binSize, harmonicHz);
                }
                
                const peakAmplitudeFiltered = peakAmplitudeFilteredSum;

                // 4. RPM ë³´ì • (dB ì°¨ì´ì˜ ì•ˆì •í™”)
                const compensationFactor = this.baseRpmInput / this.currentRpmInput;
                const compensatedPeakAmplitude = peakAmplitudeFiltered * compensationFactor;

                // 5. dB ì°¨ì´ ê³„ì‚° (ë¡œê·¸ ìŠ¤ì¼€ì¼ + ì˜¤í”„ì…‹)
                // ì†ŒìŒ ì¸¡ì •ì¹˜ ë‚®ìŒ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì˜¤í”„ì…‹ +20 ìœ ì§€
                const difference = 20 * Math.log10(compensatedPeakAmplitude / fundamentalAmplitudeRaw) + 20; 

                // 6. ì²¨ë„(Kurtosis) ë° íŒŒê³ ìœ¨(Crest Factor) ê³„ì‚° 
                const kurtosis = this.calculateKurtosis(filteredFft);
                const crestFactor = this.calculateCrestFactor(filteredFft);

                return {
                    fundamentalAmplitudeRaw: fundamentalAmplitudeRaw,
                    peakAmplitudeFiltered: peakAmplitudeFiltered,
                    kurtosis: kurtosis,
                    crestFactor: crestFactor,
                    difference: isNaN(difference) ? 0 : difference, 
                    peakHz: peakHz,
                    fundamentalHz: fundamentalHz,
                };
            }

            // **ìˆ˜ì •ëœ í•¨ìˆ˜: ì£¼íŒŒìˆ˜ ë²”ìœ„ 3% ë™ì  ê²€ìƒ‰ ì ìš©**
            getPeakAmplitude(fftData, centerBin, binSize, centerFreq) {
                // 3% ëŒ€ì—­í­ (ì „ì²´ í­) -> ê²€ìƒ‰ ë°˜ê²½ì€ 1.5% (0.015)
                const PERCENTAGE_HALFRANGE = 0.015; 
                
                // ë™ì  ê²€ìƒ‰ ë°˜ê²½ (Hz) ê³„ì‚°: (ì¤‘ì‹¬ ì£¼íŒŒìˆ˜ * 0.015)
                const searchRangeHz = centerFreq * PERCENTAGE_HALFRANGE; 

                // ê²€ìƒ‰í•  ë¹ˆ(Bin) ê°œìˆ˜ ê³„ì‚°: (searchRangeHz / Bin Size)ë¥¼ ë°˜ì˜¬ë¦¼
                const searchBins = Math.round(searchRangeHz / binSize);

                let maxAmp = 0;
                // ê²€ìƒ‰ ì‹œì‘ì ê³¼ ëì ì„ ê²°ì • (0ê³¼ ìµœëŒ€ ê¸¸ì´ ë²”ìœ„ ë‚´ì—ì„œ)
                const start = Math.max(0, centerBin - searchBins);
                const end = Math.min(fftData.length, centerBin + searchBins);

                for (let i = start; i < end; i++) {
                    if (fftData[i] > maxAmp) {
                        maxAmp = fftData[i]; // í•´ë‹¹ ë²”ìœ„ ë‚´ì˜ ìµœëŒ€ê°’(Peak)ì„ ì €ì¥
                    }
                }
                return maxAmp;
            }

            // ì²¨ë„ (Kurtosis) ê³„ì‚° (í•„í„°ë§ëœ FFT ê¸°ì¤€)
            calculateKurtosis(fftData) {
                const rms = Math.sqrt(fftData.reduce((sum, val) => sum + val * val, 0) / fftData.length);
                if (rms === 0) return 0;
                
                const fourthMoment = fftData.reduce((sum, val) => sum + Math.pow(val - rms, 4), 0) / fftData.length;
                const variance = fftData.reduce((sum, val) => sum + Math.pow(val - rms, 2), 0) / fftData.length;
                
                const kurt = (fourthMoment / (variance * variance)) - 3;
                return Math.max(0, kurt * 0.1); 
            }

            // íŒŒê³ ìœ¨ (Crest Factor) ê³„ì‚° (í•„í„°ë§ëœ FFT ê¸°ì¤€)
            calculateCrestFactor(fftData) {
                const maxPeak = fftData.reduce((max, val) => Math.max(max, val), 0);
                const rms = Math.sqrt(fftData.reduce((sum, val) => sum + val * val, 0) / fftData.length);
                return rms > 0 ? maxPeak / rms : 0;
            }

            // ì‹¤ì‹œê°„ ë¶„ì„ ë‹¨ê³„ (ì´ë™ í‰ê·  ì ìš©)
            analyzeAudioStep(rawFft, filteredFft, time) {
                const { difference, kurtosis, crestFactor, peakHz, fundamentalHz, fundamentalAmplitudeRaw, peakAmplitudeFiltered } = 
                    this.calculateInstantaneousMetrics(rawFft, filteredFft, time);

                this.diffBuffer.push(difference);
                this.kurtosisBuffer.push(kurtosis);
                this.crestFactorBuffer.push(crestFactor);

                if (this.diffBuffer.length > this.bufferSize) {
                    this.diffBuffer.shift();
                    this.kurtosisBuffer.shift();
                    this.crestFactorBuffer.shift();
                }

                const sumArray = (arr) => arr.reduce((a, b) => a + b, 0);
                const smoothedDifference = sumArray(this.diffBuffer) / this.diffBuffer.length;
                const smoothedKurtosis = sumArray(this.kurtosisBuffer) / this.kurtosisBuffer.length;
                const smoothedCrestFactor = sumArray(this.crestFactorBuffer) / this.crestFactorBuffer.length;

                this.lastUpdateTime = time;
                
                // ì‹¤ì‹œê°„ ì‹¬ê°ë„ íŒë‹¨ (ì„ê³„ê°’ 5.0, 7.0 ìœ ì§€)
                let severity = 'ì •ìƒ';
                let severityColor = '#38a169'; 

                if (smoothedDifference > 7.0 || smoothedKurtosis > 4.0 || smoothedCrestFactor > 8) { 
                    severity = 'ğŸš¨ ìœ„í—˜ (ì¦‰ì‹œ ì ê²€)';
                    severityColor = '#e53e3e'; 
                } else if (smoothedDifference > 5.0 || smoothedKurtosis > 2.5 || smoothedCrestFactor > 5) { 
                    severity = 'âš ï¸ ê²½ê³  (ì¶”ì´ ê´€ì°°)';
                    severityColor = '#d69e2e'; 
                } else if (smoothedDifference < 1.2) { 
                    severity = 'ğŸ”µ ì ê²€ í•„ìš” (ë§ˆëª¨ ì˜ì‹¬)';
                    severityColor = '#3182ce'; 
                }

                const diffClass = smoothedDifference > 4.0 ? 'db-diff-high' : 'db-diff-low';

                this.resultElement.innerHTML = `
                    <h3>ğŸ“Š ì‹¤ì‹œê°„ ë¶„ì„ (${((this.lastUpdateTime - this.startTime) / 1000).toFixed(2)}ì´ˆ)</h3>
                    <p style="color: ${severityColor}; font-weight: bold;">ê²°í•¨ ì‹¬ê°ë„: ${severity}</p>
                    <hr style="border: none; border-top: 1px dashed #e2e8f0; margin: 10px 0;">
                    <p style="font-size: 1.1em;">í‰ê·  \\(\\text{dB}\\) ì°¨ì´: <span class="${diffClass}">${smoothedDifference.toFixed(2)} dB</span></p>
                    <p>í‰ê·  ì²¨ë„: <strong>${smoothedKurtosis.toFixed(2)}</strong></p>
                    <p>í‰ê·  íŒŒê³ ìœ¨: <strong>${smoothedCrestFactor.toFixed(2)}</strong></p>
                    <hr style="border: none; border-top: 1px dashed #e2e8f0; margin: 10px 0;">
                    <p>ë¶„ì„ ì¤‘ì‹¬ ì£¼íŒŒìˆ˜: ${peakHz.toFixed(2)} Hz (\\(\\pm 1.5\\)% ë™ì  ê²€ìƒ‰)</p>
                    <p>ê¸°ë³¸ ì£¼íŒŒìˆ˜ (${fundamentalHz.toFixed(2)} Hz) ì§„í­: <strong>${fundamentalAmplitudeRaw.toFixed(2)}</strong></p>
                `;
                if (window.MathJax) {
                    MathJax.typeset([this.resultElement]);
                }
            }

            // 1. ë…¹ìŒ ì¤‘ì§€ë§Œ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
            stopRecording() {
                if (this.audioSource) {
                    this.audioSource.disconnect();
                    if (this.analyser) this.analyser.disconnect();
                    this.audioSource = null;
                    
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        this.stream = null;
                    }
                }
                this.isRecording = false;
                this.isAnalyzing = false;
                this.isDataReady = true; 
                
                this.statusElement.textContent = `âœ… ìƒíƒœ: ë…¹ìŒ ì¤‘ì§€. ì´ ${this.historyData.length} ìƒ˜í”Œ ê¸°ë¡ë¨.`;
                
                this.runAnalysis(this.historyData); 
            }

            // 2. ì‹¤ì œ ë¶„ì„ ë° ê²°ê³¼ í‘œì‹œë¥¼ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜ (ì¬ì‚¬ìš© ê°€ëŠ¥)
            runAnalysis(data) {
                if (!data || data.length === 0) {
                    this.finalResultElement.innerHTML = '<h2>ìµœì¢… ì§„ë‹¨ ê²°ê³¼</h2><p>ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë…¹ìŒì„ ì‹œì‘í•˜ê³  ì¤‘ì§€í•˜ì‹­ì‹œì˜¤.</p>';
                    return;
                }
                if (!this.readInputValues()) return; 
                
                this.totalDataPoints = data.length;
                
                let sumDiff = 0;
                let sumKurtosis = 0;
                let sumCrestFactor = 0;
                let finalPeakHz = 0; 
                
                for (const point of data) {
                    const { difference, kurtosis, crestFactor, peakHz } = 
                        this.calculateInstantaneousMetrics(point.rawFft, point.filteredFft, point.time);
                    
                    sumDiff += difference;
                    sumKurtosis += kurtosis;
                    sumCrestFactor += crestFactor;
                    finalPeakHz = peakHz; 
                }

                const avgDiff = sumDiff / this.totalDataPoints;
                const avgKurtosis = sumKurtosis / this.totalDataPoints;
                const avgCrestFactor = sumCrestFactor / this.totalDataPoints;
                const totalTime = (this.lastUpdateTime - this.startTime) / 1000;

                // ìµœì¢… ì‹¬ê°ë„ íŒë‹¨ (ì„ê³„ê°’ 5.0, 7.0 ìœ ì§€)
                let severity = 'ì •ìƒ';
                let severityColor = '#38a169';
                
                if (avgDiff > 7.0 || avgKurtosis > 4.0 || avgCrestFactor > 8) { 
                    severity = 'ğŸš¨ ìœ„í—˜: ê³¼ë„í•œ ì••ë ¥ ë˜ëŠ” ì‹¬ê°í•œ ê²°í•¨. ì¦‰ì‹œ ì ê²€ í•„ìš”.';
                    severityColor = '#e53e3e';
                } else if (avgDiff > 5.0 || avgKurtosis > 2.5 || avgCrestFactor > 5) { 
                    severity = 'âš ï¸ ê²½ê³ : ë¸”ë ˆì´ë“œ ì••ë ¥ì´ ë†’ê±°ë‚˜ ë§ˆëª¨ê°€ ê°€ì†ë˜ê³  ìˆìŒ. ì¶”ì´ ê´€ì°°.';
                    severityColor = '#d69e2e';
                } else if (avgDiff < 1.2 && this.totalDataPoints > 0) { 
                    severity = 'ğŸ”µ ì ê²€ í•„ìš”: ë¸”ë ˆì´ë“œ ë§ˆëª¨ë¡œ ì¸í•œ ì ˆì‚­ë ¥ ìƒì‹¤ ì˜ì‹¬. ìˆ˜ëª… ì¢…ë£Œ í™•ì¸.';
                    severityColor = '#3182ce';
                }
                
                this.finalResultElement.innerHTML = `
                    <h2 style="color: ${severityColor}; text-align: center;">âš™ï¸ ìµœì¢… ì§„ë‹¨ ê²°ê³¼: ${severity}</h2>
                    <div style="text-align: center; margin: 20px 0;">
                        <p style="font-size: 2em; font-weight: bold; color: ${avgDiff > 5.0 ? '#e53e3e' : '#38a169'};">í‰ê·  \\(\\text{dB}\\) ì°¨ì´: ${avgDiff.toFixed(2)} dB</p>
                    </div>
                    <table style="width: 100%; margin: 0 auto; text-align: left; font-size: 0.95rem;">
                        <tr><th style="width: 50%;">ë¶„ì„ ì‹œê°„</th><td>${totalTime.toFixed(2)} ì´ˆ</td></tr>
                        <tr><th>í‰ê·  ì²¨ë„ (Kurtosis)</th><td>${avgKurtosis.toFixed(2)}</td></tr>
                        <tr><th>í‰ê·  íŒŒê³ ìœ¨ (Crest Factor)</th><td>${avgCrestFactor.toFixed(2)}</td></tr>
                        <tr><th>ê¸°ì¤€ RPM / í˜„ì¬ RPM</th><td>${this.baseRpmInput} / ${this.currentRpmInput}</td></tr>
                        <tr><th>ë¶„ì„ëœ ê²°í•¨ ì£¼íŒŒìˆ˜ ì¤‘ì‹¬</th><td>${finalPeakHz.toFixed(2)} Hz (\\(\\pm 1.5\\)% ë™ì  ê²€ìƒ‰)</td></tr>
                        <tr><th>ì ìš©ëœ BPF ëŒ€ì—­</th><td>${this.resonanceMin} Hz ~ ${this.resonanceMax} Hz</td></tr>
                        <tr><th>ì ìš©ëœ LPF ì»·ì˜¤í”„</th><td>${this.lpfCutoffInput} Hz</td></tr>
                    </table>
                    <p style="text-align: center; margin-top: 20px; color: #718096; font-weight: bold;">âš ï¸ í•„í„°, RPM, ë°°ìˆ˜ ì„¤ì •ì„ ë³€ê²½í•˜ê³  ì¬ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
                `;

                this.isRecording = false;
                this.isAnalyzing = false;
                this.isDataReady = true; 
                
                if (window.MathJax) {
                    MathJax.typeset([this.finalResultElement]);
                }
            }
        }

        const analyzer = new AudioAnalyzer();

        document.addEventListener('DOMContentLoaded', () => {
            const connectButton = document.getElementById('connectButton');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');

            connectButton.addEventListener('click', () => {
                analyzer.connectMicrophone();
            });

            // 'ë…¹ìŒ ì‹œì‘' ë²„íŠ¼ í•¸ë“¤ëŸ¬
            startButton.addEventListener('click', () => {
                if (analyzer.isDataReady) {
                    analyzer.historyData = []; 
                    analyzer.isDataReady = false;
                    analyzer.totalDataPoints = 0;
                }
                analyzer.startRecording();
                
                startButton.style.display = 'none';
                stopButton.style.display = 'block';
                stopButton.textContent = 'â¹ï¸ ë…¹ìŒ ì¤‘ì§€ & ë¶„ì„'; 
            });

            // 'ë…¹ìŒ ì¤‘ì§€ & ë¶„ì„' ë˜ëŠ” 'ì¬ë¶„ì„' ë²„íŠ¼ í•¸ë“¤ëŸ¬
            stopButton.addEventListener('click', () => {
                if (analyzer.isRecording) {
                    // ìƒíƒœ 1: ë…¹ìŒ ì¤‘ì¼ ë•Œ -> ë…¹ìŒ ì¤‘ì§€ ë° ìµœì´ˆ ë¶„ì„ ì‹¤í–‰
                    analyzer.stopRecording(); 
                    
                    stopButton.textContent = 'ğŸ”„ ì¬ë¶„ì„ (ì„¤ì • ë³€ê²½ ì™„ë£Œ)';
                    startButton.style.display = 'block'; 
                    
                } else if (analyzer.isDataReady) {
                    // ìƒíƒœ 2: ë…¹ìŒì€ ì¤‘ì§€ë˜ì—ˆê³  ë°ì´í„°ê°€ ì¤€ë¹„ëœ ìƒíƒœ -> ì¬ë¶„ì„ ì‹¤í–‰
                    analyzer.runAnalysis(analyzer.historyData);
                    stopButton.textContent = 'ğŸ”„ ì¬ë¶„ì„ ì™„ë£Œ'; 
                }
            });
        });
    </script>
</body>
</html>
