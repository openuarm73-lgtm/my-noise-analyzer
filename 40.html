<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì†Œë¦¬ ë¶„ì„ê¸° â€” ì™„ì „íŒ (ëª¨ë“  ê¸°ëŠ¥)</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",sans-serif;
    background:linear-gradient(135deg,#2b6cb0,#805ad5);
    color:#222;min-height:100vh;padding:18px;
  }
  .container{max-width:1100px;margin:0 auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.18)}
  h1{font-size:1.3rem;text-align:center;margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
  .panel{background:#fbfbff;padding:12px;border-radius:10px}
  label{display:block;margin-top:8px;font-weight:600;margin-bottom:6px}
  input[type=number], input[type=text], select {width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:0.95rem}
  .row{display:flex;gap:8px}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button{padding:9px 12px;border-radius:8px;border:none;font-weight:700;color:#fff;cursor:pointer}
  #connectBtn{background:#38a169} #startButton{background:#3182ce} #stopButton{background:#e53e3e}
  button:disabled{background:#9aa3b2;cursor:not-allowed}
  .status{margin-top:10px;padding:10px;border-radius:8px;font-size:0.9rem}
  .status.success{background:#e6fffa;color:#22543d}
  .status.error{background:#fff5f5;color:#822727}
  .status.info{background:#fffff0;color:#735c0f}
  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .kpi-item{background:#fff;padding:8px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.06);min-width:120px}
  .small{font-size:0.85rem;color:#444}
  canvas{width:100%;height:200px;background:#041023;border-radius:6px;display:block}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid #eee;text-align:left;font-size:0.9rem}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;color:#fff;font-size:0.85rem}
  .ok{background:#38a169} .warn{background:#dd6b20} .bad{background:#e53e3e}
  .tooltip{position:absolute;padding:6px 8px;background:rgba(0,0,0,0.8);color:#fff;border-radius:6px;font-size:0.85rem;pointer-events:none;transform:translate(-50%,-120%);white-space:nowrap;z-index:10}
  .controls-row{display:flex;gap:8px;align-items:center}
  .muted{color:#666;font-size:0.9rem}
  @media(max-width:1000px){.grid{grid-template-columns:1fr;}.panel{margin-bottom:12px}}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ”Š ì†Œë¦¬ ë¶„ì„ê¸° â€” ì™„ì „íŒ (ë§ˆì´í¬Â·7Ã—ê²°í•¨Â·ê·¸ë˜í”„Â·ë¡œê·¸Â·ì•ŒëŒ)</h1>

  <div class="grid">
    <!-- LEFT: ì»¨íŠ¸ë¡¤ & ê²°ê³¼ -->
    <div class="panel">
      <label>í˜„ì¬ RPM</label>
      <input type="number" id="rpmInput" value="1500" min="1">

      <label>ê¸°ë³¸ ì£¼íŒŒìˆ˜ ë°°ìˆ˜ (ë¸”ë ˆì´ë“œ ìˆ˜)</label>
      <input type="number" id="bladeCountInput" value="20" min="1">

      <div class="small" style="margin-top:6px">ê²°í•¨ì£¼íŒŒìˆ˜ëŠ” ìë™ìœ¼ë¡œ <b>ê¸°ë³¸ì£¼íŒŒìˆ˜ Ã— 7</b> ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

      <label>FFT í¬ê¸°</label>
      <select id="fftSizeSelect">
        <option value="2048">2048</option>
        <option value="4096" selected>4096</option>
        <option value="8192">8192</option>
      </select>

      <div class="btns" style="margin-top:10px">
        <button id="connectBtn">ğŸ¤ ë§ˆì´í¬ ì—°ê²°</button>
        <button id="startButton" disabled>ğŸ“Š ë¶„ì„ ì‹œì‘</button>
        <button id="stopButton" disabled>â¹ ë¶„ì„ ì¤‘ì§€</button>
      </div>

      <div id="status" class="status info">ë§ˆì´í¬ ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

      <div style="margin-top:10px" class="controls-row">
        <div style="flex:1">
          <label>ì´ë™í‰ê·  ê¸¸ì´ (í”„ë ˆì„)</label>
          <input type="number" id="maLen" value="10" min="1">
        </div>
        <div style="width:120px">
          <label>ê²½ë³´ìŒ</label>
          <select id="alarmMode">
            <option value="off">ë„ê¸°</option>
            <option value="beep" selected>ë¹„í”„ìŒ</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px" class="controls-row">
        <div style="flex:1">
          <label>AI íŒì • ì„ê³„ê°’ (dB)</label>
          <div class="row">
            <input type="number" id="warnThreshold" value="3" min="0" step="0.1" title="ì£¼ì˜ ê¸°ì¤€ (dB)">
            <input type="number" id="badThreshold" value="8" min="0" step="0.1" title="ê²°í•¨ ê¸°ì¤€ (dB)">
          </div>
          <div class="small" style="margin-top:6px">diff(dB) &gt; ì£¼ì˜ &gt; ê²°í•¨ (ê°’ ë³€ê²½ ê°€ëŠ¥)</div>
        </div>
        <div style="width:160px">
          <label>ë¡œê·¸ ìˆ˜ì§‘</label>
          <div class="row">
            <button id="toggleLogBtn" style="background:#718096">ìˆ˜ì§‘ ì‹œì‘</button>
            <button id="downloadCsvBtn" style="background:#2b6cb0">CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>
      </div>

      <div class="kpi">
        <div class="kpi-item">
          <div class="small">ë¶„ì„ì‹œê°„</div>
          <div id="timeCounter" style="font-weight:700">0 s</div>
        </div>
        <div class="kpi-item">
          <div class="small">ì´ë™í‰ê·  (dB)</div>
          <div id="movingAvg" style="font-weight:700">-</div>
        </div>
        <div class="kpi-item">
          <div class="small">ì „ì²´ RMS (dB)</div>
          <div id="rmsVal" style="font-weight:700">-</div>
        </div>
        <div class="kpi-item">
          <div class="small">Peak (dB)</div>
          <div id="peakVal" style="font-weight:700">-</div>
        </div>
      </div>

      <div style="margin-top:10px" class="panel">
        <div class="small">ê¸°ë³¸ / ê²°í•¨ (7Ã—) ì£¼íŒŒìˆ˜</div>
        <div id="freqResult" style="margin-top:6px;font-weight:700">-</div>

        <div class="small" style="margin-top:8px">ê³ ì¡°íŒŒ (1Ã— ~ 7Ã—)</div>
        <table id="harmonicsTable">
          <thead><tr><th>ë°°ìˆ˜</th><th>ì£¼íŒŒìˆ˜(Hz)</th><th>ì§„í­</th><th>dB</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:8px">
          <div class="small">AI ìƒíƒœíŒì •</div>
          <div id="aiState" style="margin-top:6px"><span class="badge ok">-</span></div>
        </div>

      </div>

    </div>

    <!-- RIGHT: ê·¸ë˜í”„ ë° ì„¸ë¶€ -->
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">ì‹¤ì‹œê°„ ìŠ¤í™íŠ¸ëŸ¼ (ë§ˆìš°ìŠ¤ ì˜¤ë²„: ì£¼íŒŒìˆ˜/ì§„í­ í‘œì‹œ)</div>
        <div class="small muted">ìƒ˜í”Œë ˆì´íŠ¸: <span id="sr">-</span> / FFT: <span id="fftInfo">-</span></div>
      </div>
      <div style="position:relative;margin-top:8px">
        <canvas id="spectrumCanvas" width="800" height="240"></canvas>
        <div id="tooltip" class="tooltip" style="display:none"></div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="kpi-item"><div class="small">ì²¨ë„ (Kurtosis)</div><div id="kurtVal" style="font-weight:700">-</div></div>
        <div class="kpi-item"><div class="small">íŒŒê³ ìœ¨ (Crest)</div><div id="crestVal" style="font-weight:700">-</div></div>
        <div class="kpi-item"><div class="small">ë¹ˆë‹¹ ì£¼íŒŒìˆ˜</div><div id="freqPerBin" style="font-weight:700">-</div></div>
      </div>

      <div style="margin-top:10px" class="small muted">íŒ: ë¸Œë¼ìš°ì €ê°€ ë§ˆì´í¬ ê¶Œí•œì„ ìš”êµ¬í•˜ë©´ 'í—ˆìš©'í•˜ì„¸ìš”. ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì‹œ `http://localhost:8000/20.html` í˜•íƒœë¡œ ì—´ë©´ ì•ˆì „í•©ë‹ˆë‹¤.</div>
    </div>

  </div>
</div>

<script>
/* ---------------- ë³€ìˆ˜ ë° UI ì°¸ì¡° ---------------- */
let audioContext=null, analyser=null, micSource=null, freqData=null, timeData=null;
let isAnalyzing=false, rafId=null, startTime=null;
let dbHistory=[], logRecords=[], logging=false;

const connectBtn = document.getElementById('connectBtn');
const startBtn = document.getElementById('startButton');
const stopBtn = document.getElementById('stopButton');
const statusDiv = document.getElementById('status');
const rpmInput = document.getElementById('rpmInput');
const bladeInput = document.getElementById('bladeCountInput');
const fftSizeSelect = document.getElementById('fftSizeSelect');
const maLenInput = document.getElementById('maLen');
const warnThresholdInput = document.getElementById('warnThreshold');
const badThresholdInput = document.getElementById('badThreshold');
const toggleLogBtn = document.getElementById('toggleLogBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const alarmMode = document.getElementById('alarmMode');

const timeCounter = document.getElementById('timeCounter');
const movingAvg = document.getElementById('movingAvg');
const rmsVal = document.getElementById('rmsVal');
const peakVal = document.getElementById('peakVal');
const kurtVal = document.getElementById('kurtVal');
const crestVal = document.getElementById('crestVal');
const freqResult = document.getElementById('freqResult');
const harmonicsTableBody = document.querySelector('#harmonicsTable tbody');
const aiState = document.getElementById('aiState');
const srText = document.getElementById('sr');
const fftInfo = document.getElementById('fftInfo');
const freqPerBinText = document.getElementById('freqPerBin');

const canvas = document.getElementById('spectrumCanvas');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

let alarmOsc=null; // oscillator for beep

/* ---------------- ìœ í‹¸ í•¨ìˆ˜ ---------------- */
function ampToDb(amp){
  const ref = 255;
  const a = Math.max(amp, 0.0001);
  return 20 * Math.log10(a / ref);
}
function toNormalizedTimeArray(u8){
  const out = new Float32Array(u8.length);
  for(let i=0;i<u8.length;i++) out[i] = (u8[i] - 128) / 128;
  return out;
}
function calcRMS(arr){
  let s=0; for(let i=0;i<arr.length;i++) s+=arr[i]*arr[i]; return Math.sqrt(s/arr.length);
}
function calcKurtosisFromFloat(arr){
  const n=arr.length; if(n===0) return 0;
  let mean=0; for(let i=0;i<n;i++) mean+=arr[i]; mean/=n;
  let m2=0,m4=0; for(let i=0;i<n;i++){ const d = arr[i]-mean; m2+=d*d; m4+=d*d*d*d; }
  m2/=n; m4/=n; if(m2===0) return 0; return m4/(m2*m2);
}
function calcCrest(arr){
  let peak=0; for(let i=0;i<arr.length;i++) peak = Math.max(peak, Math.abs(arr[i]));
  const rms = calcRMS(arr); return rms===0?0:(peak/rms);
}
function nowISO(){ return (new Date()).toISOString(); }

/* ---------------- ë§ˆì´í¬ ì—°ê²° ---------------- */
connectBtn.addEventListener('click', async () => {
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = Number(fftSizeSelect.value) || 4096;
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);

    micSource = audioContext.createMediaStreamSource(stream);
    micSource.connect(analyser);

    connectBtn.disabled = true; connectBtn.style.background='#999'; connectBtn.textContent='ğŸ¤ ì—°ê²°ë¨';
    startBtn.disabled = false;
    statusDiv.textContent = 'ë§ˆì´í¬ ì—°ê²° ì„±ê³µ';
    statusDiv.className = 'status success';

    srText.textContent = audioContext.sampleRate.toFixed(0) + ' Hz';
    fftInfo.textContent = analyser.fftSize;
    freqPerBinText.textContent = (audioContext.sampleRate / analyser.fftSize).toFixed(3) + ' Hz';
  }catch(err){
    statusDiv.textContent = 'ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨: ' + (err.message || err);
    statusDiv.className = 'status error';
  }
});

/* ---------------- ì‹œì‘ / ì¤‘ì§€ ---------------- */
startBtn.addEventListener('click', () => {
  if(!analyser || !audioContext){ statusDiv.textContent='ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'; statusDiv.className='status error'; return; }
  const newFft = Number(fftSizeSelect.value) || 4096;
  if(newFft !== analyser.fftSize){
    analyser.fftSize = newFft;
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);
    fftInfo.textContent = analyser.fftSize;
    freqPerBinText.textContent = (audioContext.sampleRate / analyser.fftSize).toFixed(3) + ' Hz';
  }
  isAnalyzing=true; startBtn.disabled=true; stopBtn.disabled=false;
  statusDiv.textContent='ë¶„ì„ ì¤‘...'; statusDiv.className='status info';
  startTime = performance.now(); dbHistory=[]; if(logging) logRecords = [];
  analyzeLoop();
});

stopBtn.addEventListener('click', () => {
  isAnalyzing=false; startBtn.disabled=false; stopBtn.disabled=true;
  statusDiv.textContent='ì¤‘ì§€ë¨'; statusDiv.className='status';
  if(rafId) cancelAnimationFrame(rafId);
  stopAlarm();
});

/* --------------- ë¡œê·¸ ìˆ˜ì§‘ ë° CSV --------------- */
toggleLogBtn.addEventListener('click', () => {
  logging = !logging;
  toggleLogBtn.textContent = logging ? 'ìˆ˜ì§‘ ì¤‘' : 'ìˆ˜ì§‘ ì‹œì‘';
  toggleLogBtn.style.background = logging ? '#c53030' : '#718096';
  if(logging) { logRecords = []; }
});
downloadCsvBtn.addEventListener('click', () => {
  if(logRecords.length === 0){ alert('ì €ì¥í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const header = ['timestamp_s','iso','baseFreq_Hz','defectFreq_Hz','baseAmp','baseDb','defectAmp','defectDb','diffDb','aiLabel','rmsDb','peakDb','kurtosis','crest'];
  const rows = logRecords.map(r => header.map(h => r[h]));
  const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sound_log_'+(new Date()).toISOString().replace(/[:.]/g, '-')+'.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ---------------- ì•ŒëŒ (ê°„ë‹¨ ë¹„í”„) ---------------- */
function playAlarm(){
  if(alarmMode.value === 'off' || !audioContext) return;
  if(alarmOsc) return; // ì´ë¯¸ ìš¸ë¦¼
  alarmOsc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  gain.gain.value = 0.001; // ì‹œì‘ ì‘ê²Œ
  alarmOsc.type = 'sine';
  alarmOsc.frequency.value = 880;
  alarmOsc.connect(gain);
  gain.connect(audioContext.destination);
  alarmOsc.start();
  // ramp up & down
  gain.gain.exponentialRampToValueAtTime(0.15, audioContext.currentTime + 0.02);
  setTimeout(() => {
    if(alarmOsc){
      gain.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.2);
      setTimeout(()=>{ try{ alarmOsc.stop(); alarmOsc.disconnect(); }catch(e){} alarmOsc=null; }, 250);
    }
  }, 200);
}
function stopAlarm(){ if(alarmOsc){ try{ alarmOsc.stop(); alarmOsc.disconnect(); }catch(e){} alarmOsc=null; } }

/* ---------------- ë©”ì¸ ë¶„ì„ ë£¨í”„ ---------------- */
function analyzeLoop(){
  if(!isAnalyzing) return;
  analyser.getByteFrequencyData(freqData);
  analyser.getByteTimeDomainData(timeData);

  const sr = audioContext.sampleRate;
  const fftN = analyser.fftSize;
  const freqPerBin = sr / fftN;

  const rpm = Number(rpmInput.value) || 0;
  const blade = Number(bladeInput.value) || 1;

  // ê¸°ë³¸/ê²°í•¨(7Ã—)
  const baseFreq = (rpm / 60) * blade;
  const defectFreq = baseFreq * 7;

  const baseIdx = Math.round(baseFreq / freqPerBin);
  const defectIdx = Math.round(defectFreq / freqPerBin);
  const safeIdx = i => Math.max(0, Math.min(freqData.length-1, i));

  const baseAmp = freqData[safeIdx(baseIdx)] || 0;
  const defectAmp = freqData[safeIdx(defectIdx)] || 0;
  const baseDb = ampToDb(baseAmp);
  const defectDb = ampToDb(defectAmp);
  const diffDb = Math.abs(defectDb - baseDb);

  // ì´ë™í‰ê· 
  const maLen = Number(maLenInput.value) || 10;
  dbHistory.push(diffDb); if(dbHistory.length > maLen) dbHistory.shift();
  const avgDB = dbHistory.reduce((a,b)=>a+b,0) / (dbHistory.length || 1);

  // ì‹œê°„ì˜ì—­ í†µê³„
  const tFloat = toNormalizedTimeArray(timeData);
  const rms = calcRMS(tFloat); const peak = Math.max(...tFloat.map(v => Math.abs(v)));
  const rmsDb = 20 * Math.log10(rms || 0.000001);
  const peakDb = 20 * Math.log10(peak || 0.000001);
  const kurt = calcKurtosisFromFloat(tFloat);
  const crest = calcCrest(tFloat);

  // ê³ ì¡°íŒŒ 1..7 (ê¸°ë³¸ì£¼íŒŒìˆ˜ì˜ ë°°ìˆ˜)
  const harmonics = [];
  for(let k=1;k<=7;k++){
    const hkFreq = baseFreq * k;
    const hkIdx = Math.round(hkFreq / freqPerBin);
    const amp = freqData[safeIdx(hkIdx)] || 0;
    harmonics.push({k,freq:hkFreq,amp,db:ampToDb(amp)});
  }

  // AI íŒì • (ì‚¬ìš©ì ì„ê³„ê°’)
  const warnTh = Number(warnThresholdInput.value) || 3;
  const badTh = Number(badThresholdInput.value) || 8;
  let aiLabel='ì •ìƒ', aiClass='ok';
  if(diffDb > badTh){ aiLabel='ê²°í•¨ ì˜ì‹¬'; aiClass='bad'; }
  else if(diffDb > warnTh){ aiLabel='ì£¼ì˜'; aiClass='warn'; }

  // ê²½ë³´
  if(aiLabel === 'ê²°
