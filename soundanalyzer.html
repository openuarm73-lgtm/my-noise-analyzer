<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í ë¦¬íƒ€ì´ì € ë§ˆì´í¬ ì‹¤ì‹œê°„ ì†ŒìŒ ë¶„ì„ ë° ë…¹ìŒ</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼: ëª¨ë°”ì¼ ìš°ì„  */
        body { 
            font-family: 'Malgun Gothic', 'Arial', sans-serif; 
            padding: 10px; 
            background-color: #f4f7f9;
            color: #333;
        }
        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            border: none;
            padding: 15px; 
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h2 { 
            border-bottom: 3px solid #007bff; 
            padding-bottom: 10px; 
            margin-top: 0;
            color: #007bff;
            font-size: 1.5em;
        }
        
        /* ì…ë ¥ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        input[type="number"], button { 
            margin: 8px 0; 
            padding: 12px; 
            width: 100%; 
            box-sizing: border-box; 
            border-radius: 6px;
            font-size: 1em;
            border: 1px solid #ccc;
        }
        
        /* ë²„íŠ¼ ë””ìì¸ */
        #analyzeButton {
            background-color: #28a745; /* ë…¹ìƒ‰ */
            color: white;
            border: none;
            font-weight: bold;
        }
        #analyzeButton:disabled {
            background-color: #90ee90;
        }
        #stopButton {
            background-color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
            color: white;
            border: none;
            font-weight: bold;
        }
        #stopButton:disabled {
            background-color: #ffa07a;
        }

        /* ê²½ê³  ë° ìƒíƒœ ë©”ì‹œì§€ */
        .alert-message {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #dc3545;
            border-radius: 4px;
            background-color: #f8d7da;
            font-size: 0.9em;
        }
        #status-display {
            color: #007bff;
            font-weight: bold;
            padding: 10px 0;
            border-top: 1px dashed #ddd;
            margin-top: 10px;
        }

        /* ê²°ê³¼ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #realtime-results { 
            margin-top: 25px; 
            padding: 15px; 
            background-color: #f1f1f1;
            border-radius: 8px;
        }
        .label { 
            font-weight: bold; 
            color: #555;
            margin-bottom: 10px;
            display: block;
        }
        .result-entry { 
            border-bottom: 1px solid #ddd; 
            padding: 10px 0; 
            margin-bottom: 10px; 
        }
        .result-entry:last-child { 
            border-bottom: none; 
            margin-bottom: 0; 
        }
        .diff-result {
            font-size: 1.3em; 
            color: #000;
            background-color: #ffc107; 
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        /* ë°ìŠ¤í¬í†± í™˜ê²½(768px ì´ìƒ) ìµœì í™” */
        @media (min-width: 768px) {
            .container { 
                max-width: 600px;
                padding: 30px; 
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¤ í ë¦¬íƒ€ì´ì € ë§ˆì´í¬ ì‹¤ì‹œê°„ ì†ŒìŒ ë¶„ì„ ë° ë…¹ìŒ</h2>

    <p class="alert-message">
        **ì£¼ì˜:** ì´ ê¸°ëŠ¥ì€ **HTTPS í™˜ê²½**ì—ì„œë§Œ ì‘ë™í•˜ë©°, ë¸Œë¼ìš°ì €ê°€ ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤.
        ë¶„ì„ ì¤‘ì§€ ì‹œ ë…¹ìŒëœ **WAV íŒŒì¼ ë‹¤ìš´ë¡œë“œ**ê°€ ì‹œì‘ë©ë‹ˆë‹¤.
    </p>
    
    <label class="label" for="rpm">1. RPM ì…ë ¥:</label>
    <input type="number" id="rpm" value="1200" placeholder="í ë¦¬íƒ€ì´ì € RPMì„ ì…ë ¥í•˜ì„¸ìš”" min="1">

    <button onclick="startMicrophoneAnalysis()" id="analyzeButton">2. ë§ˆì´í¬ ë…¹ìŒ ë° ë¶„ì„ ì‹œì‘</button>
    <button onclick="stopMicrophoneAnalysis()" id="stopButton" disabled>3. ë¶„ì„ ì¤‘ì§€ ë° ë…¹ìŒ ì €ì¥</button>
    
    <p id="status-display">RPMì„ ì…ë ¥í•˜ê³  'ë¶„ì„ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

    <div id="realtime-results">
        <p class="label">30ì´ˆ êµ¬ê°„ë³„ ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼:</p>
    </div>
</div>

<script>
    // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™” (ë…¹ìŒ ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€) ---
    let audioContext;
    let analyser;
    let mediaStreamSource = null;
    let mediaStream = null;
    let analysisIntervalId = null;
    let recorder = null; // NEW: MediaRecorder ê°ì²´
    let audioChunks = []; // NEW: ë…¹ìŒëœ ì˜¤ë””ì˜¤ ë°ì´í„° ì²­í¬ë¥¼ ì €ì¥í•  ë°°ì—´

    // ëˆ„ì  ë³€ìˆ˜
    let snapshotCount = 0;
    let cumulativeAmplitudeFund = 0;
    let cumulativeAmplitudePeak = 0;
    let analysisStartTime = 0; 

    const rpmInput = document.getElementById('rpm');
    const analyzeButton = document.getElementById('analyzeButton');
    const stopButton = document.getElementById('stopButton');
    const statusDisplay = document.getElementById('status-display');
    const realtimeResultsDiv = document.getElementById('realtime-results');

    // --- 2. ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ íšë“ ë° ë¶„ì„ ì‹œì‘ (ë…¹ìŒ ë¡œì§ ì¶”ê°€) ---
    async function startMicrophoneAnalysis() {
        const rpm = parseFloat(rpmInput.value);
        if (isNaN(rpm) || rpm <= 0) {
            alert('ìœ íš¨í•œ RPM ê°’ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }

        try {
            analyzeButton.disabled = true;
            statusDisplay.innerText = 'ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œ ìš”ì²­ ì¤‘...';
            
            // AudioContext ì´ˆê¸°í™” (ì‚¬ìš©ì ìƒí˜¸ ì‘ìš© í›„ ìƒì„±)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
            }

            // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ íšë“
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // --- NEW: MediaRecorder ì„¤ì • ë° ì‹œì‘ ---
            audioChunks = [];
            
            // WAV í¬ë§·ì„ ì„ í˜¸í•˜ë©°, ì§€ì›í•˜ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì € ê¸°ë³¸ í¬ë§·(ì˜ˆ: WebM) ì‚¬ìš©
            if (MediaRecorder.isTypeSupported('audio/wav')) {
                recorder = new MediaRecorder(mediaStream, { mimeType: 'audio/wav' });
            } else {
                recorder = new MediaRecorder(mediaStream);
                console.warn('WAV í¬ë§·ì´ ì§€ì›ë˜ì§€ ì•Šì•„ ê¸°ë³¸ ì˜¤ë””ì˜¤ í¬ë§·ìœ¼ë¡œ ë…¹ìŒë©ë‹ˆë‹¤.');
            }
            
            recorder.ondataavailable = (event) => {
                // ë…¹ìŒ ë°ì´í„°ê°€ ìƒê¸¸ ë•Œë§ˆë‹¤ ë°°ì—´ì— ì¶”ê°€
                audioChunks.push(event.data);
            };

            recorder.onstop = () => {
                // ë…¹ìŒì´ ë©ˆì¶”ë©´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ì‹¤í–‰
                downloadWAV();
            };
            
            recorder.start(); // ë…¹ìŒ ì‹œì‘
            statusDisplay.innerText = 'ë§ˆì´í¬ ì—°ê²° ì„±ê³µ. ë…¹ìŒ ë° ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.';
            // --- END NEW ---


            // ë…¸ë“œ ìƒì„± ë° ì—°ê²°: ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ -> Analyser -> Destination 
            mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);
            mediaStreamSource.connect(analyser);
            mediaStreamSource.connect(audioContext.destination); 
            
            // ë¶„ì„ ì‹œì‘ ì „ ì´ˆê¸°í™”
            cumulativeAmplitudeFund = 0;
            cumulativeAmplitudePeak = 0;
            snapshotCount = 0;
            realtimeResultsDiv.innerHTML = '<p class="label">30ì´ˆ êµ¬ê°„ë³„ ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼:</p>';
            analysisStartTime = audioContext.currentTime;
            
            // ì£¼íŒŒìˆ˜ ê³„ì‚°
            const F_fund = (rpm / 60) * 20;
            const F_peak = F_fund * 7;

            // ì‹¤ì‹œê°„ ë¶„ì„ ë£¨í”„ ì‹œì‘
            realtimeAnalysisLoop(F_fund, F_peak);
            
            stopButton.disabled = false;

        } catch (error) {
            console.error('ë§ˆì´í¬ ì ‘ê·¼ ë˜ëŠ” ë¶„ì„ ì˜¤ë¥˜:', error);
            statusDisplay.innerText = `ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜: ${error.name}. HTTPS í™˜ê²½ì¸ì§€, ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`;
            analyzeButton.disabled = false;
        }
    }

    // --- 3. ë¶„ì„ ì¤‘ì§€ í•¨ìˆ˜ (ë…¹ìŒ ì¤‘ì§€ ë¡œì§ ì¶”ê°€) ---
    function stopMicrophoneAnalysis() {
        if (analysisIntervalId) cancelAnimationFrame(analysisIntervalId);
        analysisIntervalId = null;
        
        // --- NEW: ë…¹ìŒ ì¤‘ì§€ ë° ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±° ---
        if (recorder && recorder.state !== 'inactive') {
            // .stop()ì„ í˜¸ì¶œí•˜ë©´ onstop ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê³  downloadWAV() í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
            recorder.stop(); 
            statusDisplay.innerText = "ë¶„ì„ ì¤‘ì§€ë¨. WAV íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...";
        } else {
             statusDisplay.innerText = "ë¶„ì„ ì¤‘ì§€ë¨.";
        }
        // --- END NEW ---

        // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ í•´ì œ
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        
        // ì˜¤ë””ì˜¤ ë…¸ë“œ ì—°ê²° í•´ì œ
        if (mediaStreamSource) {
            mediaStreamSource.disconnect();
            mediaStreamSource = null;
        }

        // ë§ˆì§€ë§‰ ë‚¨ì€ êµ¬ê°„ ë°ì´í„° ì²˜ë¦¬
        if (snapshotCount > 0) {
            const rpm = parseFloat(rpmInput.value);
            const F_fund = (rpm / 60) * 20;
            const F_peak = F_fund * 7;
            calculateAndDisplayResult(F_fund, F_peak, audioContext.currentTime, true);
        }
        
        // AudioContext ì•ˆì „í•˜ê²Œ ë‹«ê¸°
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close().then(() => {
                audioContext = null;
                analyser = null;
            });
        }

        analyzeButton.disabled = false;
        stopButton.disabled = true;
    }

    // --- 4. WAV íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (NEW) ---
    function downloadWAV() {
        if (audioChunks.length === 0) {
            console.error('ë…¹ìŒëœ ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë…¹ìŒëœ ì‹¤ì œ MIME íƒ€ì…ì„ ê¸°ë°˜ìœ¼ë¡œ Blob ìƒì„±
        const mimeType = recorder ? recorder.mimeType : 'audio/webm'; 
        const fileExtension = mimeType.includes('wav') ? 'wav' : (mimeType.includes('webm') ? 'webm' : 'dat'); // íŒŒì¼ í™•ì¥ì ê²°ì •

        const audioBlob = new Blob(audioChunks, { type: mimeType }); 
        const audioUrl = URL.createObjectURL(audioBlob);
        
        const link = document.createElement('a');
        link.href = audioUrl;
        // íŒŒì¼ëª…: í ë¦¬íƒ€ì´ì €_ì†ŒìŒ_ë¶„ì„_YYYY-MM-DD_HHMM.í™•ì¥ì
        link.download = `í ë¦¬íƒ€ì´ì €_ì†ŒìŒ_ë¶„ì„_${new Date().toISOString().slice(0, 16).replace('T', '_')}.${fileExtension}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(audioUrl);
        
        setTimeout(() => {
             statusDisplay.innerText = `ë¶„ì„ ì¤‘ì§€ë¨. ì˜¤ë””ì˜¤ íŒŒì¼(${fileExtension}) ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
        }, 500);

    }
    // --- 5. ì£¼íŒŒìˆ˜ ë²”ìœ„ ì§„í­ í‰ê·  ê³„ì‚° ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    function getAvgAmplitudeInRange(targetFrequency, dataArray, sampleRate, fftSize) {
        const range = targetFrequency * 0.03;
        const lowerFreq = targetFrequency - range;
        const upperFreq = targetFrequency + range;
        
        const binResolution = sampleRate / fftSize;
        
        let startIndex = Math.floor(lowerFreq / binResolution);
        let endIndex = Math.ceil(upperFreq / binResolution);
        
        startIndex = Math.max(0, startIndex);
        endIndex = Math.min(dataArray.length - 1, endIndex);
        
        if (startIndex >= endIndex || endIndex >= dataArray.length) {
            return null;
        }

        let sumAmplitude = 0;
        let count = 0;
        
        for (let i = startIndex; i <= endIndex; i++) {
            sumAmplitude += dataArray[i];
            count++;
        }

        return sumAmplitude / count;
    }

    // --- 6. ì‹¤ì‹œê°„ ë¶„ì„ ë£¨í”„ ë° ê²°ê³¼ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    function calculateAndDisplayResult(F_fund, F_peak, currentTime, isFinal = false) {
        if (snapshotCount === 0) return;

        const avgFund = cumulativeAmplitudeFund / snapshotCount;
        const avgPeak = cumulativeAmplitudePeak / snapshotCount;
        const difference = avgPeak - avgFund;

        const endSec = Math.floor(currentTime);
        const startSec = isFinal ? Math.floor(analysisStartTime) : Math.floor(currentTime - 30); 

        const newEntry = document.createElement('div');
        newEntry.classList.add('result-entry');

        newEntry.innerHTML = `
            <p>--- <strong>[${startSec}s ~ ${endSec}s]</strong> ë¶„ì„ ê²°ê³¼ ${isFinal ? '(ìµœì¢… êµ¬ê°„)' : ''} ---</p>
            <p class="diff-result">ì§„í­ ì°¨ì´ (Peak - Fund): <strong>${difference.toFixed(2)} dB</strong></p>
            <p>ê¸°ë³¸ ì£¼íŒŒìˆ˜(${F_fund.toFixed(2)} Hz) í‰ê·  ì§„í­: ${avgFund.toFixed(2)} dB</p>
            <p>í”¼í¬ ì£¼íŒŒìˆ˜(${F_peak.toFixed(2)} Hz) í‰ê·  ì§„í­: ${avgPeak.toFixed(2)} dB</p>
        `;
        
        const resultsContainer = document.getElementById('realtime-results');
        if (resultsContainer.children.length > 0) {
            resultsContainer.insertBefore(newEntry, resultsContainer.children[1]); 
        } else {
            resultsContainer.appendChild(newEntry);
        }
        
        cumulativeAmplitudeFund = 0;
        cumulativeAmplitudePeak = 0;
        snapshotCount = 0;
        analysisStartTime = currentTime;
    }

    function realtimeAnalysisLoop(F_fund, F_peak) {
        if (!analyser || !audioContext || audioContext.state === 'closed') return;

        const dataArray = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatFrequencyData(dataArray); 

        const sampleRate = audioContext.sampleRate;
        const fftSize = analyser.fftSize;

        const currentAmpFund = getAvgAmplitudeInRange(F_fund, dataArray, sampleRate, fftSize);
        const currentAmpPeak = getAvgAmplitudeInRange(F_peak, dataArray, sampleRate, fftSize);

        if (currentAmpFund !== null && currentAmpPeak !== null) {
            cumulativeAmplitudeFund += currentAmpFund;
            cumulativeAmplitudePeak += currentAmpPeak;
            snapshotCount++;
        }

        const currentTime = audioContext.currentTime;
        const elapsedSinceStart = currentTime - analysisStartTime;

        if (elapsedSinceStart >= 30) {
            calculateAndDisplayResult(F_fund, F_peak, currentTime, false);
        }

        analysisIntervalId = requestAnimationFrame(() => realtimeAnalysisLoop(F_fund, F_peak));
    }
</script>
</body>
</html>