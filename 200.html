<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>í ë¦¿íƒ€ì´ì € ë§ˆëª¨ ì§€ìˆ˜ ë¶„ì„ê¸°</title>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
    background:#0a0a14;color:#eee;
    padding:12px;
  }
  .container{
    max-width:1000px;margin:0 auto;background:#141622;
    border-radius:14px;padding:14px;box-shadow:0 0 20px rgba(0,0,0,0.4)
  }
  h1{text-align:center;font-size:1.3rem;margin-bottom:14px;color:#fff}

  /* PC = 2ì—´ / ëª¨ë°”ì¼ = 1ì—´ */
  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:14px;
  }
  @media(max-width:850px){
    .grid{grid-template-columns:1fr;}
  }

  .panel{background:#1e2030;padding:14px;border-radius:10px}

  label{display:block;margin-top:10px;font-weight:600;margin-bottom:6px;font-size:0.95rem}

  input,select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #333;
    background:#0f1018;color:#eee;font-size:1rem;
  }

  button{
    width:100%;padding:12px;margin-top:10px;border:none;
    border-radius:10px;background:#3a6df0;color:#fff;
    font-size:1.05rem;font-weight:700;cursor:pointer;
  }
  button:disabled{background:#555}

  .status{
    margin-top:12px;padding:10px;border-radius:8px;font-size:0.9rem;
  }
  .success{background:#1f402f;color:#9ff7c0;}
  .error{background:#402727;color:#ff9d9d;}
  .info{background:#3a3a18;color:#fff7a8;}
  .warn{background:#774a00; color:#fff;} /* ê²½ê³ ìƒ‰ ë³€ê²½ */

  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .kpi-item{
    background:#10111a;padding:8px;border-radius:8px;
    box-shadow:0 0 8px rgba(0,0,0,0.4);min-width:110px
  }
  
  /* ë§ˆëª¨ ì§€ìˆ˜ ê°•ì¡° */
  #wearIndexBox{
      background:#8b4513; /* ì£¼í™©ìƒ‰ ê³„ì—´ë¡œ ê°•ì¡° */
      padding:12px; border-radius:10px;
      margin-top:12px; text-align:center;
      box-shadow: 0 0 15px rgba(255,140,0,0.5);
  }
  #wearIndexBox h2{
      font-size: 1.1rem; color: #fff; margin-bottom: 4px;
  }
  #wearIndex{
      font-size: 2.2rem; font-weight: 800; color: #ffeb3b;
      text-shadow: 1px 1px 5px #000;
  }


  /* ìº”ë²„ìŠ¤ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  canvas{
    width:100%;
    border-radius:10px;
    background:#000;
  }
  
  /* ê°œë³„ ìº”ë²„ìŠ¤ ë†’ì´ ì„¤ì • */
  #spectrumCanvas{ height: 250px; cursor: grab; } 
  #timeCanvas{ height: 100px; margin-top: 8px; }
  #spectrogramCanvas{ height: 200px; }

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.9rem}
  th,td{padding:6px;border-bottom:1px solid #333}

  .badge{
    padding:4px 10px;border-radius:999px;color:white;font-weight:700;
  }
  .ok{background:#2fa86d}
  .warn{background:#e49b23}
  .bad{background:#e64545}

  /* ëª¨ë°”ì¼ì—ì„œë„ ì ˆëŒ€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” AI ë°•ìŠ¤ */
  #aiBox{
    height:120px;overflow:hidden;margin-top:12px;
    background:#11131d;border-radius:10px;padding:10px;
  }
  #aiState{
    height:34px;display:flex;align-items:center;
    overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
    margin-bottom:8px;
  }
  #aiNote{
    height:70px;display:flex;align-items:center;
    overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
    font-size:0.9rem;color:#ddd;
  }

  #tooltip{
    position:absolute;background:rgba(0,0,0,0.8);color:#fff;
    padding:6px;border-radius:6px;font-size:0.85rem;display:none;
    pointer-events:none;z-index:10;
  }

</style>
</head>
<body>

<div class="container">
<h1>ğŸ­ í ë¦¿íƒ€ì´ì € ë§ˆëª¨ ì§€ìˆ˜ ë¶„ì„ê¸°</h1>

<div class="grid">

<div class="panel">

  <div id="wearIndexBox">
      <h2>7x í•˜ëª¨ë‹‰ ë§ˆëª¨ ì§€ìˆ˜ (dB)</h2>
      <div id="wearIndex">-</div>
  </div>

  <label style="margin-top:14px">RPM</label>
  <input type="number" id="rpmInput" value="1500">

  <label>ë¸”ë ˆì´ë“œ ìˆ˜ (1x ê¸°ë³¸ ì£¼íŒŒìˆ˜ ê²°ì •)</label>
  <input type="number" id="bladeCountInput" value="20">
  
  <label>ì£¼ìš” ë§ˆëª¨ ì£¼íŒŒìˆ˜ ë°°ìˆ˜ (NÃ—)</label>
  <input type="number" id="wearMultipleInput" value="7">

  <label>FFT í¬ê¸°</label>
  <select id="fftSizeSelect">
    <option value="2048">2048</option>
    <option value="4096" selected>4096</option>
    <option value="8192">8192</option>
  </select>

  <label style="margin-top:14px">AI dB ì„ê³„ê°’ (ì£¼ì˜/ê²°í•¨)</label>
  <div style="display:flex;gap:8px">
    <input type="number" id="warnThreshold" value="3">
    <input type="number" id="badThreshold" value="8">
  </div>
  
  <button id="connectBtn">ğŸ¤ ë§ˆì´í¬ ì—°ê²°</button>
  <button id="startButton" disabled>â–¶ ë¶„ì„ ì‹œì‘</button>
  <button id="stopButton" disabled>â¹ ì¤‘ì§€</button>
  
  <button id="saveRefBtn" style="background:#8b4513; margin-top: 6px;">ğŸŒŸ ê¸°ì¤€ ìŠ¤í™íŠ¸ëŸ¼ ì €ì¥</button>
  <div id="status" class="status info">ëŒ€ê¸° ì¤‘â€¦</div>

  <div class="panel" style="margin-top:12px">
    <div><b>ì£¼ìš” í•˜ëª¨ë‹‰ í˜„í™©</b></div>
    <div id="freqResult" style="margin:6px 0; font-size:0.9rem;"></div>
    <div id="aiBox">
      <div id="aiState"><span class="badge ok">ë¶„ì„ ëŒ€ê¸°</span></div>
      <div id="aiNote">AI ëŒ€ê¸° ì¤‘â€¦</div>
    </div>
  </div>
  
  <div class="kpi">
    <div class="kpi-item"><div>ì‹œê°„</div><b id="timeCounter">0</b></div>
    <div class="kpi-item"><div>RMS dB</div><b id="rmsVal">-</b></div>
    <div class="kpi-item"><div>Kurtosis</div><b id="kurtVal">-</b></div>
    <div class="kpi-item"><div>Crest</div><b id="crestVal">-</b></div>
  </div>
  
  <button id="resetZoomBtn" style="background:#555; margin-top: 12px;">ğŸ” í™•ëŒ€/ì´ë™ ì´ˆê¸°í™”</button>
</div>

<div class="panel">
  <div style="font-size:0.9rem">ì‹¤ì‹œê°„ FFT ìŠ¤í™íŠ¸ëŸ¼ (3kHz ~ 6kHz ì§‘ì¤‘)</div>
  <div style="position:relative;margin-top:8px">
    <canvas id="spectrumCanvas" style="cursor: grab;"></canvas>
    <div id="tooltip"></div>
    <div style="font-size:0.8rem; color:#00e0ff; position:absolute; top:2px; left:2px;">ì‹¤ì‹œê°„</div>
    <div style="font-size:0.8rem; color:#ffaa00; position:absolute; top:16px; left:2px;">Peak Hold</div>
    <div style="font-size:0.8rem; color:#44ff44; position:absolute; top:30px; left:2px;">ê¸°ì¤€</div>
    <div style="font-size:0.8rem; color:orange; position:absolute; top:44px; left:2px;">NÃ— (ì£¼ìš” ë§ˆëª¨)</div>
  </div>

  <div style="font-size:0.9rem; margin-top: 12px;">ì‹œê°„ íŒŒí˜• (Time Waveform)</div> 
  <canvas id="timeCanvas"></canvas>

  <div style="position:relative;margin-top:0">
    <canvas id="spectrogramCanvas"></canvas>
  </div>
  
  <div style="font-size:0.9rem; margin-top: 12px;">í•˜ëª¨ë‹‰ ìƒì„¸ ëª©ë¡ (1x ~ 14x)</div>
    <table>
      <thead><tr><th>ë°°ìˆ˜</th><th>Hz</th><th>Amp</th><th>dB</th><th>NÃ—ëŒ€ë¹„</th></tr></thead>
      <tbody id="harmonicsTable"></tbody>
    </table>

</div>

</div>
</div>

<script>
/* =========================================================
   í ë¦¿íƒ€ì´ì € ì „ë¬¸ ë¶„ì„ ë¡œì§
   ========================================================= */

let audioContext, analyser, source;
let freqData, timeData;
let isRun=false;
let raf;

// í ë¦¿íƒ€ì´ì € ì „ìš© ìƒíƒœ ì €ì¥ ë³€ìˆ˜
let prevWearDb = null; // ì´ì „ 7x(NÃ—) dB ê°’
let prevBaseDb = null; // ì´ì „ 1x dB ê°’
let prevWearMultipleAmp = null; // ì´ì „ NÃ— ì§„í­
let prevDoubleWearMultipleAmp = null; // ì´ì „ 2NÃ— ì§„í­

// ê³ ê¸‰ ê¸°ëŠ¥ ë°ì´í„°
let peakHoldData = []; 
let referenceSpectrumData = null;

// ì¤Œ/íŒ¬ ìƒíƒœ ë³€ìˆ˜
let viewStartIndex = 0;
let viewEndIndex = 0;
let isPanning = false;
let lastPanX = 0;

/* UI GET */
const rpmIn = _id('rpmInput');
const bladeIn = _id('bladeCountInput');
const wearMultIn = _id('wearMultipleInput'); // NÃ— ë§ˆëª¨ ë°°ìˆ˜ ì…ë ¥
const fftIn = _id('fftSizeSelect');

const btnMic = _id('connectBtn');
const btnStart = _id('startButton');
const btnStop = _id('stopButton');
const saveRefBtn = _id('saveRefBtn');
const resetZoomBtn = _id('resetZoomBtn');

const statusBox = _id('status');
const warnIn = _id('warnThreshold');
const badIn = _id('badThreshold');

const timeBox = _id('timeCounter');
const rmsBox = _id('rmsVal');
const kurtBox = _id('kurtVal');
const crestBox = _id('crestVal'); 
const wearIndexBox = _id('wearIndex'); // 7x í•˜ëª¨ë‹‰ ì§€ìˆ˜ í‘œì‹œ

const freqRes = _id('freqResult');
const harmTable = _id('harmonicsTable');

const aiState = _id('aiState');
const aiNote  = _id('aiNote');

// ìº”ë²„ìŠ¤
const canvas = _id('spectrumCanvas');
const ctx = canvas.getContext('2d');
const tooltip = _id('tooltip');
const timeCanvas = _id('timeCanvas');
const timeCtx = timeCanvas.getContext('2d');
const specCanvas = _id('spectrogramCanvas');
const specCtx = specCanvas.getContext('2d');

function _id(x){return document.getElementById(x);}

/* ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • */
function setCanvasSize() {
  const containerWidth = canvas.parentNode.clientWidth;
  
  canvas.width = containerWidth;
  timeCanvas.width = containerWidth;
  specCanvas.width = containerWidth;
}
setCanvasSize();
window.addEventListener('resize', setCanvasSize); 


/* ---------- ë§ˆì´í¬ ì—°ê²° ---------- */
btnMic.onclick = async ()=>{
  try{
    let stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext = new (window.AudioContext||window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = Number(fftIn.value);
    
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);
    
    // ì¤Œ ë²”ìœ„ ì´ˆê¸°í™” (3kHz ~ 6kHzì— ë§ì¶˜ ì´ˆê¸° ì¤Œì„ ìœ„í•´ Nyquist ì£¼íŒŒìˆ˜(SR/2)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°)
    const sr = audioContext.sampleRate;
    const bin = sr / analyser.fftSize;
    const startHz = 0; // ì´ˆê¸°ê°’ì€ 0ìœ¼ë¡œ ì„¤ì •
    const endHz = 8000; // 3kHz~6kHz í¬í•¨, ìµœëŒ€ 8kHzê¹Œì§€ ë³´ì¥
    
    viewStartIndex = Math.round(startHz / bin);
    viewEndIndex = Math.min(analyser.frequencyBinCount, Math.round(endHz / bin));
    
    // Peak Hold & Reference ì´ˆê¸°í™”
    peakHoldData = new Uint8Array(analyser.frequencyBinCount);
    referenceSpectrumData = null;

    source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);

    btnMic.disabled=true; btnMic.innerText="ğŸ¤ ì—°ê²°ë¨";
    btnStart.disabled=false;
    statusBox.className="status success";
    statusBox.innerText="ë§ˆì´í¬ ì—°ê²° ì™„ë£Œ";
  }catch(e){
    statusBox.className="status error";
    statusBox.innerText="ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨: "+e;
  }
};

/* ---------- ë¶„ì„ ì‹œì‘ ---------- */
btnStart.onclick = ()=>{
  if(!audioContext) return;
  isRun=true;
  btnStart.disabled=true;
  btnStop.disabled=false;
  
  statusBox.className="status info";
  statusBox.innerText="ë¶„ì„ ì¤‘â€¦";
  
  t0=performance.now();
  
  // ì´ˆê¸°í™”
  if (analyser) {
    peakHoldData = new Uint8Array(analyser.frequencyBinCount);
  }
  specCtx.fillStyle = '#0a0a14'; 
  specCtx.fillRect(0, 0, specCanvas.width, specCanvas.height);
  timeCtx.fillStyle = '#0a0a14';
  timeCtx.fillRect(0, 0, timeCanvas.width, timeCanvas.height);
  
  loop();
};

/* ---------- ì¤‘ì§€ ---------- */
btnStop.onclick = ()=>{
  isRun=false; 
  btnStart.disabled=false; 
  btnStop.disabled=true;
  statusBox.innerText="ë¶„ì„ ì¤‘ì§€ë¨.";
};

/* ---------- ê¸°ì¤€ ìŠ¤í™íŠ¸ëŸ¼ ì €ì¥ ---------- */
saveRefBtn.onclick = () => {
    if (!freqData || !isRun) {
        statusBox.className = 'status warn';
        statusBox.innerText = 'ë¶„ì„ ì‹œì‘ í›„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        return;
    }
    referenceSpectrumData = new Uint8Array(freqData); 
    statusBox.className = 'status info';
    statusBox.innerText = 'ê¸°ì¤€ ìŠ¤í™íŠ¸ëŸ¼(ë…¹ìƒ‰)ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
};

/* ---------- ì¤Œ ì´ˆê¸°í™” ---------- */
resetZoomBtn.onclick = () => {
    if (analyser) {
        const sr = audioContext.sampleRate;
        const bin = sr / analyser.fftSize;
        viewStartIndex = Math.round(0 / bin);
        viewEndIndex = Math.min(analyser.frequencyBinCount, Math.round(8000 / bin)); // 8kHzê¹Œì§€ ì´ˆê¸°í™”
        statusBox.className = 'status info';
        statusBox.innerText = 'í™•ëŒ€/ì´ë™ì´ 0Hz ~ 8kHzë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
};


/* ---------- ë¶„ì„ ë£¨í”„ ---------- */
let t0=0;
function loop(){
  if(!isRun) return; 

  analyser.getByteFrequencyData(freqData);
  analyser.getByteTimeDomainData(timeData);
  
  // Peak Hold ì—…ë°ì´íŠ¸
  if (peakHoldData.length !== freqData.length) {
      peakHoldData = [...freqData];
  } else {
      for (let i = 0; i < freqData.length; i++) {
          if (freqData[i] > peakHoldData[i]) {
              peakHoldData[i] = freqData[i];
          }
      }
  }

  /* RPM ë° ì£¼íŒŒìˆ˜ ê³„ì‚° */
  let sr = audioContext.sampleRate;
  let fftN = analyser.fftSize;
  let bin = sr/fftN;

  let rpm = Number(rpmIn.value);
  let blade = Number(bladeIn.value);
  let wearM = Number(wearMultIn.value); // N (ì£¼ìš” ë§ˆëª¨ ë°°ìˆ˜)
  let maxMul = 14; // í…Œì´ë¸” í‘œì‹œëŠ” ìµœëŒ€ 14xê¹Œì§€

  let baseHz = (rpm/60)*blade;
  let wearHz = baseHz * wearM;
  let doubleWearHz = baseHz * (wearM * 2);

  let baseI = Math.round(baseHz/bin);
  let wearI = Math.round(wearHz/bin);
  let doubleWearI = Math.round(doubleWearHz/bin);

  let baseAmp = freqData[clamp(baseI)];
  let wearAmp  = freqData[clamp(wearI)];
  let doubleWearAmp  = freqData[clamp(doubleWearI)];

  let baseDb = ampToDb(baseAmp);
  let wearDb  = ampToDb(wearAmp);
  let doubleWearDb  = ampToDb(doubleWearAmp);

  let wearDiffDb = wearDb - baseDb; // ğŸ”¥ í•µì‹¬ ë§ˆëª¨ ì§€ìˆ˜: NÃ—(7Ã—) dB - 1Ã— dB

  /* RMS, Kurtosis, Crest */
  let tArr = floatNorm(timeData);
  let rms = rmsCalc(tArr);
  let rmsDb = 20*Math.log10(rms||1e-8);
  let kurt = kurtCalc(tArr);
  let crest = crestCalc(tArr);

  /* ê³ ì¡°íŒŒ í…Œì´ë¸” ë°ì´í„° */
  let hList=[];
  for(let k=1;k<=maxMul;k++){
    let f = baseHz*k;
    let idx=Math.round(f/bin);
    let a=freqData[clamp(idx)];
    let db = ampToDb(a);
    let ratioToWear = (wearDb > -100) ? (db - wearDb) : 0; // NÃ— ëŒ€ë¹„ dB ì°¨ì´
    hList.push({k,f,a,db,ratioToWear});
  }


  /* ğŸ”¥ AI íŒì • ë¡œì§: í ë¦¿íƒ€ì´ì € ì „ë¬¸ íŒì • */
  let aiL="ì •ìƒ", aiC="ok", msg="";

  let warnT=Number(warnIn.value); // ì˜ˆ: 3 dB
  let badT=Number(badIn.value);  // ì˜ˆ: 8 dB

  // 1. ê³¼ë„í•œ ë§ˆëª¨/ê³¼ì••ë ¥ íŒì •
  if(wearDiffDb > badT){ 
      aiL="ê²°í•¨ ì˜ì‹¬ / ê³¼ì••ë ¥"; aiC="bad"; msg=`NÃ— í•˜ëª¨ë‹‰ ì§€ìˆ˜ ${wearDiffDb.toFixed(2)} dB (ê¸°ì¤€ ${badT} ì´ˆê³¼)`; 
  }
  else if(wearDiffDb > warnT){ 
      aiL="ì£¼ì˜ / ê³ ì••ë ¥"; aiC="warn"; msg=`NÃ— í•˜ëª¨ë‹‰ ì§€ìˆ˜ ${wearDiffDb.toFixed(2)} dB (ê¸°ì¤€ ${warnT} ì´ˆê³¼)`; 
  }
  else {
      msg=`NÃ— ì§€ìˆ˜ ${wearDiffDb.toFixed(2)} dB, ì•ˆì • ë²”ìœ„`;
  }

  // 2. ì••ë ¥ ê°ì†Œ íŒ¨í„´ íŒì • (ë¯¸ëŠ” ì••ë ¥ ê°ì†Œ ì‹œ 7xê°€ ë¨¼ì € ë‚®ì•„ì§€ëŠ” í˜„ìƒ)
  if(prevWearDb !== null && prevBaseDb !== null){
      const wearDrop = prevWearDb - wearDb;
      const baseDrop = prevBaseDb - baseDb;
      
      // NÃ— (7x) dBê°€ 3dB ì´ìƒ í•˜ë½í–ˆê³ , 1x í•˜ë½ë³´ë‹¤ NÃ— í•˜ë½ì´ ë” í° ê²½ìš° (ì••ë ¥ ê°ì†Œ ì‹œê·¸ë„)
      if(wearDrop > 3 && wearDrop > baseDrop){
        
        // 14x(2NÃ—)ê°€ 7x(NÃ—) ëŒ€ë¹„ ìƒëŒ€ì ìœ¼ë¡œ ì»¤ ë³´ì´ëŠ”ì§€ í™•ì¸ (ì§„í­ ë¹„ìœ¨ ì‚¬ìš©)
        const wearAmpToDoubleRatio = wearAmp > 0 ? doubleWearAmp / wearAmp : 0;
        
        if (wearAmpToDoubleRatio > 2) { // 2ë°° ì´ìƒì´ë©´ ìƒëŒ€ì ìœ¼ë¡œ í¬ë‹¤ê³  ê°„ì£¼
             aiL="ì •ìƒ (ì••ë ¥ ê°ì†Œ íŒ¨í„´)"; 
             aiC="ok"; 
             msg=`NÃ— í•˜ë½ í™•ì¸ (${wearDrop.toFixed(1)}dBâ†“). 2NÃ—/NÃ— ë¹„ìœ¨ ${wearAmpToDoubleRatio.toFixed(1)}ë¡œ ì •ìƒ íŒ¨í„´.`;
        } else {
             aiL="ì£¼ì˜ (NÃ— í•˜ë½)";
             aiC="warn";
             msg=`NÃ— í•˜ë½ í™•ì¸ (${wearDrop.toFixed(1)}dBâ†“). ë¯¸ëŠ” í˜ ê°ì†Œ ìƒíƒœ í™•ì¸ í•„ìš”.`;
        }
      }
  }


  /* UI ì—…ë°ì´íŠ¸ */
  timeBox.innerText = Math.floor((performance.now()-t0)/1000)+"s";
  rmsBox.innerText = rmsDb.toFixed(2)+" dB";
  kurtBox.innerText = kurt.toFixed(2);
  crestBox.innerText = crest.toFixed(2);
  wearIndexBox.innerText = wearDiffDb.toFixed(2)+" dB"; // ğŸ”¥ í•µì‹¬ ì§€ìˆ˜

  freqRes.innerHTML =
    `1Ã— (ê¸°ë³¸): ${Math.round(baseHz)}Hz / ${baseDb.toFixed(2)}dB<br>`+
    `${wearM}Ã— (ë§ˆëª¨): ${Math.round(wearHz)}Hz / ${wearDb.toFixed(2)}dB<br>`+
    `${wearM*2}Ã—: ${Math.round(doubleWearHz)}Hz / ${doubleWearDb.toFixed(2)}dB`;

  aiState.innerHTML=`<span class="badge ${aiC}">${aiL}</span>`;
  aiNote.innerText=msg||"";

  harmTable.innerHTML="";
  hList.forEach(h=>{
    // NÃ— ë° 2NÃ—ëŠ” íŠ¹ë³„íˆ ê°•ì¡°
    let style = "";
    if (h.k === wearM) style = 'style="background:#8b4513; color:#fff;"';
    if (h.k === wearM * 2) style = 'style="background:#5e326b; color:#fff;"'; // 14xëŠ” ë³´ë¼ìƒ‰

    harmTable.innerHTML+=`<tr ${style}><td>${h.k}Ã—</td><td>${Math.round(h.f)}</td><td>${h.a}</td><td>${h.db.toFixed(2)}</td><td>${h.ratioToWear.toFixed(2)}</td></tr>`;
  });

  /* ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° */
  drawFFT(freqData);
  drawSpectrogram(freqData);
  drawTimeWaveform(timeData);

  /* prev ì—…ë°ì´íŠ¸ */
  prevWearDb = wearDb;
  prevBaseDb = baseDb;
  prevWearMultipleAmp = wearAmp;
  prevDoubleWearMultipleAmp = doubleWearAmp;

  raf=requestAnimationFrame(loop);
}

/* ---------- ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ë¡œì§ ìœ ì§€) ---------- */

/* ì‹œê°„ íŒŒí˜• ê·¸ë¦¬ê¸° */
function drawTimeWaveform(arr) {
    const w = timeCanvas.width;
    const h = timeCanvas.height;
    timeCtx.clearRect(0, 0, w, h);
    timeCtx.fillStyle = "#0a0a14";
    timeCtx.fillRect(0, 0, w, h);
    
    timeCtx.beginPath();
    timeCtx.moveTo(0, h / 2);
    timeCtx.lineTo(w, h / 2);
    timeCtx.strokeStyle = "#555";
    timeCtx.lineWidth = 1;
    timeCtx.stroke();
    
    timeCtx.beginPath();
    timeCtx.strokeStyle = "#4aaaff";
    timeCtx.lineWidth = 2;
    
    const bufferLength = arr.length;
    let x = 0;
    const sliceWidth = w * 1.0 / bufferLength;
    
    for(let i = 0; i < bufferLength; i++) {
        const v = arr[i] / 255.0; 
        const y = v * h; 

        if(i === 0) {
            timeCtx.moveTo(x, y);
        } else {
            timeCtx.lineTo(x, y);
        }

        x += sliceWidth;
    }
    timeCtx.stroke();
}

/* ìŠ¤í™íŠ¸ë¡œê·¸ë¨ ê·¸ë¦¬ê¸° (ì¤Œ/íŒ¬ ì ìš©) */
function drawSpectrogram(arr) {
    const specWidth = specCanvas.width;
    const specHeight = specCanvas.height;
    
    specCtx.drawImage(specCanvas, 0, 1); 

    const yPos = 0; 
    specCtx.fillStyle = '#0a0a14'; 
    specCtx.fillRect(0, yPos, specWidth, 1); 

    const numBins = arr.length; 
    const startIdx = viewStartIndex;
    const endIdx = viewEndIndex;
    const viewRange = endIdx - startIdx;

    for (let x = 0; x < specWidth; x++) { 
        const binFraction = (x / specWidth) * viewRange + startIdx; 
        let binIndex = Math.floor(binFraction);
        
        binIndex = Math.min(numBins - 1, Math.max(0, binIndex));

        const amplitude = arr[binIndex];
        const color = ampToHeatmap(amplitude);
        
        specCtx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;
        specCtx.fillRect(x, yPos, 1, 1); 
    }
    
    specCtx.fillStyle = '#0a0a14'; 
    specCtx.fillRect(0, specHeight - 1, specWidth, 1); 
}

/* FFT ê·¸ë¦¬ê¸° (ì¤Œ/íŒ¬, Peak Hold, ê¸°ì¤€ì„ , í•˜ëª¨ë‹‰ ê°•ì¡°) */
function drawFFT(arr){ 
  let w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);

  const wearM = Number(wearMultIn.value); // N (ì£¼ìš” ë§ˆëª¨ ë°°ìˆ˜)
  
  const startIdx = viewStartIndex;
  const endIdx = viewEndIndex;
  const viewRange = endIdx - startIdx;

  const drawLine = (data, color, lineWidth) => {
    ctx.beginPath();
    for(let i=startIdx;i<endIdx;i++){
        const x=(i-startIdx)/viewRange*w;
        const y=h - (data[i]/255)*h;
        if(i===startIdx) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.strokeStyle=color;
    ctx.lineWidth=lineWidth;
    ctx.stroke();
  };

  // 1. ê¸°ì¤€ ìŠ¤í™íŠ¸ëŸ¼ (ë…¹ìƒ‰)
  if (referenceSpectrumData) {
      drawLine(referenceSpectrumData, "#44ff44", 1);
  }
  
  // 2. Peak Hold ìŠ¤í™íŠ¸ëŸ¼ (ì£¼í™©ìƒ‰)
  if (peakHoldData.length > 0) {
      drawLine(peakHoldData, "#ffaa00", 1); 
  }

  // 3. ì‹¤ì‹œê°„ FFT ìŠ¤í™íŠ¸ëŸ¼ (íŒŒë€ìƒ‰)
  drawLine(arr, "#00e0ff", 1.5);
  

  // 4. í•˜ëª¨ë‹‰ ì„  ê·¸ë¦¬ê¸° (NÃ—, 2NÃ— ê°•ì¡°)
  if(audioContext && analyser){
    let sr = audioContext.sampleRate;
    let fftN = analyser.fftSize;
    let bin = sr/fftN;
    
    let rpm = Number(rpmIn.value);
    let blade = Number(bladeIn.value);
    let base = (rpm/60)*blade;

    // 1x, NÃ—(7Ã—), 2NÃ—(14Ã—)ë§Œ í‘œì‹œ
    const keyMultiples = [1, wearM, wearM * 2]; 

    for(let k of keyMultiples){
        let f = base * k;
        let idx = Math.round(f / bin); 
        
        if (idx >= startIdx && idx < endIdx){
            let x = ((idx - startIdx) / viewRange) * w;

            if(k === wearM){ // NÃ—(7Ã—) í•˜ëª¨ë‹‰: ì£¼í™©ìƒ‰, êµµê²Œ
                ctx.strokeStyle = "orange"; 
                ctx.lineWidth = 3;
            } else if (k === wearM * 2){ // 2NÃ—(14Ã—) í•˜ëª¨ë‹‰: ë³´ë¼ìƒ‰
                ctx.strokeStyle = "purple"; 
                ctx.lineWidth = 2;
            } else { // 1x í•˜ëª¨ë‹‰: ë¹¨ê°„ìƒ‰
                ctx.strokeStyle = "#ff4444"; 
                ctx.lineWidth = 2;
            }

            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, h);
            ctx.stroke();
        }
    }
  }
}

/* ---------- ì¤Œ/íŒ¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë³€í™” ì—†ìŒ) ---------- */
canvas.addEventListener('mousedown', (e) => {
    isPanning = true;
    lastPanX = e.clientX;
    canvas.style.cursor = 'grabbing';
});
document.addEventListener('mouseup', () => {
    if (isPanning) {
        isPanning = false;
        canvas.style.cursor = 'grab';
    }
});
canvas.addEventListener('mousemove', (e) => {
    if (!isPanning || !analyser) return;

    const dx = e.clientX - lastPanX;
    lastPanX = e.clientX;
    
    const binCount = analyser.frequencyBinCount;
    const canvasWidth = canvas.width;
    const currentRange = viewEndIndex - viewStartIndex;
    
    const binShift = Math.round(dx / canvasWidth * currentRange);
    
    if (binShift !== 0) {
        let newStart = viewStartIndex - binShift;
        let newEnd = viewEndIndex - binShift;
        
        if (newStart < 0) {
            newEnd += (0 - newStart);
            newStart = 0;
        }
        if (newEnd > binCount) {
            newStart -= (newEnd - binCount);
            newEnd = binCount;
        }
        
        viewStartIndex = Math.max(0, newStart);
        viewEndIndex = Math.min(binCount, newEnd);
        
        if (isRun) {
             drawFFT(freqData);
             drawSpectrogram(freqData);
        }
    }
});
canvas.addEventListener('wheel', (e) => {
    if (!analyser) return;
    
    e.preventDefault();
    
    const binCount = analyser.frequencyBinCount;
    const currentRange = viewEndIndex - viewStartIndex;
    
    const mouseXRatio = (e.clientX - canvas.getBoundingClientRect().left) / canvas.width;
    
    let newRange;

    if (e.deltaY < 0) {
        newRange = Math.min(binCount, Math.round(currentRange * 1.1));
    } else { 
        const minRange = Math.max(Math.round(binCount * 0.05), 100); 
        newRange = Math.max(minRange, Math.round(currentRange / 1.1)); 
    }
    
    const diffRange = newRange - currentRange;
    
    let newStart = viewStartIndex - Math.round(diffRange * mouseXRatio);
    let newEnd = viewEndIndex + Math.round(diffRange * (1 - mouseXRatio));

    if (newStart < 0) {
        newEnd += (0 - newStart);
        newStart = 0;
    }
    if (newEnd > binCount) {
        newStart -= (newEnd - binCount);
        newEnd = binCount;
    }
    
    viewStartIndex = Math.max(0, newStart);
    viewEndIndex = Math.min(binCount, newEnd);
    
    if (isRun) {
        drawFFT(freqData);
        drawSpectrogram(freqData);
    }
}, {passive: false});

/* ---------- ìœ í‹¸ (ë³€í™” ì—†ìŒ) ---------- */
canvas.addEventListener('mousemove',e=>{
  if(!analyser || !freqData) return;
  let r=canvas.getBoundingClientRect();
  let x=e.clientX-r.left;
  let w=canvas.width;
  const startIdx = viewStartIndex;
  const endIdx = viewEndIndex;
  const viewRange = endIdx - startIdx;
  let idx = startIdx + Math.floor((x/w)*viewRange);
  idx = clamp(idx);
  let sr=audioContext.sampleRate;
  let f=idx*(sr/analyser.fftSize);
  let a=freqData[idx];
  tooltip.style.left=x+"px";
  tooltip.style.top="10px";
  tooltip.style.display="block";
  tooltip.textContent=`${Math.round(f)}Hz / ${a}`;
});
canvas.addEventListener('mouseleave',()=>tooltip.style.display="none");

function clamp(v){return Math.max(0,Math.min(freqData.length-1,v));}
function ampToDb(a){return 20*Math.log10((a||1)/255);}
function floatNorm(u8){return Array.from(u8,x=>(x-128)/128);}
function rmsCalc(arr){return Math.sqrt(arr.reduce((s,x)=>s+x*x,0)/(arr.length||1));}
function kurtCalc(arr){
  let m=arr.reduce((s,x)=>s+x,0)/arr.length;
  let m2=0,m4=0;arr.forEach(x=>{let d=x-m;m2+=d*d;m4+=d*d*d*d;});
  m2/=arr.length; m4/=arr.length; return m4/(m2*m2+1e-12);
}
function crestCalc(arr){
  let p=Math.max(...arr.map(x=>Math.abs(x)));
  let r=rmsCalc(arr);
  return p/(r||1e-8);
}
function ampToHeatmap(amplitude) {
    let ratio = amplitude / 255;
    let r, g, b;
    if (ratio < 0.5) {
        r = Math.floor(ratio * 2 * 255);
        g = Math.floor(ratio * 2 * 255);
        b = 255;
    } else {
        r = 255;
        g = Math.floor((1 - (ratio - 0.5) * 2) * 255);
        b = 0;
    }
    return {r: Math.min(255, r), g: Math.min(255, g), b: Math.min(255, b), a: 255};
}
</script>

</body>
</html>