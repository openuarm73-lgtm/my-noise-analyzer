<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ëª¨ë°”ì¼ ì†Œë¦¬ ë¶„ì„ê¸° V2.0 (ì•ˆì •í™”)</title>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
    background:#0a0a14;color:#eee;
    padding:12px;
  }
  .container{
    max-width:1000px;margin:0 auto;background:#141622;
    border-radius:14px;padding:14px;box-shadow:0 0 20px rgba(0,0,0,0.4)
  }
  h1{text-align:center;font-size:1.3rem;margin-bottom:14px;color:#fff}

  /* PC = 2ì—´ / ëª¨ë°”ì¼ = 1ì—´ */
  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:14px;
  }
  @media(max-width:850px){
    .grid{grid-template-columns:1fr;}
  }

  .panel{background:#1e2030;padding:14px;border-radius:10px}

  label{display:block;margin-top:10px;font-weight:600;margin-bottom:6px;font-size:0.95rem}

  input,select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #333;
    background:#0f1018;color:#eee;font-size:1rem;
  }

  button{
    width:100%;padding:12px;margin-top:10px;border:none;
    border-radius:10px;background:#3a6df0;color:#fff;
    font-size:1.05rem;font-weight:700;cursor:pointer;
  }
  button:disabled{background:#555}

  .status{
    margin-top:12px;padding:10px;border-radius:8px;font-size:0.9rem;
  }
  .success{background:#1f402f;color:#9ff7c0;}
  .error{background:#402727;color:#ff9d9d;}
  .info{background:#3a3a18;color:#fff7a8;}
  .warn{background:#403a1a;color:#fff3ac;} /* ë…¸ë€ìƒ‰ ê³„ì—´ì˜ info/warn */

  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .kpi-item{
    background:#10111a;padding:8px;border-radius:8px;
    box-shadow:0 0 8px rgba(0,0,0,0.4);min-width:110px
  }

  canvas{
    width:100%;height:250px;border-radius:10px;background:#000;
  }

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.9rem}
  th,td{padding:6px;border-bottom:1px solid #333}

  .badge{
    padding:4px 10px;border-radius:999px;color:white;font-weight:700;
  }
  .ok{background:#2fa86d}
  .warn{background:#e49b23}
  .bad{background:#e64545}

  /* ëª¨ë°”ì¼ì—ì„œë„ ì ˆëŒ€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” AI ë°•ìŠ¤ */
  #aiBox{
    height:120px;overflow:hidden;margin-top:12px;
    background:#11131d;border-radius:10px;padding:10px;
  }
  #aiState{
    height:34px;display:flex;align-items:center;
    overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
    margin-bottom:8px;
  }
  #aiNote{
    height:70px;display:flex;align-items:center;
    overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
    font-size:0.9rem;color:#ddd;
  }

  #tooltip{
    position:absolute;background:rgba(0,0,0,0.8);color:#fff;
    padding:6px;border-radius:6px;font-size:0.85rem;display:none;
    pointer-events:none;z-index:10;
  }
  
  /* ë…¸ì´ì¦ˆ ë ˆë²¨ í‘œì‹œ ì¶”ê°€ */
  #noiseLevel{
    font-size:0.85rem; color:#aaa; margin-top:4px;
  }

</style>
</head>
<body>

<div class="container">
<h1>ğŸ“± ëª¨ë°”ì¼ ì†Œë¦¬ ë¶„ì„ê¸° V2.0</h1>

<div class="grid">

<div class="panel">

  <label>RPM</label>
  <input type="number" id="rpmInput" value="1500">

  <label>ë¸”ë ˆì´ë“œ ìˆ˜ (ê¸°ë³¸ ì£¼íŒŒìˆ˜ ë°°ìˆ˜)</label>
  <input type="number" id="bladeCountInput" value="20">

  <label>ë¶„ì„ ë°°ìˆ˜ (7Ã—/14Ã— í™•ì¥)</label>
  <select id="multipleSelect">
    <option value="7">1~7Ã— (ê¸°ë³¸)</option>
    <option value="14" selected>1~14Ã— (14ë°° íŒì • í¬í•¨)</option>
  </select>

  <label>FFT í¬ê¸°</label>
  <select id="fftSizeSelect">
    <option value="2048">2048</option>
    <option value="4096" selected>4096</option>
    <option value="8192">8192</option>
  </select>

  <label>FFT ìµœëŒ€ ì£¼íŒŒìˆ˜ (ê·¸ë˜í”„ Xì¶•)</label>
  <select id="maxFreqSelect">
    <option value="0">ì „ì²´ (ìƒ˜í”Œë§ ì£¼íŒŒìˆ˜/2)</option>
    <option value="5000">5000 Hz</option>
    <option value="10000" selected>10000 Hz</option>
    <option value="13000">13000 Hz</option>
  </select>

  <label style="margin-top:14px">ì´ë™í‰ê·  ê¸¸ì´</label>
  <input type="number" id="maLen" value="10">

  <label>ê²½ë³´ìŒ</label>
  <select id="alarmMode">
    <option value="off" selected>ë„ê¸°</option>
    <option value="beep" >ë¹„í”„ìŒ</option>
  </select>

  <label>AI dB ì„ê³„ê°’ (ì£¼ì˜/ê²°í•¨)</label>
  <div style="display:flex;gap:8px">
    <input type="number" id="warnThreshold" value="3">
    <input type="number" id="badThreshold" value="8">
  </div>

  <label>RPM ë³€í™” ë¯¼ê°ë„</label>
  <select id="rpmTrendSens">
    <option value="0.01">ë¯¼ê°</option>
    <option value="0.03" selected>ë³´í†µ</option>
    <option value="0.1">ì™„ë§Œ</option>
  </select>
  
  <button id="connectBtn">ğŸ¤ ë§ˆì´í¬ ì—°ê²°</button>
  <button id="startButton" disabled>â–¶ ë¶„ì„ ì‹œì‘</button>
  <button id="stopButton" disabled>â¹ ì¤‘ì§€</button>
  
  <button id="csvApplyBtn" style="background:#555">ğŸ’¾ CSV ì €ì¥ ì ìš© (í•´ì œë¨)</button>
  <div id="status" class="status info">ëŒ€ê¸° ì¤‘â€¦</div>

  <div class="kpi">
    <div class="kpi-item"><div>ì‹œê°„</div><b id="timeCounter">0</b></div>
    <div class="kpi-item"><div>í‰ê· </div><b id="movingAvg">-</b></div>
    <div class="kpi-item"><div>RMS</div><b id="rmsVal">-</b></div>
    <div class="kpi-item"><div>Peak</div><b id="peakVal">-</b></div>
  </div>

  <div class="panel" style="margin-top:12px">
    <div><b>ê¸°ë³¸/ê²°í•¨(7Ã—) ê²°ê³¼ (í”¼í¬ ë³´ê°„ ì ìš©)</b></div>
    <div id="freqResult" style="margin:6px 0"></div>
    <div id="noiseLevel">ë°°ê²½ ë…¸ì´ì¦ˆ ë ˆë²¨: - dB (ì°¸ì¡°ìš©)</div>

    <table>
      <thead><tr><th>ë°°ìˆ˜</th><th>Hz(ë³´ì •)</th><th>Amp(ë³´ì •)</th><th>dB(SNR)</th></tr></thead>
      <tbody id="harmonicsTable"></tbody>
    </table>

    <div id="aiBox">
      <div id="aiState"><span class="badge ok">-</span></div>
      <div id="aiNote">AI ëŒ€ê¸° ì¤‘â€¦</div>
    </div>
  </div>

</div>

<div class="panel">
  <div style="font-size:0.9rem">ì‹¤ì‹œê°„ FFT ìŠ¤í™íŠ¸ëŸ¼</div>
  <div style="position:relative;margin-top:8px">
    <canvas id="spectrumCanvas"></canvas>
    <div id="tooltip"></div>
  </div>

  <div class="kpi" style="margin-top:12px">
    <div class="kpi-item"><div>Kurtosis</div><b id="kurtVal">-</b></div>
    <div class="kpi-item"><div>Crest</div><b id="crestVal">-</b></div>
    <div class="kpi-item"><div>Bin</div><b id="freqPerBin">-</b></div>
  </div>

</div>

</div>
</div>

<script>
/* =========================================================
   ë§ˆì´í¬, FFT, íŒì • ë¡œì§ (V2.0 - í”¼í¬ ë³´ê°„ ë° SNR ê¸°ë°˜ ì•ˆì •í™”)
   ========================================================= */

let audioContext, analyser, source;
let freqData, timeData;
let isRun=false;
let raf;

let prevDefect=null, prevH14=null, prevRms=null, prevRpm=null;

let csvData = []; 
let isRecording = false; 
let isCsvEnabled = false; 

/* UI GET */
const rpmIn = _id('rpmInput');
const bladeIn = _id('bladeCountInput');
const multIn = _id('multipleSelect');
const fftIn = _id('fftSizeSelect');
const maxFreqIn = _id('maxFreqSelect'); 

const btnMic = _id('connectBtn');
const btnStart = _id('startButton');
const btnStop = _id('stopButton');
const csvApplyBtn = _id('csvApplyBtn'); 

const statusBox = _id('status');

const maLenIn = _id('maLen');
const warnIn = _id('warnThreshold');
const badIn = _id('badThreshold');
const rpmSensIn = _id('rpmTrendSens');
const alarmIn = _id('alarmMode');

const timeBox = _id('timeCounter');
const avgBox = _id('movingAvg');
const rmsBox = _id('rmsVal');
const peakBox = _id('peakVal');
const kurtBox = _id('kurtVal');
const crestBox = _id('crestVal'); 

const freqRes = _id('freqResult');
const harmTable = _id('harmonicsTable');
const noiseLevelBox = _id('noiseLevel');

const aiState = _id('aiState');
const aiNote  = _id('aiNote');

const canvas = _id('spectrumCanvas');
const ctx = canvas.getContext('2d');
const tooltip = _id('tooltip');

let dbHist=[];

function _id(x){return document.getElementById(x);}

/* ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • */
function setCanvasSize() {
  const containerWidth = canvas.parentNode.clientWidth;
  canvas.width = containerWidth;
  canvas.height = 250;
}
setCanvasSize();

/* ---------- CSV ì €ì¥ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼í•¨ ---------- */
function startRecording(){
    if(!isCsvEnabled) return; 
    csvData = [];
    isRecording = true;
    const header = ['Time(s)', 'RPM', 'BladeCount', 'BaseHz', 'DefectHz', 'BaseDb', 'DefectDb', 'DiffDb_SNR', 'MovingAvg', 'RMS_Db', 'Peak_Db', 'Kurtosis', 'CrestFactor', 'AI_State', 'AI_Note'];
    csvData.push(header);
}

function stopRecording(){
    if(!isCsvEnabled || !isRecording) {
        statusBox.innerText="ì¤‘ì§€ë¨.";
        return;
    }
    isRecording = false;
    if(csvData.length <= 1){
        statusBox.innerText="ì¤‘ì§€ë¨. ì €ì¥í•  ë°ì´í„°ê°€ ì—†ì–´ CSV ë‹¤ìš´ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.";
        return;
    }
    const csvContent = csvData.map(e => e.join(",")).join("\n");
    const blob = new Blob(["\ufeff", csvContent], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sound_analysis_${new Date().toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    csvData = [];
    statusBox.innerText="ì¤‘ì§€ë¨. CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ";
}

csvApplyBtn.onclick = () => {
    if(isRun) {
        statusBox.className = 'status warn';
        statusBox.innerText = 'ë¶„ì„ ì¤‘ì—ëŠ” CSV ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    isCsvEnabled = !isCsvEnabled;
    if (isCsvEnabled) {
        csvApplyBtn.style.background = '#3a6df0';
        csvApplyBtn.innerText = 'ğŸ’¾ CSV ì €ì¥ ì ìš© (í™œì„±í™”ë¨)';
        statusBox.className = 'status success';
        statusBox.innerText = 'CSV ì €ì¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
    } else {
        csvApplyBtn.style.background = '#555';
        csvApplyBtn.innerText = 'ğŸ’¾ CSV ì €ì¥ ì ìš© (í•´ì œë¨)';
        statusBox.className = 'status info';
        statusBox.innerText = 'CSV ì €ì¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
};

btnMic.onclick = async ()=>{
  try{
    let stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext = new (window.AudioContext||window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = Number(fftIn.value);
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);

    source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);

    btnMic.disabled=true; btnMic.innerText="ğŸ¤ ì—°ê²°ë¨";
    btnStart.disabled=false;
    statusBox.className="status success";
    statusBox.innerText="ë§ˆì´í¬ ì—°ê²° ì™„ë£Œ";
  }catch(e){
    statusBox.className="status error";
    statusBox.innerText="ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨: "+e;
  }
};

btnStart.onclick = ()=>{
  if(!audioContext) return;
  // FFT í¬ê¸° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¡œì§ (ì¬ì—°ê²° í•„ìš” ì—†ìŒ)
  if (analyser && analyser.fftSize !== Number(fftIn.value)) {
    analyser.fftSize = Number(fftIn.value);
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);
    _id('freqPerBin').innerText = (audioContext.sampleRate / analyser.fftSize).toFixed(2);
  }

  isRun=true;
  btnStart.disabled=true;
  btnStop.disabled=false;
  
  startRecording(); 
  
  if(isCsvEnabled){
      statusBox.className="status info";
      statusBox.innerText="ë¶„ì„ ë° CSV ì €ì¥ ì¤‘â€¦";
  } else {
      statusBox.className="status info";
      statusBox.innerText="ë¶„ì„ ì¤‘â€¦ (CSV ì €ì¥ í•´ì œë¨)";
  }
  
  t0=performance.now();
  loop();
};

btnStop.onclick = ()=>{
  isRun=false; 
  btnStart.disabled=false; 
  btnStop.disabled=true;
  stopRecording(); 
};

/* ---------- í”¼í¬ ë³´ê°„ ë° dB ê³„ì‚° í•¨ìˆ˜ (ê°œì„ ) ---------- */

/**
 * Parabolic Interpolationì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ í”¼í¬ ì§„í­ê³¼ ì£¼íŒŒìˆ˜ ì¸ë±ìŠ¤ë¥¼ ì¶”ì •í•©ë‹ˆë‹¤.
 * @param {Uint8Array} arr - FFT ë°ì´í„° ë°°ì—´
 * @param {number} idx - ì¶”ì •í•˜ë ¤ëŠ” ì£¼íŒŒìˆ˜ì˜ ì´ˆê¸° Bin ì¸ë±ìŠ¤
 * @param {number} binHz - 1 Binë‹¹ ì£¼íŒŒìˆ˜ (Hz)
 * @returns {{amp: number, f: number, db: number, noiseDb: number}} ë³´ê°„ëœ ì§„í­, ì£¼íŒŒìˆ˜, dB, ì¸ì ‘ ë…¸ì´ì¦ˆ dB
 */
function findPeakAmplitude(arr, idx, binHz){
    const N = arr.length;
    if(idx < 1 || idx >= N - 1) { // ê²½ê³„ê°’ ì˜ˆì™¸ ì²˜ë¦¬
        const a = arr[clamp(idx, N)];
        return { amp: a, f: idx * binHz, db: ampToDb(a), noiseDb: -100 };
    }
    
    // ì´ì›ƒí•œ 3ê°œ Binì˜ ì§„í­ì„ dB ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜
    const y1 = 20 * Math.log10(arr[idx - 1] / 255 + 1e-12); // ì´ì „ Bin
    const y2 = 20 * Math.log10(arr[idx] / 255 + 1e-12);     // ì¤‘ì•™ Bin (Peak)
    const y3 = 20 * Math.log10(arr[idx + 1] / 255 + 1e-12); // ë‹¤ìŒ Bin

    // í¬ë¬¼ì„  ë³´ê°„ (Parabolic Interpolation)
    // d = í”¼í¬ ìœ„ì¹˜ì˜ ë³´ì •ëœ ì¸ë±ìŠ¤ (dëŠ” -0.5 ~ +0.5 ë²”ìœ„)
    const d = 0.5 * (y1 - y3) / (y1 - 2 * y2 + y3);
    
    // ë³´ê°„ëœ í”¼í¬ dB ê°’
    const peakDb = y2 - 0.25 * (y1 - y3) * d;

    // ë³´ì •ëœ ì¸ë±ìŠ¤ ë° ì£¼íŒŒìˆ˜
    const correctedIdx = idx + d;
    const correctedFreq = correctedIdx * binHz;
    
    // dBë¥¼ ë‹¤ì‹œ 0-255 ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜ (UI í‘œì‹œìš©)
    const correctedAmp = Math.pow(10, peakDb / 20) * 255;
    
    // ì¸ì ‘ ë…¸ì´ì¦ˆ ë ˆë²¨ ì¸¡ì • (í”¼í¬ ì£¼ë³€ 3ê°œ Bin ì œì™¸í•œ í‰ê· )
    // 5ê°œ Bin (idx +/- 2)ì„ ë…¸ì´ì¦ˆ ì¸¡ì • ë²”ìœ„ë¡œ ì‚¬ìš©
    let noiseBins = [];
    for(let i = idx - 5; i <= idx + 5; i++){
        if (i < 0 || i >= N || (i >= idx - 1 && i <= idx + 1)) continue;
        noiseBins.push(arr[i]);
    }
    // ë…¸ì´ì¦ˆì˜ RMS ê°’ ê³„ì‚° (0-255 ìŠ¤ì¼€ì¼)
    const noiseRms = Math.sqrt(noiseBins.reduce((sum, a) => sum + a * a, 0) / (noiseBins.length || 1));
    const noiseDb = noiseRms > 0 ? 20 * Math.log10(noiseRms / 255) : -100; // dB ë³€í™˜
    
    return { 
        amp: correctedAmp, 
        f: correctedFreq, 
        db: peakDb, 
        noiseDb: noiseDb // ì¸ì ‘ ë…¸ì´ì¦ˆ dB
    };
}

/** * dB ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ Peakì™€ Noise ë ˆë²¨ì˜ ì°¨ì´(SNR)ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
 * @param {number} peakDb - ë³´ê°„ëœ í”¼í¬ dB ê°’
 * @param {number} noiseDb - ì¸ì ‘ ë…¸ì´ì¦ˆ ë°°ê²½ dB ê°’
 * @returns {number} SNR ê¸°ë°˜ì˜ dB ì°¨ì´ (Peak - Noise)
 */
function calcSnrDb(peakDb, noiseDb){
    // ë…¸ì´ì¦ˆ ë ˆë²¨ ëŒ€ë¹„ í”¼í¬ê°€ ì–¼ë§ˆë‚˜ ë†’ì€ì§€ ì¸¡ì •.
    // ì´ëŠ” í™˜ê²½ ì†ŒìŒì˜ ì ˆëŒ€ ë ˆë²¨ ë³€í™”ì— ëœ ë¯¼ê°í•©ë‹ˆë‹¤.
    return peakDb - noiseDb;
}

function clamp(v, N){return Math.max(0,Math.min(N-1,v));}
function ampToDb(a){return 20*Math.log10((a||1)/255);}
function floatNorm(u8){return Array.from(u8,x=>(x-128)/128);}
function rmsCalc(arr){return Math.sqrt(arr.reduce((s,x)=>s+x*x,0)/(arr.length||1));}
function kurtCalc(arr){
  let m=arr.reduce((s,x)=>s+x,0)/arr.length;
  let m2=0,m4=0;arr.forEach(x=>{let d=x-m;m2+=d*d;m4+=d*d*d*d;});
  m2/=arr.length; m4/=arr.length; return m4/(m2*m2+1e-12);
}
function crestCalc(arr){
  let p=Math.max(...arr.map(x=>Math.abs(x)));
  let r=rmsCalc(arr);
  return p/(r||1e-8);
}
/* ---------- ë¶„ì„ ë£¨í”„ ---------- */
let t0=0;
function loop(){
  if(!isRun) return; 

  analyser.getByteFrequencyData(freqData);
  analyser.getByteTimeDomainData(timeData);

  let sr = audioContext.sampleRate;
  let fftN = analyser.fftSize;
  let bin = sr/fftN;

  let rpm = Number(rpmIn.value);
  let blade = Number(bladeIn.value);
  let maxMul = Number(multIn.value);

  let base = (rpm/60)*blade; // ê¸°ë³¸ ì£¼íŒŒìˆ˜
  let defect = base*7;       // ê²°í•¨ ì£¼íŒŒìˆ˜ (7X)

  // 1. ì´ˆê¸° Bin ì¸ë±ìŠ¤ ê³„ì‚°
  let baseI = Math.round(base/bin);
  let defectI = Math.round(defect/bin);

  // 2. í”¼í¬ ë³´ê°„ ì ìš© (ì•ˆì •ì„± ê°•í™”)
  const basePeak = findPeakAmplitude(freqData, baseI, bin);
  const defectPeak = findPeakAmplitude(freqData, defectI, bin);

  // 3. SNR ê¸°ë°˜ì˜ dB ì°¨ì´ ê³„ì‚°
  const baseSnrDb = calcSnrDb(basePeak.db, basePeak.noiseDb);
  const defectSnrDb = calcSnrDb(defectPeak.db, defectPeak.noiseDb);
  
  // SNR ê¸°ë°˜ìœ¼ë¡œ ê²°í•¨ íŒì •ì— ì‚¬ìš©í•  Diff dB (ì•ˆì •ì )
  let diff = Math.abs(defectSnrDb - baseSnrDb);
  
  // ì „ì²´ í‰ê·  ë…¸ì´ì¦ˆ ë ˆë²¨ì„ ì°¸ì¡°ìš©ìœ¼ë¡œ ê³„ì‚°
  const overallNoiseDb = Math.round((basePeak.noiseDb + defectPeak.noiseDb) / 2);

  /* ì´ë™í‰ê·  */
  let ma = Number(maLenIn.value);
  dbHist.push(diff);
  if(dbHist.length>ma) dbHist.shift();
  let avg = dbHist.reduce((a,b)=>a+b,0)/(dbHist.length||1);

  /* RMS, Peak, Kurtosis, Crest Factor (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼) */
  let tArr = floatNorm(timeData);
  let rms = rmsCalc(tArr);
  let rmsDb = 20*Math.log10(rms||1e-8);
  let peak = tArr.reduce((a,b)=>Math.max(a,Math.abs(b)),0);
  let peakDb = 20*Math.log10(peak||1e-8);
  let kurt = kurtCalc(tArr);
  let crest = crestCalc(tArr);

  /* ê³ ì¡°íŒŒ */
  let hList=[];
  for(let k=1;k<=maxMul;k++){
    let f = base*k;
    let idx=Math.round(f/bin);
    // ê³ ì¡°íŒŒì—ë„ ë³´ê°„ ì ìš© (ë°ì´í„° ì•ˆì •ì„± í™•ë³´)
    const hPeak = findPeakAmplitude(freqData, idx, bin); 
    const hSnrDb = calcSnrDb(hPeak.db, hPeak.noiseDb);
    hList.push({k, f: hPeak.f, a: hPeak.amp, db: hSnrDb});
  }

  let h14 = hList.find(h=>h.k===14);

  /* AI íŒì • */
  let aiL="ì •ìƒ", aiC="ok", msg="";

  let warnT=Number(warnIn.value);
  let badT=Number(badIn.value);

  // íŒì • ê¸°ì¤€: SNR ê¸°ë°˜ Diff dB ì‚¬ìš©
  if(diff>badT){ aiL="ê²°í•¨ ì˜ì‹¬"; aiC="bad"; msg=`SNR dBì°¨ì´ ${diff.toFixed(2)}`; }
  else if(diff>warnT){ aiL="ì£¼ì˜"; aiC="warn"; msg=`SNR dBì°¨ì´ ${diff.toFixed(2)}`; }

  /* 14Ã— ìë™ íŒì • (SNR dB ì‚¬ìš©) */
  if(h14){
    // h14.aëŠ” ë³´ê°„ëœ Amplitude (0-255)
    let ratio14 = defectPeak.amp > 0 ? h14.a / defectPeak.amp : 0; 
    
    if(prevDefect && defectPeak.amp < prevDefect-4 && ratio14<2){
      aiL="ì •ìƒ(ì••ë ¥ê°ì†ŒíŒ¨í„´)";
      aiC="ok";
      msg="7Ã— ê°ì†Œ & 14/7 ë‚®ìŒ";
    }
    if(prevH14 && (h14.db - prevH14) > 6){
      aiL="ê²°í•¨(14Ã— ê¸‰ì¦)";
      aiC="bad";
      msg=`14Ã— +${(h14.db - prevH14).toFixed(2)} dB (SNR)`;
    }
    if(ratio14 > 3){
      aiL="ë¹„ì •ìƒ(14Ã— ê³¼ë‹¤)";
      aiC="bad";
      msg=`14/7=${ratio14.toFixed(2)}`;
    }
  }

  /* RPM íŠ¸ë Œë“œ (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼) */
  if(prevRpm){
    let sens=Number(rpmTrendSens.value);
    let rchg=(rpm-prevRpm)/(prevRpm||1);
    // ... RPM íŠ¸ë Œë“œ ë¡œì§ ìƒëµ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
  }

  /* UI ì—…ë°ì´íŠ¸ */
  aiState.innerHTML=`<span class="badge ${aiC}">${aiL}</span>`;
  aiNote.innerText=msg||"";

  timeBox.innerText = Math.floor((performance.now()-t0)/1000)+"s";
  avgBox.innerText = avg.toFixed(2);
  rmsBox.innerText = rmsDb.toFixed(2)+" dB";
  peakBox.innerText = peakDb.toFixed(2)+" dB";
  kurtBox.innerText = kurt.toFixed(2);
  crestBox.innerText = crest.toFixed(2);
  _id('freqPerBin').innerText = bin.toFixed(2);
  noiseLevelBox.innerText = `ë°°ê²½ ë…¸ì´ì¦ˆ ë ˆë²¨: ${overallNoiseDb.toFixed(1)} dB (ì°¸ì¡°ìš©)`;

  freqRes.innerHTML =
    `ê¸°ë³¸: ${basePeak.f.toFixed(1)}Hz / ${baseSnrDb.toFixed(2)}dB(SNR)<br>`+
    `ê²°í•¨(7Ã—): ${defectPeak.f.toFixed(1)}Hz / ${defectSnrDb.toFixed(2)}dB(SNR)<br>`+
    `ì°¨ì´: ${diff.toFixed(2)}dB(SNR)`;

  harmTable.innerHTML="";
  hList.forEach(h=>{
    harmTable.innerHTML+=`<tr><td>${h.k}Ã—</td><td>${h.f.toFixed(1)}</td><td>${Math.round(h.a)}</td><td>${h.db.toFixed(2)}</td></tr>`;
  });

  /* CSV ë°ì´í„° ê¸°ë¡ (DiffDb_SNR ì‚¬ìš©) */
  if(isRecording){
      const timeElapsed = (performance.now()-t0)/1000;
      const row = [
          timeElapsed.toFixed(2), 
          rpm, blade, 
          basePeak.f.toFixed(2), defectPeak.f.toFixed(2), // ë³´ì •ëœ ì£¼íŒŒìˆ˜
          baseSnrDb.toFixed(2), defectSnrDb.toFixed(2), 
          diff.toFixed(2), avg.toFixed(2), 
          rmsDb.toFixed(2), peakDb.toFixed(2), 
          kurt.toFixed(2), crest.toFixed(2),
          aiL, msg
      ];
      csvData.push(row);
  }

  /* ìŠ¤í™íŠ¸ëŸ¼ ê·¸ë¦¬ê¸° */
  draw(freqData);

  /* prev ì—…ë°ì´íŠ¸ */
  prevDefect = defectPeak.amp; // Amplitudeë¡œ ì—…ë°ì´íŠ¸
  prevH14 = h14 ? h14.db : null; // SNR dBë¡œ ì—…ë°ì´íŠ¸
  prevRms = rmsDb;
  prevRpm = rpm;

  raf=requestAnimationFrame(loop);
}

/* ---------- FFT ê·¸ë¦¬ê¸° ë° Tooltip (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼) ---------- */
function draw(arr){
  setCanvasSize(); 
  
  let w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);

  // ìµœëŒ€ ì£¼íŒŒìˆ˜ ë²”ìœ„ ê³„ì‚°
  let sr = audioContext ? audioContext.sampleRate : 44100;
  let fftN = analyser ? analyser.fftSize : 4096;
  let nyquist = sr/2;
  let bin = sr/fftN;
  let maxFreqInput = Number(maxFreqIn.value);
  let graphMaxFreq = (maxFreqInput > 0 && maxFreqInput < nyquist) ? maxFreqInput : nyquist;
  let endIndex = Math.min(arr.length, Math.round(graphMaxFreq / bin));

  // 1. FFT ìŠ¤í™íŠ¸ëŸ¼ ì„  ê·¸ë¦¬ê¸°
  ctx.beginPath();
  for(let i=0;i<endIndex;i++){
    let x=(i/endIndex)*w;
    let y=h - (arr[i]/255)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle="#00e0ff";
  ctx.lineWidth=1.5;
  ctx.stroke();

  // 2. ê¸°ë³¸ ì£¼íŒŒìˆ˜ ì„ (1x ~ maxMul x) ê·¸ë¦¬ê¸°
  if(audioContext && analyser){
    let rpm = Number(rpmIn.value);
    let blade = Number(bladeIn.value);
    let base = (rpm/60)*blade;
    let maxMul = Number(multIn.value); 

    for(let k=1; k <= maxMul; k++){
        let f = base * k;
        if(f > graphMaxFreq) continue; 
        
        let idx = Math.round(f / bin); 
        let x = (idx / endIndex) * w;
        
        if(x > 0 && x < w){
            if(k === 1 || k === 7 || k === 14){
                ctx.strokeStyle = "#ff4444"; 
                ctx.lineWidth = 2;
            } else {
                ctx.strokeStyle = "rgba(255, 0, 0, 0.7)";
                ctx.lineWidth = 1;
            }

            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, h);
            ctx.stroke();
        }
    }
  }
}

canvas.addEventListener('mousemove',e=>{
  if(!audioContext || !analyser) return;

  let r=canvas.getBoundingClientRect();
  let x=e.clientX-r.left;
  let w=r.width;
  
  let sr = audioContext.sampleRate;
  let fftN = analyser.fftSize;
  let bin = sr/fftN;
  let nyquist = sr/2;
  let maxFreqInput = Number(maxFreqIn.value);
  let graphMaxFreq = (maxFreqInput > 0 && maxFreqInput < nyquist) ? maxFreqInput : nyquist;
  let endIndex = Math.min(freqData.length, Math.round(graphMaxFreq / bin));

  let idx = Math.floor((x/w) * endIndex);
  idx = clamp(idx, freqData.length);

  let f=idx*bin;
  let a=freqData[idx];

  tooltip.style.left=x+"px";
  tooltip.style.top="10px";
  tooltip.style.display="block";
  tooltip.textContent=`${Math.round(f)}Hz / ${a}`;
});
canvas.addEventListener('mouseleave',()=>tooltip.style.display="none");
</script>

</body>
</html>
