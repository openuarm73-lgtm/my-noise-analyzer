class MobileAudioAnalyzer {
    constructor() {
        this.audioContext = null;
        this.analyser = null;
        this.source = null;
        this.mediaStream = null;
        this.isConnected = false;
        this.isAnalyzing = false;
        this.allMeasurements = []; // ì „ì²´ ì¸¡ì •ì„ ì €ì¥í•˜ëŠ” ë°°ì—´
        this.currentIntervalMeasurements = []; // í˜„ì¬ 20ì´ˆ ê°„ê²© ì¸¡ì •ì„ ì €ì¥í•˜ëŠ” ë°°ì—´
        this.intervalCount = 0; // 20ì´ˆ ì¸¡ì • íšŸìˆ˜ (ì´ 3íšŒ)
        this.startTime = null;
        this.measurementInterval = null; // setInterval ID
        this.ANALYSIS_INTERVAL_MS = 500; // ì¸¡ì • ê°„ê²© 0.5ì´ˆ
        this.INTERVAL_DURATION_SEC = 20; // 20ì´ˆ ê°„ê²©
        this.TOTAL_INTERVALS = 3; // ì´ 3íšŒ ì¸¡ì •

        this.initializeElements();
        this.bindEvents();
        this.checkMobileSupport();
        this.setupVisibilityHandling();
    }

    initializeElements() {
        this.rpmInput = document.getElementById('rpmInput');
        this.connectBtn = document.getElementById('connectBtn');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.status = document.getElementById('status');
        this.results = document.getElementById('results');
        this.measurementList = document.getElementById('measurementList');
        this.finalResult = document.getElementById('finalResult');
        this.helpText = document.getElementById('helpText');
        this.progressContainer = document.getElementById('progressContainer');
        this.progressBar = document.getElementById('progressBar');
    }

    bindEvents() {
        this.connectBtn.addEventListener('click', () => this.connectMicrophone());
        this.startBtn.addEventListener('click', () => this.startAnalysis());
        this.stopBtn.addEventListener('click', () => this.stopAnalysis());
        this.rpmInput.addEventListener('input', () => this.validateRPM());
    }

    checkMobileSupport() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            this.updateStatus('ì´ ë¸Œë¼ìš°ì €ëŠ” ë§ˆì´í¬ ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            this.connectBtn.disabled = true;
        }
    }

    setupVisibilityHandling() {
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && this.isAnalyzing) {
                this.stopAnalysis(true); // í˜ì´ì§€ ìˆ¨ê¹€ ì‹œ ê°•ì œ ì¤‘ì§€
            }
        });
    }

    async connectMicrophone() {
        try {
            this.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioContext.createAnalyser();
            this.analyser.fftSize = 2048;
            this.source = this.audioContext.createMediaStreamSource(this.mediaStream);
            this.source.connect(this.analyser);
            this.isConnected = true;
            this.updateStatus('ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
            this.connectBtn.disabled = true;
            this.startBtn.disabled = false;
        } catch (err) {
            this.updateStatus(`ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨: ${err.message}`, 'error');
        }
    }

    validateRPM() {
        const rpm = parseInt(this.rpmInput.value);
        if (isNaN(rpm) || rpm < 300 || rpm > 10000) {
            this.updateStatus('RPM ê°’ì€ 300~10000 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
            this.startBtn.disabled = true;
        } else {
            this.updateStatus(this.isConnected ? 'ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 'RPM ê°’ì´ ìœ íš¨í•©ë‹ˆë‹¤.', this.isConnected ? 'success' : 'status');
            if (this.isConnected) this.startBtn.disabled = false;
        }
    }

    startAnalysis() {
        if (!this.isConnected) {
            this.updateStatus('ë¨¼ì € ë§ˆì´í¬ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        const rpm = parseInt(this.rpmInput.value);
        if (isNaN(rpm) || rpm < 300 || rpm > 10000) {
             this.updateStatus('ìœ íš¨í•œ RPM ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
             return;
        }
        
        this.isAnalyzing = true;
        this.allMeasurements = [];
        this.currentIntervalMeasurements = [];
        this.intervalCount = 0;
        this.startTime = performance.now();
        this.measurementList.innerHTML = '';
        this.finalResult.innerHTML = '';
        this.progressContainer.style.display = 'block';
        this.results.style.display = 'block';
        this.startBtn.disabled = true;
        this.stopBtn.disabled = false;
        this.updateStatus(`ì†Œë¦¬ ë¶„ì„ ì¤‘... (ëª©í‘œ RPM: ${rpm})`, 'analyzing');

        this.measurementInterval = setInterval(() => this.analyzeAudioStep(), this.ANALYSIS_INTERVAL_MS);
    }

    analyzeAudioStep() {
        if (!this.isAnalyzing) return;

        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Float32Array(bufferLength);
        this.analyser.getFloatFrequencyData(dataArray);

        const rpm = parseInt(this.rpmInput.value);
        const sampleRate = this.audioContext.sampleRate;
        const binWidth = sampleRate / this.analyser.fftSize;

        let maxAmplitude = -Infinity;
        let maxBin = 0;
        // ì¼ì • ì£¼íŒŒìˆ˜ ë²”ìœ„ ë‚´ì—ì„œ í”¼í¬ë¥¼ ì°¾ê±°ë‚˜, ê·¸ëƒ¥ ì „ì²´ í”¼í¬ë¥¼ ì°¾ë„ë¡ ìœ ì§€
        for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] > maxAmplitude) {
                maxAmplitude = dataArray[i];
                maxBin = i;
            }
        }

        const detectedHz = maxBin * binWidth;
        const detectedRPM = detectedHz * 60;
        const tolerance = 0.1; // 10% tolerance
        const isValid = Math.abs(detectedRPM - rpm) <= rpm * tolerance;
        const currentTime = ((performance.now() - this.startTime) / 1000);

        const measurement = {
            time: currentTime.toFixed(1),
            detectedRPM,
            isValid
        };
        
        this.allMeasurements.push(measurement);
        this.currentIntervalMeasurements.push(measurement);

        // ì¸¡ì •ê°’ì„ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œ (ë„ˆë¬´ ë§ì•„ì§€ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜, ì ë‹¹íˆ í•„í„°ë§ í•„ìš”)
        // this.displayMeasurement(measurement);
        
        this.updateProgress(currentTime);

        // 20ì´ˆ ê°„ê²©ìœ¼ë¡œ ì¤‘ê°„ ê²°ê³¼ í‘œì‹œ
        if (currentTime >= (this.intervalCount + 1) * this.INTERVAL_DURATION_SEC) {
            this.intervalCount++;
            this.displayIntervalResult(this.intervalCount);
            this.currentIntervalMeasurements = []; // ë‹¤ìŒ ê°„ê²©ì„ ìœ„í•´ ì´ˆê¸°í™”

            if (this.intervalCount >= this.TOTAL_INTERVALS) {
                this.stopAnalysis();
            }
        }
    }

    stopAnalysis(isForced = false) {
        if (!this.isAnalyzing) return;
        
        this.isAnalyzing = false;
        clearInterval(this.measurementInterval);

        this.progressContainer.style.display = 'none';
        this.stopBtn.disabled = true;
        this.startBtn.disabled = false;
        
        if (isForced) {
             this.updateStatus('ë¶„ì„ì´ ê°•ì œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜ì´ì§€ ì´ë™/ìˆ¨ê¹€ ë“±)', 'error');
             return;
        }

        this.updateStatus('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'success');
        this.displayResults();
    }

    updateStatus(message, type) {
        this.status.textContent = message;
        this.status.className = `status ${type}`;
    }

    updateProgress(currentTime) {
        const totalDuration = this.TOTAL_INTERVALS * this.INTERVAL_DURATION_SEC;
        this.currentProgress = (currentTime / totalDuration) * 100;
        if (this.currentProgress > 100) this.currentProgress = 100;
        this.progressBar.style.width = `${this.currentProgress}%`;
    }

    // ê°œë³„ ì¸¡ì •ê°’ í‘œì‹œ (ë„ˆë¬´ ë§ì•„ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš©ì— ì£¼ì˜)
    displayMeasurement(measurement) {
        const div = document.createElement('div');
        div.className = 'measurement';
        div.innerHTML = `[${measurement.time}s] ê²€ì¶œ RPM: ${measurement.detectedRPM.toFixed(2)} | ${measurement.isValid ? 'ì •ìƒ' : 'ë¹„ì •ìƒ'}`;
        this.measurementList.prepend(div);
    }
    
    // 20ì´ˆ ê°„ê²© ê²°ê³¼ í‘œì‹œ
    displayIntervalResult(count) {
        const totalRPM = this.currentIntervalMeasurements.reduce((sum, m) => sum + m.detectedRPM, 0);
        const averageRPM = this.currentIntervalMeasurements.length > 0 ? totalRPM / this.currentIntervalMeasurements.length : 0;
        const inputRPM = parseInt(this.rpmInput.value);
        const isNormal = Math.abs(averageRPM - inputRPM) <= inputRPM * 0.1;
        
        const div = document.createElement('div');
        div.className = `measurement ${isNormal ? '' : 'error'}`;
        div.style.borderLeftColor = isNormal ? '#48bb78' : '#e53e3e';
        div.innerHTML = `
            <strong>${count * this.INTERVAL_DURATION_SEC}ì´ˆ êµ¬ê°„ ì¸¡ì • ê²°ê³¼ (ì‹œì‘: ${(count - 1) * this.INTERVAL_DURATION_SEC}s)</strong><br>
            í‰ê·  ê²€ì¶œ RPM: ${averageRPM.toFixed(2)} | ìƒíƒœ: ${isNormal ? 'ğŸŸ¢ ì •ìƒ' : 'ğŸ”´ ë¹„ì •ìƒ'}
        `;
        this.measurementList.prepend(div);
    }

    // ìµœì¢… ê²°ê³¼ í‘œì‹œ
    displayResults() {
        const totalRPM = this.allMeasurements.reduce((sum, m) => sum + m.detectedRPM, 0);
        const averageRPM = this.allMeasurements.length > 0 ? totalRPM / this.allMeasurements.length : 0;
        const inputRPM = parseInt(this.rpmInput.value);
        const isNormal = Math.abs(averageRPM - inputRPM) <= inputRPM * 0.1;
        
        this.finalResult.textContent = `ìµœì¢… í‰ê·  RPM: ${averageRPM.toFixed(2)} | ìƒíƒœ: ${isNormal ? 'âœ¨ ì •ìƒ' : 'âš ï¸ ë¹„ì •ìƒ'}`;
        this.finalResult.className = `final-result ${isNormal ? 'success' : ''}`;
    }

    disconnect() {
        if (this.mediaStream) {
            this.mediaStream.getTracks().forEach(track => track.stop());
        }
        if (this.audioContext) {
            this.audioContext.close();
        }
        clearInterval(this.measurementInterval);
        this.isConnected = false;
        this.isAnalyzing = false;
        this.connectBtn.disabled = false;
        this.startBtn.disabled = true;
        this.stopBtn.disabled = true;
        this.updateStatus('ë§ˆì´í¬ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'status');
        this.progressContainer.style.display = 'none';
    }
}

// Initialize the analyzer
const analyzer = new MobileAudioAnalyzer();
