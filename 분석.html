<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†ŒìŒ ë¶„ì„ê¸°</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f6f8;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h2 {
            color: #222;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
        }
        .status {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>ğŸ§ AI ê¸°ë°˜ ì†ŒìŒ ë¶„ì„ê¸°</h2>

    <div class="card">
        <label>ğŸ› ëª©í‘œ RPM ì…ë ¥: <input type="number" id="rpm" value="1800" min="0"> RPM</label>
        <br><br>
        <button id="startBtn">ë¶„ì„ ì‹œì‘</button>
        <button id="stopBtn" disabled>ì¤‘ì§€</button>
        <p class="status" id="statusText">ëŒ€ê¸° ì¤‘...</p>
    </div>

    <div class="card">
        <h3>
            ğŸ“ˆ ì°¨ì´ ì¸¡ì • (ì´ë™ í‰ê· )
            <span id="startTime" style="font-size:0.9rem; color:#555; margin-left:10px;">
                <!-- ë¶„ì„ ê²½ê³¼ ì´ˆ í‘œì‹œ -->
            </span>
        </h3>
        <canvas id="chart" width="400" height="150"></canvas>
    </div>

    <script>
        class NoiseAnalyzer {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.source = null;
                this.dataArray = null;
                this.isRunning = false;
                this.chartCtx = document.getElementById('chart').getContext('2d');
                this.statusText = document.getElementById('statusText');
                this.rpmInput = document.getElementById('rpm');
                this.startButton = document.getElementById('startBtn');
                this.stopButton = document.getElementById('stopBtn');
                this.diffHistory = [];
                this.prevValue = 0;
                this.avgWindow = 10;
                this.startTimestamp = null; // ì‹œì‘ ì‹œê° (ms)
                this.timerInterval = null;  // ê²½ê³¼ì‹œê°„ í‘œì‹œìš©
                this.initEvents();
            }

            initEvents() {
                this.startButton.addEventListener('click', () => this.startAnalysis());
                this.stopButton.addEventListener('click', () => this.stopAnalysis());
            }

            async startAnalysis() {
                if (this.isRunning) return;

                const rpm = parseInt(this.rpmInput.value);
                this.isRunning = true;
                this.startButton.disabled = true;
                this.stopButton.disabled = false;
                this.diffHistory = [];
                this.updateStatus(`ë¶„ì„ ì¤‘... (ëª©í‘œ RPM: ${rpm})`, 'analyzing');

                // âœ… ì‹œì‘ ì‹œê° ê¸°ë¡ ë° 0ì´ˆë¶€í„° ì¹´ìš´íŠ¸ ì‹œì‘
                this.startTimestamp = Date.now();
                const startTimeEl = document.getElementById('startTime');
                startTimeEl.textContent = `ğŸ•’ ê²½ê³¼: 0ì´ˆ`;

                // 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
                this.timerInterval = setInterval(() => {
                    const elapsedSec = Math.floor((Date.now() - this.startTimestamp) / 1000);
                    startTimeEl.textContent = `ğŸ•’ ê²½ê³¼: ${elapsedSec}ì´ˆ`;
                }, 1000);

                // ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.source = this.audioContext.createMediaStreamSource(stream);
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 1024;
                this.dataArray = new Float32Array(this.analyser.fftSize);
                this.source.connect(this.analyser);
                requestAnimationFrame((time) => this.analyzeAudioStep(time));
            }

            stopAnalysis() {
                this.isRunning = false;
                this.startButton.disabled = false;
                this.stopButton.disabled = true;
                clearInterval(this.timerInterval);
                this.updateStatus("â¹ï¸ ë¶„ì„ ì¤‘ì§€ë¨", 'stopped');
            }

            analyzeAudioStep() {
                if (!this.isRunning) return;
                this.analyser.getFloatTimeDomainData(this.dataArray);
                let avg = this.dataArray.reduce((a, b) => a + Math.abs(b), 0) / this.dataArray.length;
                let diff = Math.abs(avg - this.prevValue);
                this.prevValue = avg;
                this.diffHistory.push(diff);
                if (this.diffHistory.length > 100) this.diffHistory.shift();
                this.drawChart();
                requestAnimationFrame((time) => this.analyzeAudioStep(time));
            }

            drawChart() {
                const ctx = this.chartCtx;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.beginPath();
                ctx.moveTo(0, ctx.canvas.height);
                this.diffHistory.forEach((val, i) => {
                    const x = (i / this.diffHistory.length) * ctx.canvas.width;
                    const y = ctx.canvas.height - val * 1000;
                    ctx.lineTo(x, y);
                });
                ctx.strokeStyle = '#0078d4';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            updateStatus(text, state) {
                this.statusText.textContent = text;
                if (state === 'analyzing') this.statusText.style.color = '#0078d4';
                else if (state === 'stopped') this.statusText.style.color = '#d40000';
                else this.statusText.style.color = '#333';
            }
        }

        new NoiseAnalyzer();
    </script>
</body>
</html>

