       <!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í ë¦¬íƒ€ì´ì € ì†ŒìŒ ë¶„ì„ (20ì´ˆ ì£¼ê¸°, 2ë‹¨ê³„ ì‹œì‘)</title>
    
    <style>
        /* 1. ë‹¤í¬ ëª¨ë“œ ë° ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        :root {
            --color-bg-primary: #121212;
            --color-bg-secondary: #1f1f1f;
            --color-text-primary: #e0e0e0;
            --color-accent: #64b5f6; /* ë°ì€ íŒŒë‘ */
            --color-connect: #007bff; /* ì—°ê²° ë²„íŠ¼ íŒŒë‘ */
            --color-success: #4caf50;
            --color-danger: #e57373;
            --color-warning: #ffc107;
            --color-border: #333333;
        }

        body {Â 
            font-family: 'Malgun Gothic', 'Arial', sans-serif;Â 
            padding: 15px;Â 
            background-color: var(--color-bg-primary); 
            color: var(--color-text-primary); 
            line-height: 1.6;
            margin: 0;
        }
        .container {Â 
            max-width: 600px; 
            margin: 0 auto;Â 
            padding: 20px;Â 
            border-radius: 12px;
            background-color: var(--color-bg-secondary); 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        }
        h2 {Â 
            border-bottom: 3px solid var(--color-accent); 
            padding-bottom: 10px;Â 
            margin-top: 0;
            color: var(--color-accent); 
            font-size: 1.8em; 
            text-align: center;
        }
        
        /* 2. ì…ë ¥ ë° ë²„íŠ¼ (ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™”) */
        input[type="number"], button {Â 
            margin: 12px 0;Â 
            padding: 18px 15px;Â 
            width: 100%;Â 
            box-sizing: border-box;Â 
            border-radius: 10px; 
            font-size: 1.15em;
            border: 1px solid var(--color-border);
            background-color: #333333; 
            color: var(--color-text-primary);
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        #connectButton { background-color: var(--color-connect); color: white; border: none; font-weight: bold; }
        #connectButton:disabled { background-color: #0056b3; }
        #analyzeButton { background-color: var(--color-success); color: white; border: none; font-weight: bold; }
        #analyzeButton:disabled { background-color: #2e7d32; }
        #stopButton { background-color: var(--color-danger); color: white; border: none; font-weight: bold; }
        #stopButton:disabled { background-color: #a32a2a; }

        /* 3. ìƒíƒœ ë° ë©”ì‹œì§€ (ìƒëµ) */
        .alert-message {
            color: #ffab91; 
            padding: 15px;
            border: 1px dashed #ffab91;
            border-radius: 8px;
            background-color: #3e2723;
            font-size: 1em;
            margin-bottom: 20px;
        }
        #status-display {
            color: var(--color-accent); 
            font-weight: bold;
            padding: 15px 0;
            border-top: 1px dashed var(--color-border);
            margin-top: 15px;
            font-size: 1.2em;
            text-align: center;
        }

        /* 4. ê²°ê³¼ í‘œì‹œ ì˜ì—­ (ìƒëµ) */
        #realtime-results {Â 
            margin-top: 30px;Â 
            padding: 15px;Â 
            background-color: var(--color-bg-secondary); 
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }
        .label {Â 
            font-weight: bold;Â 
            color: var(--color-text-primary); 
            margin-bottom: 15px;
            display: block;
            font-size: 1.1em;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 5px;
        }
        .result-entry {Â 
            border-bottom: 1px solid #282828; 
            padding: 15px 0;Â 
            margin-bottom: 15px;Â 
        }
        .result-entry:first-of-type {
            border-top: 2px solid var(--color-accent); 
            padding-top: 20px;
        }
        .diff-result {
            font-size: 1.5em;Â 
            color: #121212;
            background-color: var(--color-warning); 
            display: block; 
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        strong {
            color: #ffffff; 
        }
    </style>
</head>
<body>

<div class="container">
    <h2>âš™ï¸ í ë¦¬íƒ€ì´ì € ì†ŒìŒ ë¶„ì„ê¸°</h2>

    <p class="alert-message">
        **í•„ìˆ˜:** HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™í•˜ë©°, ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
    </p>
    
    <label class="label" for="rpm">1. í ë¦¬íƒ€ì´ì € RPM ì…ë ¥:</label>
    <input type="number" id="rpm" value="1200" placeholder="RPM (ì˜ˆ: 1200)" min="1">

    <button onclick="connectMicrophone()" id="connectButton">2. ë§ˆì´í¬ ì—°ê²°</button>
    <button onclick="startAnalysis()" id="analyzeButton" disabled>3. ë¶„ì„ ì‹œì‘</button>
    <button onclick="stopMicrophoneAnalysis()" id="stopButton" disabled>4. ë¶„ì„ ì •ì§€ ë° ìµœì¢… êµ¬ê°„ í‘œì‹œ</button>
    
    <p id="status-display">RPMì„ ì…ë ¥í•˜ê³  'ë§ˆì´í¬ ì—°ê²°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>

    <div id="realtime-results">
        <p class="label">ğŸ“ ë¶„ì„ ê²°ê³¼ ê¸°ë¡:</p>
    </div>
</div>

<script>
    // --- 1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
    let audioContext;
    let analyser;
    let mediaStreamSource = null;
    let mediaStream = null;
    let analysisIntervalId = null;

    let snapshotCount = 0;
    let cumulativeAmplitudeFund = 0; 
    let cumulativeAmplitudePeak = 0; 
    let analysisStartTime = 0; 
    
    const INTERVAL_SEC = 20; // 20ì´ˆ ì£¼ê¸°
    const FIRST_SEGMENT_START = 0; // 0ì´ˆë¶€í„° ì‹œì‘

    const rpmInput = document.getElementById('rpm');
    const connectButton = document.getElementById('connectButton');
    const analyzeButton = document.getElementById('analyzeButton');
    const stopButton = document.getElementById('stopButton');
    const statusDisplay = document.getElementById('status-display');
    const resultsContainer = document.getElementById('realtime-results');


    // --- 2. ë§ˆì´í¬ ì—°ê²° í•¨ìˆ˜ (ì‹ ê·œ) ---
    async function connectMicrophone() {
        try {
            connectButton.disabled = true;
            statusDisplay.innerText = 'ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œ ìš”ì²­ ì¤‘...';
            
            // AudioContext ì´ˆê¸°í™” ë° ì¬ê°œ
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ íšë“
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // AudioNode ì—°ê²°
            mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);
            mediaStreamSource.connect(analyser);
            mediaStreamSource.connect(audioContext.destination);Â 
            
            statusDisplay.innerText = `âœ… ë§ˆì´í¬ ì—°ê²° ì„±ê³µ. ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            analyzeButton.disabled = false; // ë¶„ì„ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
            
        } catch (error) {
            console.error('ë§ˆì´í¬ ì ‘ê·¼ ë˜ëŠ” ë¶„ì„ ì˜¤ë¥˜:', error);
            statusDisplay.innerText = `âŒ ì—ëŸ¬: ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨. HTTPS ë° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.`;
            connectButton.disabled = false;
        }
    }

    // --- 3. ë¶„ì„ ì‹œì‘ í•¨ìˆ˜ (í™œì„±í™”ë˜ë©´ í˜¸ì¶œë¨) ---
    function startAnalysis() {
        const rpm = parseFloat(rpmInput.value);
        if (isNaN(rpm) || rpm <= 0) {
            alert('ìœ íš¨í•œ RPM ê°’ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }

        if (!mediaStreamSource) {
            alert('ë¨¼ì € ë§ˆì´í¬ ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
            return;
        }
        
        analyzeButton.disabled = true;
        stopButton.disabled = false;
        
        // ë¶„ì„ ë³€ìˆ˜ ì´ˆê¸°í™”
        cumulativeAmplitudeFund = 0;
        cumulativeAmplitudePeak = 0;
        snapshotCount = 0;
        analysisStartTime = audioContext.currentTime;
        
        // ê²°ê³¼ ê¸°ë¡ ì˜ì—­ ì´ˆê¸°í™”
        const labelElement = resultsContainer.querySelector('.label');
        resultsContainer.innerHTML = '';
        resultsContainer.appendChild(labelElement);

        statusDisplay.innerText = `ğŸŸ¢ ë¶„ì„ ì‹œì‘ë¨. ${FIRST_SEGMENT_START}ì´ˆë¶€í„° ${INTERVAL_SEC}ì´ˆ ì£¼ê¸° ë¶„ì„`;
        
        const F_fund = (rpm / 60) * 20;
        const F_peak = F_fund * 7; 

        realtimeAnalysisLoop(F_fund, F_peak);
    }
    
    // --- 4. ë¶„ì„ ì¤‘ì§€ í•¨ìˆ˜ (ìƒëµ) ---
    function stopMicrophoneAnalysis() {
        if (analysisIntervalId) cancelAnimationFrame(analysisIntervalId);
        analysisIntervalId = null;
        
        // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼/ì†ŒìŠ¤ ì—°ê²° í•´ì œ
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            // mediaStream = null; // ì—°ê²°ì„ ìœ ì§€í•  í•„ìš” ì—†ìŒ (ì¬ë¶„ì„ì‹œ ì¬ì—°ê²°)
        }
        if (mediaStreamSource) {
            mediaStreamSource.disconnect();
            // mediaStreamSource = null;
        }

        if (audioContext) { 
            const rpm = parseFloat(rpmInput.value);
            const F_fund = (rpm / 60) * 20;
            const F_peak = F_fund * 7;
            calculateAndDisplayResult(F_fund, F_peak, audioContext.currentTime, true); // ìµœì¢… êµ¬ê°„ ê³„ì‚°
        }
        
        // AudioContextëŠ” ì—°ê²° ë²„íŠ¼ì—ì„œ ì¬ê°œí•´ì•¼ í•˜ë¯€ë¡œ ë‹«ì§€ ì•ŠìŒ
        
        analyzeButton.disabled = false;
        stopButton.disabled = true;
        connectButton.disabled = true; // ë¶„ì„ ì •ì§€ í›„ì—ëŠ” ë‹¤ì‹œ ì—°ê²° ë²„íŠ¼ì„ í™œì„±í™”í•  í•„ìš” ì—†ìŒ (ì¬ë¶„ì„ ê°€ëŠ¥)
    }

    // --- 5. ì£¼íŒŒìˆ˜ ë²”ìœ„ ì§„í­ í‰ê·  ê³„ì‚° ë¡œì§ (ìƒëµ) ---
    function getAvgAmplitudeInRange(targetFrequency, dataArray, sampleRate, fftSize) {
        const range = targetFrequency * 0.03; 
        const lowerFreq = targetFrequency - range;
        const upperFreq = targetFrequency + range;
        const binResolution = sampleRate / fftSize;
        
        let startIndex = Math.floor(lowerFreq / binResolution);
        let endIndex = Math.ceil(upperFreq / binResolution);
        
        startIndex = Math.max(0, startIndex);
        endIndex = Math.min(dataArray.length - 1, endIndex);
        
        if (startIndex >= endIndex || endIndex >= dataArray.length) { return null; }
        
        let sumAmplitude = 0;
        let count = 0;
        for (let i = startIndex; i <= endIndex; i++) { 
            sumAmplitude += dataArray[i]; 
            count++; 
        }
        return sumAmplitude / count;
    }

    // --- 6. ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼ ê³„ì‚° ë° ì—…ë°ì´íŠ¸ (NaN ë°©ì§€ ë¡œì§ í¬í•¨) ---
    function calculateAndDisplayResult(F_fund, F_peak, currentTime, isFinal = false) {
        
        const elapsedSinceStart = currentTime - analysisStartTime;
        
        let startSec;
        let endSec;

        if (isFinal) {
            // ì •ì§€ ì‹œ: ë§ˆì§€ë§‰ ë¦¬ì…‹ ì‹œì ë¶€í„° í˜„ì¬ê¹Œì§€ì˜ ì”ì—¬ êµ¬ê°„
            startSec = Math.floor(analysisStartTime); 
            if (startSec < FIRST_SEGMENT_START) startSec = FIRST_SEGMENT_START;
            endSec = Math.floor(currentTime);
        } else {
            // 20ì´ˆ ì£¼ê¸° ìë™ ë¶„ì„ ì‹œ: 
            const intervalNumber = Math.floor(elapsedSinceStart / INTERVAL_SEC);
            startSec = FIRST_SEGMENT_START + intervalNumber * INTERVAL_SEC; 
            endSec = startSec + INTERVAL_SEC;
        }

        const segmentDuration = endSec - startSec;
        
        let avgFund, avgPeak, difference, message = '';

        if (snapshotCount === 0) {
            // [NaN ë°©ì§€]: ë°ì´í„°ê°€ ì—†ì„ ë•Œ 0.00ìœ¼ë¡œ ì²˜ë¦¬
            avgFund = 0.00;
            avgPeak = 0.00;
            difference = 0.00;
            message = `[ê°ì§€ ì‹¤íŒ¨] ë°ì´í„° ë¶€ì¡±. ìœ íš¨ ì§„í­ ë¯¸ê°ì§€. (dB ê°’ 0ìœ¼ë¡œ ì²˜ë¦¬)`;

            if (isFinal && segmentDuration <= 2 && startSec > 0) { 
                statusDisplay.innerText = `ğŸ”´ ë¶„ì„ ì •ì§€ë¨. ìµœì¢… ${segmentDuration}ì´ˆ ì”ì—¬ êµ¬ê°„ì€ ì†ŒìŒ ê°ì§€ê°€ ì–´ë µê±°ë‚˜ ì§§ì•„ ê¸°ë¡ì„ ìƒëµí•©ë‹ˆë‹¤.`;
                
                // ë³€ìˆ˜ ë¦¬ì…‹
                cumulativeAmplitudeFund = 0;
                cumulativeAmplitudePeak = 0;
                snapshotCount = 0;
                analysisStartTime = currentTime;
                return;
            }
        } else {
            // ë°ì´í„°ê°€ ìˆì„ ê²½ìš° ì •ìƒ ê³„ì‚°
            avgFund = cumulativeAmplitudeFund / snapshotCount;
            avgPeak = cumulativeAmplitudePeak / snapshotCount;
            difference = parseFloat((avgPeak - avgFund).toFixed(2));
        }

        // ê²°ê³¼ HTML ìƒì„±
        const newEntry = document.createElement('div');
        newEntry.classList.add('result-entry');

        newEntry.innerHTML = `
            <p><strong>êµ¬ê°„:</strong> ${startSec}s ~ ${endSec}s ${isFinal ? '(ìµœì¢… í‰ê· )' : ''}</p>
            <p class="diff-result">ì§„í­ ì°¨ì´ (Peak - Fund) í‰ê· : <strong>${difference.toFixed(2)} dB</strong></p>
            <p><strong>ê¸°ë³¸ ì£¼íŒŒìˆ˜ (${F_fund.toFixed(2)} Hz):</strong> ${avgFund.toFixed(2)} dB</p>
            <p><strong>í”¼í¬ ì£¼íŒŒìˆ˜ (${F_peak.toFixed(2)} Hz):</strong> ${avgPeak.toFixed(2)} dB</p>
            ${snapshotCount === 0 ? `<p style="color: #ffab91; font-weight: bold;">${message}</p>` : ''}
        `;
        
        resultsContainer.insertBefore(newEntry, resultsContainer.children[1]); 
        
        // ë³€ìˆ˜ ë¦¬ì…‹
        cumulativeAmplitudeFund = 0;
        cumulativeAmplitudePeak = 0;
        snapshotCount = 0;
        analysisStartTime = currentTime;

        if (isFinal) {
             statusDisplay.innerText = "âœ… ë¶„ì„ ì¤‘ì§€ë¨. ìµœì¢… ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } else if (snapshotCount === 0) {
             statusDisplay.innerText = `ğŸŸ¡ ë¶„ì„ ì¤‘... ${startSec}s ~ ${endSec}s êµ¬ê°„ ì†ŒìŒ ë¯¸ê°ì§€. (dB 0 ì²˜ë¦¬)`;
        }
    }

    // --- 7. ì‹¤ì‹œê°„ ë¶„ì„ ë£¨í”„ ---
    function realtimeAnalysisLoop(F_fund, F_peak) {
        if (!analyser || !audioContext || audioContext.state === 'closed') return;

        const dataArray = new Float32Array(analyser.frequencyBinCount);
        analyser.getFloatFrequencyData(dataArray);Â 

        const sampleRate = audioContext.sampleRate;
        const fftSize = analyser.fftSize;

        const currentAmpFund = getAvgAmplitudeInRange(F_fund, dataArray, sampleRate, fftSize);
        const currentAmpPeak = getAvgAmplitudeInRange(F_peak, dataArray, sampleRate, fftSize);

        if (currentAmpFund !== null && currentAmpPeak !== null) {
            cumulativeAmplitudeFund += currentAmpFund;
            cumulativeAmplitudePeak += currentAmpPeak;
            snapshotCount++;
        }

        const currentTime = audioContext.currentTime;
        const elapsedSinceStart = currentTime - analysisStartTime;

        // 20ì´ˆë§ˆë‹¤ ê²°ê³¼ ê³„ì‚° ë° ë¦¬ì…‹
        if (elapsedSinceStart >= INTERVAL_SEC) {
            calculateAndDisplayResult(F_fund, F_peak, currentTime, false);
        }

        analysisIntervalId = requestAnimationFrame(() => realtimeAnalysisLoop(F_fund, F_peak));
    }
</script>
</body>
</html> 
