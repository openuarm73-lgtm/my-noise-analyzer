<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ëª¨ë°”ì¼ ì†Œë¦¬ ë¶„ì„ê¸°</title>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
    background:#0a0a14;color:#eee;
    padding:12px;
  }
  .container{
    max-width:1000px;margin:0 auto;background:#141622;
    border-radius:14px;padding:14px;box-shadow:0 0 20px rgba(0,0,0,0.4)
  }
  h1{text-align:center;font-size:1.3rem;margin-bottom:14px;color:#fff}

  /* PC = 2ì—´ / ëª¨ë°”ì¼ = 1ì—´ */
  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:14px;
  }
  @media(max-width:850px){
    .grid{grid-template-columns:1fr;}
  }

  .panel{background:#1e2030;padding:14px;border-radius:10px}

  label{display:block;margin-top:10px;font-weight:600;margin-bottom:6px;font-size:0.95rem}

  input,select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #333;
    background:#0f1018;color:#eee;font-size:1rem;
  }

  button{
    width:100%;padding:12px;margin-top:10px;border:none;
    border-radius:10px;background:#3a6df0;color:#fff;
    font-size:1.05rem;font-weight:700;cursor:pointer;
  }
  button:disabled{background:#555}

  .status{
    margin-top:12px;padding:10px;border-radius:8px;font-size:0.9rem;
  }
  .success{background:#1f402f;color:#9ff7c0;}
  .error{background:#402727;color:#ff9d9d;}
  .info{background:#3a3a18;color:#fff7a8;}

  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .kpi-item{
    background:#10111a;padding:8px;border-radius:8px;
    box-shadow:0 0 8px rgba(0,0,0,0.4);min-width:110px
  }

  canvas{
    width:100%;height:250px;border-radius:10px;background:#000;
  }

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.9rem}
  th,td{padding:6px;border-bottom:1px solid #333}

  .badge{
    padding:4px 10px;border-radius:999px;color:white;font-weight:700;
  }
  .ok{background:#2fa86d}
  .warn{background:#e49b23}
  .bad{background:#e64545}

  /* ğŸ”¥ ëª¨ë°”ì¼ì—ì„œë„ ì ˆëŒ€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” AI ë°•ìŠ¤ */
  #aiBox{
    height:120px;overflow:hidden;margin-top:12px;
    background:#11131d;border-radius:10px;padding:10px;
  }
  #aiState{
    height:34px;display:flex;align-items:center;
    overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
    margin-bottom:8px;
  }
  #aiNote{
    height:70px;display:flex;align-items:center;
    overflow:hidden;white-space:nowrap;text-overflow:ellipsis;
    font-size:0.9rem;color:#ddd;
  }

  #tooltip{
    position:absolute;background:rgba(0,0,0,0.8);color:#fff;
    padding:6px;border-radius:6px;font-size:0.85rem;display:none;
    pointer-events:none;z-index:10;
  }

</style>
</head>
<body>

<div class="container">
<h1>ğŸ“± ëª¨ë°”ì¼ ì†Œë¦¬ ë¶„ì„ê¸°</h1>

<div class="grid">

<div class="panel">

  <label>RPM</label>
  <input type="number" id="rpmInput" value="1500">

  <label>ë¸”ë ˆì´ë“œ ìˆ˜ (ê¸°ë³¸ ì£¼íŒŒìˆ˜ ë°°ìˆ˜)</label>
  <input type="number" id="bladeCountInput" value="20">

  <label>ë¶„ì„ ë°°ìˆ˜ (7Ã—/14Ã— í™•ì¥)</label>
  <select id="multipleSelect">
    <option value="7">1~7Ã— (ê¸°ë³¸)</option>
    <option value="14" selected>1~14Ã— (14ë°° íŒì • í¬í•¨)</option>
  </select>

  <label>FFT í¬ê¸°</label>
  <select id="fftSizeSelect">
    <option value="2048">2048</option>
    <option value="4096" selected>4096</option>
    <option value="8192">8192</option>
  </select>

  <label>FFT ìµœëŒ€ ì£¼íŒŒìˆ˜ (ê·¸ë˜í”„ Xì¶•)</label>
  <select id="maxFreqSelect">
    <option value="0">ì „ì²´ (ìƒ˜í”Œë§ ì£¼íŒŒìˆ˜/2)</option>
    <option value="5000">5000 Hz</option>
    <option value="10000" selected>10000 Hz</option>
    <option value="13000">13000 Hz</option>
  </select>
  <label style="margin-top:14px">ì´ë™í‰ê·  ê¸¸ì´</label>
  <input type="number" id="maLen" value="10">

  <label>ê²½ë³´ìŒ</label>
  <select id="alarmMode">
    <option value="off" selected>ë„ê¸°</option>
    <option value="beep" >ë¹„í”„ìŒ</option>
  </select>

  <label>AI dB ì„ê³„ê°’ (ì£¼ì˜/ê²°í•¨)</label>
  <div style="display:flex;gap:8px">
    <input type="number" id="warnThreshold" value="3">
    <input type="number" id="badThreshold" value="8">
  </div>

  <label>RPM ë³€í™” ë¯¼ê°ë„</label>
  <select id="rpmTrendSens">
    <option value="0.01">ë¯¼ê°</option>
    <option value="0.03" selected>ë³´í†µ</option>
    <option value="0.1">ì™„ë§Œ</option>
  </select>
  
  <button id="connectBtn">ğŸ¤ ë§ˆì´í¬ ì—°ê²°</button>
  <button id="startButton" disabled>â–¶ ë¶„ì„ ì‹œì‘</button>
  <button id="stopButton" disabled>â¹ ì¤‘ì§€</button>
  
  <button id="csvApplyBtn" style="background:#555">ğŸ’¾ CSV ì €ì¥ ì ìš© (í•´ì œë¨)</button>
  <div id="status" class="status info">ëŒ€ê¸° ì¤‘â€¦</div>

  <div class="kpi">
    <div class="kpi-item"><div>ì‹œê°„</div><b id="timeCounter">0</b></div>
    <div class="kpi-item"><div>í‰ê· </div><b id="movingAvg">-</b></div>
    <div class="kpi-item"><div>RMS</div><b id="rmsVal">-</b></div>
    <div class="kpi-item"><div>Peak</div><b id="peakVal">-</b></div>
  </div>

  <div class="panel" style="margin-top:12px">
    <div><b>ê¸°ë³¸/ê²°í•¨(7Ã—) ê²°ê³¼</b></div>
    <div id="freqResult" style="margin:6px 0"></div>

    <table>
      <thead><tr><th>ë°°ìˆ˜</th><th>Hz</th><th>Amp</th><th>dB</th></tr></thead>
      <tbody id="harmonicsTable"></tbody>
    </table>

    <div id="aiBox">
      <div id="aiState"><span class="badge ok">-</span></div>
      <div id="aiNote">AI ëŒ€ê¸° ì¤‘â€¦</div>
    </div>
  </div>

</div>

<div class="panel">
  <div style="font-size:0.9rem">ì‹¤ì‹œê°„ FFT ìŠ¤í™íŠ¸ëŸ¼</div>
  <div style="position:relative;margin-top:8px">
    <canvas id="spectrumCanvas"></canvas>
    <div id="tooltip"></div>
  </div>

  <div class="kpi" style="margin-top:12px">
    <div class="kpi-item"><div>Kurtosis</div><b id="kurtVal">-</b></div>
    <div class="kpi-item"><div>Crest</div><b id="crestVal">-</b></div>
    <div class="kpi-item"><div>Bin</div><b id="freqPerBin">-</b></div>
    <div class="kpi-item"><div>7x ìˆœìœ„ í‰ê· </div><b id="sevenXRankAvg">-</b></div>
  </div>

</div>

</div>
</div>

<script>
/* =========================================================
   ë§ˆì´í¬, FFT, íŒì • ë¡œì§
   ========================================================= */

let audioContext, analyser, source;
let freqData, timeData;
let isRun=false;
let raf;

let prevDefect=null, prevH14=null, prevRms=null, prevRpm=null;

let csvData = []; 
let isRecording = false; 
// ğŸ”¥ CSV ì €ì¥ í™œì„±í™” í”Œë˜ê·¸ (ê¸°ë³¸ê°’: í•´ì œ)
let isCsvEnabled = false; 

// ğŸ”¥ 7Ã— ê³ ì¡°íŒŒ ìˆœìœ„ ê¸°ë¡ì„ ìœ„í•œ ë°°ì—´ ì¶”ê°€
let rankHist = [];
let finalRankAvg = '-'; // ì¤‘ì§€ í›„ì—ë„ ê°’ì„ ìœ ì§€í•  ë³€ìˆ˜

/* UI GET */
const rpmIn = _id('rpmInput');
const bladeIn = _id('bladeCountInput');
const multIn = _id('multipleSelect');
const fftIn = _id('fftSizeSelect');
// ğŸ”¥ ì¶”ê°€: ìµœëŒ€ ì£¼íŒŒìˆ˜ ì„ íƒ ì¸í’‹
const maxFreqIn = _id('maxFreqSelect'); 

const btnMic = _id('connectBtn');
const btnStart = _id('startButton');
const btnStop = _id('stopButton');
// ğŸ”¥ CSV ì ìš© ë²„íŠ¼
const csvApplyBtn = _id('csvApplyBtn'); 

const statusBox = _id('status');

const maLenIn = _id('maLen');
const warnIn = _id('warnThreshold');
const badIn = _id('badThreshold');
const rpmSensIn = _id('rpmTrendSens');
const alarmIn = _id('alarmMode');

const timeBox = _id('timeCounter');
const avgBox = _id('movingAvg');
const rmsBox = _id('rmsVal');
const peakBox = _id('peakVal');
const kurtBox = _id('kurtVal');
// ID ì°¸ì¡° ì˜¤ë¥˜ ìˆ˜ì •: 'crestBox' -> 'crestVal'
const crestBox = _id('crestVal'); 

const freqRes = _id('freqResult');
const harmTable = _id('harmonicsTable');

const aiState = _id('aiState');
const aiNote  = _id('aiNote');

const canvas = _id('spectrumCanvas');
const ctx = canvas.getContext('2d');
const tooltip = _id('tooltip');

// ğŸ”¥ 7x ìˆœìœ„ í‰ê·  í‘œì‹œ ë°•ìŠ¤
const rankAvgBox = _id('sevenXRankAvg');

let dbHist=[];

function _id(x){return document.getElementById(x);}

/* ğŸ”¥ ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ì•ˆì •ì„± ê°•í™”) */
function setCanvasSize() {
  const containerWidth = canvas.parentNode.clientWidth;
  canvas.width = containerWidth;
  canvas.height = 250;
}
setCanvasSize();


/* ---------- CSV ì €ì¥ ì‹œì‘ ë¡œì§ ---------- */
function startRecording(){
    // ğŸ”¥ isCsvEnabledê°€ trueì¼ ë•Œë§Œ ì €ì¥ ì‹œì‘
    if(!isCsvEnabled) return; 
    
    csvData = []; // ë°ì´í„° ì´ˆê¸°í™”
    isRecording = true;
    
    // CSV í—¤ë” ì¶”ê°€
    const header = ['Time(s)', 'RPM', 'BladeCount', 'BaseHz', 'DefectHz', 'BaseDb', 'DefectDb', 'DiffDb', 'MovingAvg', 'RMS_Db', 'Peak_Db', 'Kurtosis', 'CrestFactor', 'AI_State', 'AI_Note'];
    csvData.push(header);
}

/* ---------- CSV ì €ì¥ ì¤‘ì§€ ë° ë‹¤ìš´ë¡œë“œ ë¡œì§ ---------- */
function stopRecording(){
    // ğŸ”¥ isCsvEnabledê°€ trueê°€ ì•„ë‹ˆê±°ë‚˜ ê¸°ë¡ ì¤‘ì´ ì•„ë‹ˆë¼ë©´ ì¤‘ë‹¨
    if(!isCsvEnabled || !isRecording) {
        statusBox.innerText="ì¤‘ì§€ë¨.";
        return;
    }

    isRecording = false;

    if(csvData.length <= 1){
        statusBox.innerText="ì¤‘ì§€ë¨. ì €ì¥í•  ë°ì´í„°ê°€ ì—†ì–´ CSV ë‹¤ìš´ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.";
        return;
    }

    // CSV ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
    const csvContent = csvData.map(e => e.join(",")).join("\n");
    // UTF-8 BOM ì¶”ê°€í•˜ì—¬ í•œê¸€ ê¹¨ì§ ë°©ì§€
    const blob = new Blob(["\ufeff", csvContent], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sound_analysis_${new Date().toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    csvData = []; // ë‹¤ìš´ë¡œë“œ í›„ ë°ì´í„° ì´ˆê¸°í™”
    statusBox.innerText="ì¤‘ì§€ë¨. CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ";
}

/* ---------- ë§ˆì´í¬ ì—°ê²° ---------- */
btnMic.onclick = async ()=>{
  try{
    let stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext = new (window.AudioContext||window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    // FFT í¬ê¸° ì„¤ì •ì€ ì—°ê²°í•  ë•Œ í•œ ë²ˆë§Œ
    analyser.fftSize = Number(fftIn.value); 
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);

    source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);

    btnMic.disabled=true; btnMic.innerText="ğŸ¤ ì—°ê²°ë¨";
    btnStart.disabled=false;
    statusBox.className="status success";
    statusBox.innerText="ë§ˆì´í¬ ì—°ê²° ì™„ë£Œ";
  }catch(e){
    statusBox.className="status error";
    statusBox.innerText="ë§ˆì´í¬ ì—°ê²° ì‹¤íŒ¨: "+e;
  }
};

/* ---------- ë¶„ì„ ì‹œì‘ (CSV ìë™ ì‹œì‘) ---------- */
btnStart.onclick = ()=>{
  if(!audioContext) return;
  
  // ğŸ”¥ FFT í¬ê¸°ê°€ ë³€ê²½ë  ê²½ìš° analyserì— ì¬ì ìš©
  if (analyser.fftSize !== Number(fftIn.value)) {
    analyser.fftSize = Number(fftIn.value);
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);
    console.log("FFT Size updated to:", analyser.fftSize);
  }

  isRun=true;
  btnStart.disabled=true;
  btnStop.disabled=false;
  
  // ğŸ”¥ ë¶„ì„ ì‹œì‘ ì‹œ ìˆœìœ„ ê¸°ë¡ ì´ˆê¸°í™”
  rankHist = [];
  finalRankAvg = '-';
  rankAvgBox.innerText = finalRankAvg;
  
  // CSV ì €ì¥ ìë™ ì‹œì‘ (isCsvEnabled ìƒíƒœì— ë”°ë¼ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬)
  startRecording(); 
  
  if(isCsvEnabled){
      statusBox.className="status info";
      statusBox.innerText="ë¶„ì„ ë° CSV ì €ì¥ ì¤‘â€¦";
  } else {
      statusBox.className="status info";
      statusBox.innerText="ë¶„ì„ ì¤‘â€¦ (CSV ì €ì¥ í•´ì œë¨)";
  }
  
  t0=performance.now();
  loop();
};

/* ---------- ì¤‘ì§€ (CSV ìë™ ì¤‘ì§€) ---------- */
btnStop.onclick = ()=>{
  isRun=false; 
  btnStart.disabled=false; 
  btnStop.disabled=true;
  
  // CSV ì €ì¥ ìë™ ì¤‘ì§€ ë° ë‹¤ìš´ë¡œë“œ
  stopRecording(); 
  
  // ğŸ”¥ ìµœì¢… í‰ê·  ìˆœìœ„ ê³„ì‚° ë° í‘œì‹œ (ë¶„ì„ ì¤‘ì§€ í›„ì—ë„ ìœ ì§€)
  if (rankHist.length > 0) {
      const sum = rankHist.reduce((a, b) => a + b, 0);
      finalRankAvg = (sum / rankHist.length).toFixed(2);
      rankAvgBox.innerText = finalRankAvg;
  }
};


/* ---------- CSV ì ìš© ë²„íŠ¼ í† ê¸€ ë¡œì§ ---------- */
csvApplyBtn.onclick = () => {
    // ë¶„ì„ ì¤‘ì—ëŠ” ìƒíƒœë¥¼ ë³€ê²½í•˜ì§€ ëª»í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    if(isRun) {
        statusBox.className = 'status warn';
        statusBox.innerText = 'ë¶„ì„ ì¤‘ì—ëŠ” CSV ì„¤ì •ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    isCsvEnabled = !isCsvEnabled; // ìƒíƒœ ë°˜ì „

    if (isCsvEnabled) {
        // í™œì„±í™”: íŒŒë€ìƒ‰
        csvApplyBtn.style.background = '#3a6df0';
        csvApplyBtn.innerText = 'ğŸ’¾ CSV ì €ì¥ ì ìš© (í™œì„±í™”ë¨)';
        statusBox.className = 'status success';
        statusBox.innerText = 'CSV ì €ì¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. "ë¶„ì„ ì‹œì‘" ì‹œ ê¸°ë¡ë©ë‹ˆë‹¤.';
    } else {
        // ë¹„í™œì„±í™”: íšŒìƒ‰
        csvApplyBtn.style.background = '#555';
        csvApplyBtn.innerText = 'ğŸ’¾ CSV ì €ì¥ ì ìš© (í•´ì œë¨)';
        statusBox.className = 'status info';
        statusBox.innerText = 'CSV ì €ì¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
};

/* ---------- ë¶„ì„ ë£¨í”„ ---------- */
let t0=0;
function loop(){
  if(!isRun) return; 

  // FFT í¬ê¸°ê°€ ë³€ê²½ë  ê²½ìš° analyserì— ì¬ì ìš© (ì‹¤ì‹œê°„ ë°˜ì˜)
  if (analyser && analyser.fftSize !== Number(fftIn.value)) {
    // FFT í¬ê¸° ë³€ê²½ ì‹œ ë°ì´í„° ë°°ì—´ë„ ë‹¤ì‹œ ìƒì„±í•´ì•¼ í•¨
    analyser.fftSize = Number(fftIn.value);
    freqData = new Uint8Array(analyser.frequencyBinCount);
    timeData = new Uint8Array(analyser.fftSize);
    _id('freqPerBin').innerText = (audioContext.sampleRate / analyser.fftSize).toFixed(2);
  }
  
  analyser.getByteFrequencyData(freqData);
  analyser.getByteTimeDomainData(timeData);

  let sr = audioContext.sampleRate;
  let fftN = analyser.fftSize;
  let bin = sr/fftN;

  let rpm = Number(rpmIn.value);
  let blade = Number(bladeIn.value);
  let maxMul = Number(multIn.value);

  let base = (rpm/60)*blade;
  let defect = base*7;

  let baseI = Math.round(base/bin);
  let defectI = Math.round(defect/bin);

  let baseAmp = freqData[clamp(baseI)];
  let defAmp  = freqData[clamp(defectI)];

  let baseDb = ampToDb(baseAmp);
  let defDb  = ampToDb(defAmp);

  let diff = Math.abs(defDb-baseDb);

  /* ì´ë™í‰ê·  */
  let ma = Number(maLenIn.value);
  dbHist.push(diff);
  if(dbHist.length>ma) dbHist.shift();
  let avg = dbHist.reduce((a,b)=>a+b,0)/(dbHist.length||1);

  /* RMS, Peak */
  let tArr = floatNorm(timeData);
  let rms = rmsCalc(tArr);
  let rmsDb = 20*Math.log10(rms||1e-8);
  let peak = tArr.reduce((a,b)=>Math.max(a,Math.abs(b)),0);
  let peakDb = 20*Math.log10(peak||1e-8);

  let kurt = kurtCalc(tArr);
  let crest = crestCalc(tArr);

  /* ê³ ì¡°íŒŒ */
  let hList=[];
  // maxMulì´ 7ì´ë“  14ë“ , ìµœëŒ€ 14ë°°ìˆ˜ê¹Œì§€ëŠ” ê³„ì‚°í•´ì•¼ ìˆœìœ„ê°€ ì •í™•í•´ì§
  const maxHarmonicsForRank = 14; 
  for(let k=1;k<=Math.max(maxMul, maxHarmonicsForRank);k++){
    let f = base*k;
    let idx=Math.round(f/bin);
    let a=freqData[clamp(idx)];
    // í‘œì‹œë¥¼ ìœ„í•´ hListì—ëŠ” maxMulê¹Œì§€ë§Œ ë‹´ê³ , ìˆœìœ„ ê³„ì‚°ì„ ìœ„í•´ ë³„ë„ë¡œ ì‚¬ìš©
    hList.push({k,f,a,db:ampToDb(a)});
  }
  // í‘œì‹œìš© hListëŠ” maxMulê¹Œì§€ë§Œ ìœ ì§€
  hList = hList.filter(h => h.k <= maxMul); 

  let h14 = hList.find(h=>h.k===14); // hListê°€ 14ê°œì¼ ê²½ìš° h14ê°€ ì •ì˜ë¨

  /* ğŸ”¥ 7Ã— ê³ ì¡°íŒŒ ìˆœìœ„ ê³„ì‚° */
  // ì „ì²´ ê³ ì¡°íŒŒ(ìµœëŒ€ 14ê°œ)ì˜ ì§„í­(Amp)ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ì—¬ ìˆœìœ„ë¥¼ ë§¤ê¹ë‹ˆë‹¤.
  const allHarmonics = [];
  for(let k=1;k<=maxHarmonicsForRank;k++){
    let f = base*k;
    let idx=Math.round(f/bin);
    let a=freqData[clamp(idx)];
    allHarmonics.push({k,f,a});
  }
  
  // ì§„í­ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  allHarmonics.sort((a, b) => b.a - a.a); 
  
  // 7Ã— ê³ ì¡°íŒŒì˜ í˜„ì¬ ìˆœìœ„ ì°¾ê¸° (1ìœ„ë¶€í„° ì‹œì‘)
  let rank7x = allHarmonics.findIndex(h => h.k === 7) + 1;
  rankHist.push(rank7x); // ìˆœìœ„ ê¸°ë¡
  
  // í˜„ì¬ í‰ê·  ìˆœìœ„ ê³„ì‚°
  const rankSum = rankHist.reduce((a, b) => a + b, 0);
  const rankAvg = (rankSum / rankHist.length).toFixed(2);
  rankAvgBox.innerText = rankAvg;
  
  
  /* AI íŒì • */
  let aiL="ì •ìƒ", aiC="ok", msg="";

  let warnT=Number(warnIn.value);
  let badT=Number(badIn.value);

  if(diff>badT){ aiL="ê²°í•¨ ì˜ì‹¬"; aiC="bad"; msg=`dBì°¨ì´ ${diff.toFixed(2)}`; }
  else if(diff>warnT){ aiL="ì£¼ì˜"; aiC="warn"; msg=`dBì°¨ì´ ${diff.toFixed(2)}`; }

  /* 14Ã— ìë™ íŒì • */
  if(h14){
    let defAmp7x = hList.find(h => h.k === 7)?.a || 0; // 7x ì§„í­ ì¬ì°¸ì¡°
    let ratio14 = defAmp7x > 0 ? h14.a / defAmp7x : 0;

    if(prevDefect && defAmp7x < prevDefect-4 && ratio14<2){
      aiL="ì •ìƒ(ì••ë ¥ê°ì†ŒíŒ¨í„´)";
      aiC="ok";
      msg="7Ã— ê°ì†Œ & 14/7 ë‚®ìŒ";
    }
    if(prevH14 && (h14.db-prevH14)>6){
      aiL="ê²°í•¨(14Ã— ê¸‰ì¦)";
      aiC="bad";
      msg=`14Ã— +${(h14.db-prevH14).toFixed(2)} dB`;
    }
    if(ratio14>3){
      aiL="ë¹„ì •ìƒ(14Ã— ê³¼ë‹¤)";
      aiC="bad";
      msg=`14/7=${ratio14.toFixed(2)}`;
    }
  }

  /* RPM íŠ¸ë Œë“œ */
  if(prevRpm){
    let sens=Number(rpmSensIn.value);
    let rchg=(rpm-prevRpm)/(prevRpm||1);
    if(Math.abs(rchg)>sens){
      if(rchg>0 && rmsDb>prevRms+0.5){
        msg="RPMâ†‘ â†’ RMSâ†‘ (ì •ìƒ)";
      }
      if(rchg<0 && rmsDb<prevRms-0.5){
        msg="RPMâ†“ â†’ RMSâ†“ (ì •ìƒ)";
      }
    }
  }

  /* AI í‘œì‹œ */
  aiState.innerHTML=`<span class="badge ${aiC}">${aiL}</span>`;
  aiNote.innerText=msg||"";

  /* UI */
  timeBox.innerText = Math.floor((performance.now()-t0)/1000)+"s";
  avgBox.innerText = avg.toFixed(2);
  rmsBox.innerText = rmsDb.toFixed(2)+" dB";
  peakBox.innerText = peakDb.toFixed(2)+" dB";
  kurtBox.innerText = kurt.toFixed(2);
  crestBox.innerText = crest.toFixed(2);
  _id('freqPerBin').innerText = bin.toFixed(2);

  freqRes.innerHTML =
    `ê¸°ë³¸: ${Math.round(base)}Hz / ${baseDb.toFixed(2)}dB<br>`+
    `ê²°í•¨(7Ã—): ${Math.round(defect)}Hz / ${defDb.toFixed(2)}dB<br>`+
    `ì°¨ì´: ${diff.toFixed(2)}dB`;

  harmTable.innerHTML="";
  hList.forEach(h=>{
    harmTable.innerHTML+=`<tr><td>${h.k}Ã—</td><td>${Math.round(h.f)}</td><td>${h.a}</td><td>${h.db.toFixed(2)}</td></tr>`;
  });

  /* ğŸ”¥ CSV ë°ì´í„° ê¸°ë¡ */
  if(isRecording){
      const timeElapsed = (performance.now()-t0)/1000;
      const row = [
          timeElapsed.toFixed(2), 
          rpm, blade, 
          base.toFixed(2), defect.toFixed(2), 
          baseDb.toFixed(2), defDb.toFixed(2), 
          diff.toFixed(2), avg.toFixed(2), 
          rmsDb.toFixed(2), peakDb.toFixed(2), 
          kurt.toFixed(2), crest.toFixed(2),
          aiL, msg
      ];
      csvData.push(row);
  }

  /* ìŠ¤í™íŠ¸ëŸ¼ ê·¸ë¦¬ê¸° */
  draw(freqData);

  /* prev ì—…ë°ì´íŠ¸ */
  prevDefect = defAmp;
  prevH14 = h14 ? h14.db : null;
  prevRms = rmsDb;
  prevRpm = rpm;

  raf=requestAnimationFrame(loop);
}

/* ---------- FFT ê·¸ë¦¬ê¸° (ì£¼íŒŒìˆ˜ ì„  í¬í•¨) ---------- */
function draw(arr){
  setCanvasSize(); 
  
  let w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);
  
  // ğŸ”¥ ìµœëŒ€ ì£¼íŒŒìˆ˜ ë²”ìœ„ ê³„ì‚°
  let sr = audioContext ? audioContext.sampleRate : 44100; // ì•ˆì „ê°’
  let fftN = analyser ? analyser.fftSize : 4096; // ì•ˆì „ê°’
  let nyquist = sr/2; // ë‚˜ì´í€´ìŠ¤íŠ¸ ì£¼íŒŒìˆ˜ (ìµœëŒ€ ì£¼íŒŒìˆ˜)
  let maxFreqInput = Number(maxFreqIn.value);
  
  // ê·¸ë˜í”„ë¥¼ ê·¸ë¦´ ìµœëŒ€ ì£¼íŒŒìˆ˜ (Hz)
  let graphMaxFreq = (maxFreqInput > 0 && maxFreqInput < nyquist) ? maxFreqInput : nyquist;
  
  // ê·¸ë˜í”„ì— ê·¸ë¦´ ë°ì´í„° ë°°ì—´ì˜ ì¸ë±ìŠ¤ ë (idx)
  let bin = sr/fftN;
  let endIndex = Math.min(arr.length, Math.round(graphMaxFreq / bin));

  // 1. FFT ìŠ¤í™íŠ¸ëŸ¼ ì„  ê·¸ë¦¬ê¸°
  ctx.beginPath();
  for(let i=0;i<endIndex;i++){ // endIndexê¹Œì§€ë§Œ ê·¸ë¦½ë‹ˆë‹¤.
    let x=(i/endIndex)*w; // ì „ì²´ ìº”ë²„ìŠ¤ ë„ˆë¹„ì— ë§ê²Œ ë¹„ìœ¨ ì¡°ì •
    let y=h - (arr[i]/255)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle="#00e0ff";
  ctx.lineWidth=1.5;
  ctx.stroke();

  // 2. ê¸°ë³¸ ì£¼íŒŒìˆ˜ ì„ (1x ~ maxMul x) ê·¸ë¦¬ê¸°
  if(audioContext && analyser){
    let rpm = Number(rpmIn.value);
    let blade = Number(bladeIn.value);
    let base = (rpm/60)*blade;
    let maxMul = Number(multIn.value); 
    
    // ğŸ”¥ ìµœëŒ€ 14ë°°ìˆ˜ê¹Œì§€ë§Œ ì„ ì„ ê·¸ë¦½ë‹ˆë‹¤.
    const maxDrawMul = 14; 
    const effectiveMaxMul = Math.min(maxMul, maxDrawMul);

    for(let k=1; k <= effectiveMaxMul; k++){
        let f = base * k;
        
        // ì£¼íŒŒìˆ˜ê°€ ê·¸ë˜í”„ ìµœëŒ€ ì£¼íŒŒìˆ˜ ë²”ìœ„ ë‚´ì— ìˆì„ ë•Œë§Œ ê·¸ë¦½ë‹ˆë‹¤.
        if(f > graphMaxFreq) continue; 
        
        let idx = Math.round(f / bin); 
        let x = (idx / endIndex) * w; // í™•ëŒ€ëœ Xì¶• ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì •
        
        if(x > 0 && x < w){
            
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, h);
            
            // ğŸ”¥ 1x, 7x, 14xëŠ” ë¹„êµì  ì§„í•˜ê²Œ í‘œì‹œ, ë‚˜ë¨¸ì§€ëŠ” í¬ë¯¸í•˜ê²Œ
            if(k === 1 || k === 7 || k === 14){
                // ì£¼ìš” ê³ ì¡°íŒŒ: ë¹„êµì  ì§„í•˜ê²Œ
                ctx.strokeStyle = "rgba(255, 68, 68, 0.7)"; 
                ctx.lineWidth = 2;
            } else {
                // ì¼ë°˜ ê³ ì¡°íŒŒ: í¬ë¯¸í•˜ê²Œ
                ctx.strokeStyle = "rgba(255, 0, 0, 0.3)";
                ctx.lineWidth = 1;
            }

            ctx.stroke();
        }
    }
  }
}

/* ---------- Tooltip ---------- */
canvas.addEventListener('mousemove',e=>{
  if(!audioContext || !analyser) return;

  let r=canvas.getBoundingClientRect();
  let x=e.clientX-r.left;
  let w=r.width;
  
  let sr = audioContext.sampleRate;
  let fftN = analyser.fftSize;
  let bin = sr/fftN;
  let nyquist = sr/2;
  let maxFreqInput = Number(maxFreqIn.value);
  let graphMaxFreq = (maxFreqInput > 0 && maxFreqInput < nyquist) ? maxFreqInput : nyquist;
  let endIndex = Math.min(freqData.length, Math.round(graphMaxFreq / bin));

  // ìº”ë²„ìŠ¤ X ìœ„ì¹˜ë¥¼ ì „ì²´ ë°ì´í„° ì¸ë±ìŠ¤ë¡œ ì—­ì‚°
  let idx = Math.floor((x/w) * endIndex);
  idx = clamp(idx); // ì¸ë±ìŠ¤ í´ë¨í”„

  let f=idx*bin; // ì¸ë±ìŠ¤ë¥¼ ì£¼íŒŒìˆ˜ë¡œ ë³€í™˜
  let a=freqData[idx];

  tooltip.style.left=x+"px";
  tooltip.style.top="10px";
  tooltip.style.display="block";
  tooltip.textContent=`${Math.round(f)}Hz / ${a}`;
});
canvas.addEventListener('mouseleave',()=>tooltip.style.display="none");

/* ---------- ìœ í‹¸ ---------- */
function clamp(v){return Math.max(0,Math.min(freqData.length-1,v));}
function ampToDb(a){return 20*Math.log10((a||1)/255);}
function floatNorm(u8){return Array.from(u8,x=>(x-128)/128);}
function rmsCalc(arr){return Math.sqrt(arr.reduce((s,x)=>s+x*x,0)/(arr.length||1));}
function kurtCalc(arr){
  let m=arr.reduce((s,x)=>s+x,0)/arr.length;
  let m2=0,m4=0;arr.forEach(x=>{let d=x-m;m2+=d*d;m4+=d*d*d*d;});
  m2/=arr.length; m4/=arr.length; return m4/(m2*m2+1e-12);
}
function crestCalc(arr){
  let p=Math.max(...arr.map(x=>Math.abs(x)));
  let r=rmsCalc(arr);
  return p/(r||1e-8);
}
</script>

</body>
</html>
